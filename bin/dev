#!/usr/bin/env bash
set -e

# Development server script
# Creates local config if it doesn't exist and starts the server with hot-reload

CONFIG_FILE="config.local.yaml"
DATA_DIR="./data"
BUILD_DIR="./tmp"
BINARY="$BUILD_DIR/media-finder-dev"

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Create data directory if it doesn't exist
mkdir -p "$DATA_DIR"
mkdir -p "$BUILD_DIR"

# Create local config if it doesn't exist
if [ ! -f "$CONFIG_FILE" ]; then
  echo "Creating local development config..."
  cat > "$CONFIG_FILE" << 'EOF'
database_path: ./data/media-finder.db
scan_workers: 2
cors_allowed_origin: "*"

# Minimal config for local development
local_path_mappings: []
service_path_mappings: {}
services: {}
scan_paths: []
EOF
  echo "✓ Created $CONFIG_FILE"
fi

# Function to build Tailwind CSS
build_tailwind() {
  echo -e "${CYAN}Building Tailwind CSS...${NC}"
  if npx tailwindcss -i ./web/static/css/input.css -o ./web/static/css/styles.css --minify 2>&1; then
    echo -e "${GREEN}✓ Tailwind build successful${NC}"
    return 0
  else
    echo -e "${YELLOW}✗ Tailwind build failed${NC}"
    return 1
  fi
}

# Function to build the binary
build() {
  echo -e "${CYAN}Building Go binary...${NC}"
  if CGO_ENABLED=1 go build -tags fts5 -o "$BINARY" ./cmd/media-finder 2>&1; then
    echo -e "${GREEN}✓ Build successful${NC}"
    return 0
  else
    echo -e "${YELLOW}✗ Build failed${NC}"
    return 1
  fi
}

# Function to get checksum of Go source files and templates
get_go_checksum() {
  # Watch .go files and template files (templates are embedded in Go binary)
  find cmd internal web/templates -type f \( -name "*.go" -o -name "*.html" \) -exec stat -f "%m %N" {} \; 2>/dev/null | sort | md5
}

# Function to get checksum of Tailwind-related files
get_tailwind_checksum() {
  # Watch template files, JS files, and input CSS
  find web/templates web/static/js web/static/css/input.css -type f \( -name "*.html" -o -name "*.js" -o -name "*.css" \) -exec stat -f "%m %N" {} \; 2>/dev/null | sort | md5
}

# Cleanup function
cleanup() {
  echo ""
  echo "Shutting down..."
  if [ ! -z "$SERVER_PID" ]; then
    kill $SERVER_PID 2>/dev/null || true
  fi
  exit 0
}

trap cleanup INT TERM

# Function to kill existing instances
kill_existing_instances() {
  echo -e "${CYAN}Checking for existing instances...${NC}"

  # Find processes by binary name
  EXISTING_PIDS=$(pgrep -f "media-finder-dev serve" || true)

  if [ ! -z "$EXISTING_PIDS" ]; then
    echo -e "${YELLOW}Found existing instance(s), shutting down...${NC}"
    echo "$EXISTING_PIDS" | while read pid; do
      echo "  Killing PID $pid"
      kill $pid 2>/dev/null || true
    done

    # Wait a moment for graceful shutdown
    sleep 1

    # Force kill if still running
    STILL_RUNNING=$(pgrep -f "media-finder-dev serve" || true)
    if [ ! -z "$STILL_RUNNING" ]; then
      echo -e "${YELLOW}Force killing remaining processes...${NC}"
      echo "$STILL_RUNNING" | while read pid; do
        kill -9 $pid 2>/dev/null || true
      done
    fi

    echo -e "${GREEN}✓ Existing instances stopped${NC}"
  else
    echo -e "${GREEN}✓ No existing instances found${NC}"
  fi

  # Also check if port 8787 is in use
  PORT_PID=$(lsof -ti:8787 || true)
  if [ ! -z "$PORT_PID" ]; then
    echo -e "${YELLOW}Port 8787 is in use by PID $PORT_PID, killing...${NC}"
    kill $PORT_PID 2>/dev/null || kill -9 $PORT_PID 2>/dev/null || true
    sleep 1
  fi

  echo ""
}

# Kill any existing instances before starting
kill_existing_instances

echo -e "${GREEN}Starting development server on http://localhost:8787${NC}"
echo -e "${CYAN}✓ Hot-reload enabled (polling mode)${NC}"
echo "Press Ctrl+C to stop"
echo ""

# Initial Tailwind build
if ! build_tailwind; then
  echo "Fix Tailwind errors and try again"
  exit 1
fi

# Initial Go build
if ! build; then
  echo "Fix build errors and try again"
  exit 1
fi

# Start server in background
"$BINARY" serve -c "$CONFIG_FILE" &
SERVER_PID=$!
echo -e "${GREEN}✓ Server started (PID: $SERVER_PID)${NC}"

# Store initial checksums
LAST_GO_CHECKSUM=$(get_go_checksum)
LAST_TAILWIND_CHECKSUM=$(get_tailwind_checksum)

# Watch for changes
while true; do
  sleep 1

  CURRENT_GO_CHECKSUM=$(get_go_checksum)
  CURRENT_TAILWIND_CHECKSUM=$(get_tailwind_checksum)

  GO_CHANGED=false
  TAILWIND_CHANGED=false

  # Check for Tailwind changes
  if [ "$CURRENT_TAILWIND_CHECKSUM" != "$LAST_TAILWIND_CHECKSUM" ]; then
    echo ""
    echo -e "${CYAN}Tailwind source changes detected, rebuilding CSS...${NC}"
    build_tailwind
    LAST_TAILWIND_CHECKSUM=$(get_tailwind_checksum)
    TAILWIND_CHANGED=true
  fi

  # Check for Go changes
  if [ "$CURRENT_GO_CHECKSUM" != "$LAST_GO_CHECKSUM" ]; then
    echo ""
    echo -e "${CYAN}Go source changes detected, rebuilding...${NC}"

    # Kill old server
    kill $SERVER_PID 2>/dev/null || true
    wait $SERVER_PID 2>/dev/null || true

    # Rebuild
    if build; then
      # Start new server
      "$BINARY" serve -c "$CONFIG_FILE" &
      SERVER_PID=$!
      echo -e "${GREEN}✓ Server restarted (PID: $SERVER_PID)${NC}"
    else
      echo -e "${YELLOW}Server stopped due to build error. Fix errors to restart.${NC}"
      # Keep watching for fixes
    fi

    LAST_GO_CHECKSUM=$(get_go_checksum)
    GO_CHANGED=true
  fi
done
