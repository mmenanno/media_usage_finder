#!/usr/bin/env bash
set -e

# Development server script
# Creates local config if it doesn't exist and starts the server with hot-reload

CONFIG_FILE="config.local.yaml"
DATA_DIR="./data"
BUILD_DIR="./tmp"
BINARY="$BUILD_DIR/media-finder-dev"

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Create data directory if it doesn't exist
mkdir -p "$DATA_DIR"
mkdir -p "$BUILD_DIR"

# Create local config if it doesn't exist
if [ ! -f "$CONFIG_FILE" ]; then
  echo "Creating local development config..."
  cat > "$CONFIG_FILE" << 'EOF'
database_path: ./data/media-finder.db
scan_workers: 2
cors_allowed_origin: "*"

# Minimal config for local development
local_path_mappings: []
service_path_mappings: {}
services: {}
scan_paths: []
EOF
  echo "✓ Created $CONFIG_FILE"
fi

# Function to build the binary
build() {
  echo -e "${CYAN}Building...${NC}"
  if CGO_ENABLED=1 go build -tags fts5 -o "$BINARY" ./cmd/media-finder 2>&1; then
    echo -e "${GREEN}✓ Build successful${NC}"
    return 0
  else
    echo -e "${YELLOW}✗ Build failed${NC}"
    return 1
  fi
}

# Function to get checksum of watched files
get_checksum() {
  # Watch .go, .html, .js, .css files
  find cmd internal web -type f \( -name "*.go" -o -name "*.html" -o -name "*.js" -o -name "*.css" \) -exec stat -f "%m %N" {} \; 2>/dev/null | sort | md5
}

# Cleanup function
cleanup() {
  echo ""
  echo "Shutting down..."
  if [ ! -z "$SERVER_PID" ]; then
    kill $SERVER_PID 2>/dev/null || true
  fi
  exit 0
}

trap cleanup INT TERM

echo -e "${GREEN}Starting development server on http://localhost:8787${NC}"
echo -e "${CYAN}✓ Hot-reload enabled (polling mode)${NC}"
echo "Press Ctrl+C to stop"
echo ""

# Initial build
if ! build; then
  echo "Fix build errors and try again"
  exit 1
fi

# Start server in background
"$BINARY" serve -c "$CONFIG_FILE" &
SERVER_PID=$!
echo -e "${GREEN}✓ Server started (PID: $SERVER_PID)${NC}"

# Store initial checksum
LAST_CHECKSUM=$(get_checksum)

# Watch for changes
while true; do
  sleep 1

  CURRENT_CHECKSUM=$(get_checksum)

  if [ "$CURRENT_CHECKSUM" != "$LAST_CHECKSUM" ]; then
    echo ""
    echo -e "${CYAN}Changes detected, rebuilding...${NC}"

    # Kill old server
    kill $SERVER_PID 2>/dev/null || true
    wait $SERVER_PID 2>/dev/null || true

    # Rebuild
    if build; then
      # Start new server
      "$BINARY" serve -c "$CONFIG_FILE" &
      SERVER_PID=$!
      echo -e "${GREEN}✓ Server restarted (PID: $SERVER_PID)${NC}"
    else
      echo -e "${YELLOW}Server stopped due to build error. Fix errors to restart.${NC}"
      # Keep watching for fixes
    fi

    LAST_CHECKSUM=$(get_checksum)
  fi
done
