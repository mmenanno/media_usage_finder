{{template "layout.html" .}}

{{define "content"}}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h2 class="text-3xl font-bold">Files</h2>
        <div class="text-gray-400">
            Total: {{.Total}} files
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="bg-gray-800 rounded-lg p-6">
        <form hx-get="/files" hx-target="#files-table" hx-select="#files-table" hx-push-url="true" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Search -->
                <div>
                    <label for="search-input" class="block text-sm font-medium text-gray-400 mb-2">Search Files</label>
                    <div class="relative">
                        <input
                            type="text"
                            name="search"
                            id="search-input"
                            value="{{.Search}}"
                            placeholder="Search by path..."
                            hx-get="/files"
                            hx-trigger="keyup changed delay:500ms, search"
                            hx-target="#files-table"
                            hx-include="[name='service'], [name='orphaned'], [name='limit']"
                            class="w-full px-4 py-2 pr-10 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500">
                        <div id="search-spinner" class="absolute right-3 top-1/2 transform -translate-y-1/2 hidden">
                            <svg class="animate-spin h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                    </div>
                    {{if .Search}}
                    <p class="text-xs text-gray-500 mt-1">
                        Showing results for "{{.Search}}"
                        <a href="/files" class="text-blue-400 hover:text-blue-300 ml-2">Clear</a>
                    </p>
                    {{end}}
                </div>

                <!-- Service Filter -->
                <div>
                    <span class="block text-sm font-medium text-gray-400 mb-2">Services</span>
                    <div class="relative z-30" data-service-multiselect>
                        <input type="hidden" name="services" value="{{range $i, $svc := .Services}}{{if $i}},{{end}}{{$svc}}{{end}}" data-services-input>
                        <input type="hidden" name="service_filter_mode" value="{{.ServiceFilterMode}}" data-service-mode-input>
                        <button
                            type="button"
                            data-services-button
                            aria-expanded="false"
                            class="w-full px-4 py-2 pr-10 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 cursor-pointer text-gray-100 text-left">
                            <span data-services-text>{{if .Services}}{{len .Services}} service(s){{else}}All Services{{end}}</span>
                            <svg class="w-4 h-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div data-services-menu class="hidden absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg max-h-80 overflow-auto">
                            <!-- Filter Mode Selection -->
                            <div class="px-4 py-3 border-b border-gray-600">
                                <div class="text-xs font-medium text-gray-400 mb-2">Filter Mode:</div>
                                <div class="space-y-1">
                                    <label class="flex items-center space-x-2 cursor-pointer text-sm">
                                        <input type="radio" name="service_filter_mode_radio" value="any" {{if or (not .ServiceFilterMode) (eq .ServiceFilterMode "any")}}checked{{end}} class="service-mode-radio w-3 h-3">
                                        <span class="text-gray-300">Any of selected</span>
                                    </label>
                                    <label class="flex items-center space-x-2 cursor-pointer text-sm">
                                        <input type="radio" name="service_filter_mode_radio" value="all" {{if eq .ServiceFilterMode "all"}}checked{{end}} class="service-mode-radio w-3 h-3">
                                        <span class="text-gray-300">All of selected</span>
                                    </label>
                                    <label class="flex items-center space-x-2 cursor-pointer text-sm">
                                        <input type="radio" name="service_filter_mode_radio" value="exact" {{if eq .ServiceFilterMode "exact"}}checked{{end}} class="service-mode-radio w-3 h-3">
                                        <span class="text-gray-300">Only selected (exact)</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Service Checkboxes -->
                            <div class="px-4 py-2 border-b border-gray-600">
                                <div class="flex items-center space-x-2">
                                    <input
                                        type="checkbox"
                                        data-select-all-services
                                        class="w-4 h-4 bg-gray-700 border-gray-600 rounded cursor-pointer">
                                    <label class="text-sm font-medium text-gray-300 cursor-pointer">Select All</label>
                                </div>
                            </div>
                            <div data-services-list>
                                {{$selectedServices := .Services}}
                                <label class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-600 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        value="plex"
                                        {{range $selectedServices}}{{if eq . "plex"}}checked{{end}}{{end}}
                                        class="service-checkbox w-4 h-4 bg-gray-700 border-gray-600 rounded">
                                    <span class="text-gray-100">Plex</span>
                                </label>
                                <label class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-600 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        value="sonarr"
                                        {{range $selectedServices}}{{if eq . "sonarr"}}checked{{end}}{{end}}
                                        class="service-checkbox w-4 h-4 bg-gray-700 border-gray-600 rounded">
                                    <span class="text-gray-100">Sonarr</span>
                                </label>
                                <label class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-600 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        value="radarr"
                                        {{range $selectedServices}}{{if eq . "radarr"}}checked{{end}}{{end}}
                                        class="service-checkbox w-4 h-4 bg-gray-700 border-gray-600 rounded">
                                    <span class="text-gray-100">Radarr</span>
                                </label>
                                <label class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-600 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        value="qbittorrent"
                                        {{range $selectedServices}}{{if eq . "qbittorrent"}}checked{{end}}{{end}}
                                        class="service-checkbox w-4 h-4 bg-gray-700 border-gray-600 rounded">
                                    <span class="text-gray-100">qBittorrent</span>
                                </label>
                                <label class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-600 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        value="stash"
                                        {{range $selectedServices}}{{if eq . "stash"}}checked{{end}}{{end}}
                                        class="service-checkbox w-4 h-4 bg-gray-700 border-gray-600 rounded">
                                    <span class="text-gray-100">Stash</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Extension Filter -->
                <div>
                    <span class="block text-sm font-medium text-gray-400 mb-2">File Extensions</span>
                    <div class="relative z-20" data-extension-multiselect>
                        <input type="hidden" name="extensions" value="{{range $i, $ext := .Extensions}}{{if $i}},{{end}}{{$ext}}{{end}}" data-extensions-input>
                        <button
                            type="button"
                            data-extensions-button
                            aria-expanded="false"
                            class="w-full px-4 py-2 pr-10 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 cursor-pointer text-gray-100 text-left">
                            <span data-extensions-text>{{if .Extensions}}{{len .Extensions}} extension(s){{else}}All Extensions{{end}}</span>
                            <svg class="w-4 h-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div data-extensions-menu class="hidden absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg max-h-60 overflow-auto">
                            <div class="px-4 py-2 border-b border-gray-600">
                                <div class="flex items-center space-x-2">
                                    <input
                                        type="checkbox"
                                        data-select-all-extensions
                                        class="w-4 h-4 bg-gray-700 border-gray-600 rounded cursor-pointer">
                                    <label class="text-sm font-medium text-gray-300 cursor-pointer">Select All</label>
                                </div>
                            </div>
                            <div data-extensions-list class="text-gray-400 text-sm px-4 py-2">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Orphaned Filter -->
            <div class="flex items-center">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input
                        type="checkbox"
                        name="orphaned"
                        value="true"
                        {{if .Orphaned}}checked{{end}}
                        class="w-4 h-4 bg-gray-700 border-gray-600 rounded focus:ring-2 focus:ring-blue-500">
                    <span class="text-sm text-gray-300">Show only orphaned files</span>
                </label>
            </div>

            <div class="flex justify-between items-center">
                <div class="flex space-x-2">
                    <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded transition cursor-pointer">
                        Apply Filters
                    </button>
                    <a href="/files" class="inline-block px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded transition">
                        Clear
                    </a>
                </div>

                <!-- Page Size -->
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-400">Per page:</span>
                        <div class="relative z-10" data-custom-dropdown>
                            <input type="hidden" name="limit" value="{{.Limit}}" data-dropdown-input>
                            <button
                                type="button"
                                data-dropdown-button
                                aria-expanded="false"
                                class="pl-3 pr-8 py-1 bg-gray-700 border border-gray-600 rounded text-sm cursor-pointer focus:outline-none focus:border-blue-500 text-gray-100 text-left w-24">
                                <span data-dropdown-text>{{.Limit}}</span>
                                <svg class="w-3 h-3 absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div data-dropdown-menu class="hidden absolute z-10 w-24 mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg max-h-60 overflow-auto right-0">
                                <div data-dropdown-option data-value="25" class="px-3 py-1 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 {{if eq .Limit 25}}bg-blue-600{{end}}" aria-selected="{{if eq .Limit 25}}true{{else}}false{{end}}">25</div>
                                <div data-dropdown-option data-value="50" class="px-3 py-1 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 {{if eq .Limit 50}}bg-blue-600{{end}}" aria-selected="{{if eq .Limit 50}}true{{else}}false{{end}}">50</div>
                                <div data-dropdown-option data-value="100" class="px-3 py-1 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 {{if eq .Limit 100}}bg-blue-600{{end}}" aria-selected="{{if eq .Limit 100}}true{{else}}false{{end}}">100</div>
                                <div data-dropdown-option data-value="500" class="px-3 py-1 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 {{if eq .Limit 500}}bg-blue-600{{end}}" aria-selected="{{if eq .Limit 500}}true{{else}}false{{end}}">500</div>
                            </div>
                        </div>
                    </div>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input
                            type="checkbox"
                            name="infinite_scroll"
                            id="infinite-scroll-toggle"
                            value="true"
                            class="w-4 h-4 bg-gray-700 border-gray-600 rounded focus:ring-2 focus:ring-blue-500">
                        <span class="text-sm text-gray-400">Infinite Scroll</span>
                    </label>
                </div>
            </div>
        </form>
    </div>

    <!-- Files Table -->
    <div id="files-table" class="bg-gray-800 rounded-lg overflow-hidden" role="region" aria-label="Files list">
        <div class="overflow-x-auto scrollbar-thin">
            <table class="w-full" role="table" aria-label="Media files">
                <thead class="bg-gray-700">
                    <tr role="row">
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                            {{if and (eq .OrderBy "path") (eq .Direction "asc")}}
                            <a href="/files?order=path&direction=desc&limit={{.Limit}}{{if .Orphaned}}&orphaned=true{{end}}{{if .Hardlinks}}&hardlink=true{{end}}{{if .Services}}&services={{range $i, $svc := .Services}}{{if $i}},{{end}}{{$svc}}{{end}}{{end}}{{if .ServiceFilterMode}}&service_filter_mode={{.ServiceFilterMode}}{{end}}"
                               class="hover:text-gray-200 cursor-pointer"
                               aria-label="Sort by path descending">
                                Path ↑
                            </a>
                            {{else if and (eq .OrderBy "path") (eq .Direction "desc")}}
                            <a href="/files?order=path&direction=asc&limit={{.Limit}}{{if .Orphaned}}&orphaned=true{{end}}{{if .Hardlinks}}&hardlink=true{{end}}{{if .Services}}&services={{range $i, $svc := .Services}}{{if $i}},{{end}}{{$svc}}{{end}}{{end}}{{if .ServiceFilterMode}}&service_filter_mode={{.ServiceFilterMode}}{{end}}"
                               class="hover:text-gray-200 cursor-pointer"
                               aria-label="Sort by path ascending">
                                Path ↓
                            </a>
                            {{else}}
                            <a href="/files?order=path&direction=asc&limit={{.Limit}}{{if .Orphaned}}&orphaned=true{{end}}{{if .Hardlinks}}&hardlink=true{{end}}{{if .Services}}&services={{range $i, $svc := .Services}}{{if $i}},{{end}}{{$svc}}{{end}}{{end}}{{if .ServiceFilterMode}}&service_filter_mode={{.ServiceFilterMode}}{{end}}"
                               class="hover:text-gray-200 cursor-pointer"
                               aria-label="Sort by path">
                                Path
                            </a>
                            {{end}}
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                            {{if and (eq .OrderBy "size") (eq .Direction "asc")}}
                            <a href="/files?order=size&direction=desc&limit={{.Limit}}{{if .Orphaned}}&orphaned=true{{end}}{{if .Hardlinks}}&hardlink=true{{end}}{{if .Services}}&services={{range $i, $svc := .Services}}{{if $i}},{{end}}{{$svc}}{{end}}{{end}}{{if .ServiceFilterMode}}&service_filter_mode={{.ServiceFilterMode}}{{end}}"
                               class="hover:text-gray-200 cursor-pointer"
                               aria-label="Sort by size descending">
                                Size ↑
                            </a>
                            {{else if and (eq .OrderBy "size") (eq .Direction "desc")}}
                            <a href="/files?order=size&direction=asc&limit={{.Limit}}{{if .Orphaned}}&orphaned=true{{end}}{{if .Hardlinks}}&hardlink=true{{end}}{{if .Services}}&services={{range $i, $svc := .Services}}{{if $i}},{{end}}{{$svc}}{{end}}{{end}}{{if .ServiceFilterMode}}&service_filter_mode={{.ServiceFilterMode}}{{end}}"
                               class="hover:text-gray-200 cursor-pointer"
                               aria-label="Sort by size ascending">
                                Size ↓
                            </a>
                            {{else}}
                            <a href="/files?order=size&direction=desc&limit={{.Limit}}{{if .Orphaned}}&orphaned=true{{end}}{{if .Hardlinks}}&hardlink=true{{end}}{{if .Services}}&services={{range $i, $svc := .Services}}{{if $i}},{{end}}{{$svc}}{{end}}{{end}}{{if .ServiceFilterMode}}&service_filter_mode={{.ServiceFilterMode}}{{end}}"
                               class="hover:text-gray-200 cursor-pointer"
                               aria-label="Sort by size">
                                Size
                            </a>
                            {{end}}
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Services</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-700">
                    {{range .Files}}
                    <tr class="hover:bg-gray-750 transition">
                        <td class="px-6 py-4 text-sm text-gray-300 font-mono break-all max-w-md">
                            <div class="truncate sm:whitespace-normal" title="{{.File.Path}}">
                                {{.File.Path}}
                            </div>
                            {{if $.DiskResolver}}
                            <div class="mt-1">
                                <span class="px-2 py-1 {{if eq ($.DiskResolver.ResolveColor .File.DeviceID) "blue"}}bg-blue-600{{else if eq ($.DiskResolver.ResolveColor .File.DeviceID) "purple"}}bg-purple-600{{else}}bg-gray-600{{end}} rounded text-xs">
                                    {{$.DiskResolver.ResolveDisplayName .File.DeviceID}}
                                </span>
                            </div>
                            {{end}}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-400 whitespace-nowrap">
                            {{formatSize .File.Size}}
                        </td>
                        <td class="px-6 py-4 text-sm">
                            {{if .Usage}}
                                <div class="flex flex-wrap gap-1">
                                    {{range .Usage}}
                                    <span class="px-2 py-1 {{serviceClass .Service "bg"}} {{serviceClass .Service "text-on-bg"}} rounded text-xs">{{formatServiceName .Service}}</span>
                                    {{end}}
                                </div>
                            {{else}}
                                <span class="text-gray-500">None</span>
                            {{end}}
                        </td>
                        <td class="px-6 py-4 text-sm whitespace-nowrap">
                            {{if .File.IsOrphaned}}
                                <span class="px-2 py-1 bg-yellow-600 rounded text-xs">Orphaned</span>
                            {{else}}
                                <span class="px-2 py-1 bg-green-600 rounded text-xs">In Use</span>
                            {{end}}
                        </td>
                        <td class="px-6 py-4 text-sm">
                            <div class="flex flex-col sm:flex-row sm:space-x-2 space-y-1 sm:space-y-0">
                                <button
                                    data-file-id="{{.File.ID}}"
                                    data-action="show-details"
                                    aria-label="View file details"
                                    class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-sm transition cursor-pointer whitespace-nowrap">
                                    Details
                                </button>
                                <button
                                    hx-post="/api/files/mark-rescan?id={{.File.ID}}"
                                    aria-label="Mark file for rescan"
                                    class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm transition cursor-pointer whitespace-nowrap">
                                    Rescan
                                </button>
                                <button
                                    hx-delete="/api/files/delete?id={{.File.ID}}"
                                    hx-confirm="Are you sure you want to delete this file? This action cannot be undone."
                                    hx-target="closest tr"
                                    hx-swap="outerHTML"
                                    aria-label="Delete file"
                                    class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm transition cursor-pointer whitespace-nowrap">
                                    Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                    {{else}}
                    <tr>
                        <td colspan="6" class="px-6 py-16">
                            <div class="flex flex-col items-center justify-center text-center space-y-4">
                                <svg class="w-16 h-16 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                {{if .Search}}
                                    <div class="space-y-2">
                                        <p class="text-lg font-medium text-gray-400">No files match your search</p>
                                        <p class="text-sm text-gray-500">Try adjusting your search terms or filters</p>
                                    </div>
                                {{else if .Orphaned}}
                                    <div class="space-y-2">
                                        <p class="text-lg font-medium text-gray-400">No orphaned files found</p>
                                        <p class="text-sm text-gray-500">All your files are being tracked by at least one service!</p>
                                    </div>
                                {{else if .Services}}
                                    <div class="space-y-2">
                                        <p class="text-lg font-medium text-gray-400">No files found for selected services</p>
                                        <p class="text-sm text-gray-500">{{if eq (len .Services) 1}}This service hasn't indexed any files yet{{else}}No files match the selected service filter{{end}}</p>
                                    </div>
                                {{else}}
                                    <div class="space-y-3">
                                        <p class="text-lg font-medium text-gray-400">No files found</p>
                                        <p class="text-sm text-gray-500">Start a scan to discover and track your media files</p>
                                        <button
                                            hx-post="/api/scan/start"
                                            hx-confirm="Start a new scan? This may take a while for large libraries."
                                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition inline-flex items-center space-x-2 cursor-pointer">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                            </svg>
                                            <span>Start Scan</span>
                                        </button>
                                    </div>
                                {{end}}
                            </div>
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>

        <!-- Pagination / Infinite Scroll Trigger -->
        {{if gt .TotalPages 1}}
        <div id="pagination-container" class="bg-gray-700 px-6 py-4 flex items-center justify-between">
            <div class="text-sm text-gray-400">
                Page {{.Page}} of {{.TotalPages}}
            </div>
            <div class="flex space-x-2">
                {{if gt .Page 1}}
                <a href="/files?page={{sub .Page 1}}&limit={{.Limit}}{{if .Orphaned}}&orphaned=true{{end}}{{if .Hardlinks}}&hardlink=true{{end}}{{if .Services}}&services={{range $i, $svc := .Services}}{{if $i}},{{end}}{{$svc}}{{end}}{{end}}{{if .ServiceFilterMode}}&service_filter_mode={{.ServiceFilterMode}}{{end}}{{if .Extensions}}&extensions={{range $i, $ext := .Extensions}}{{if $i}},{{end}}{{$ext}}{{end}}{{end}}{{if .Search}}&search={{.Search}}{{end}}{{if .OrderBy}}&order={{.OrderBy}}{{end}}{{if .Direction}}&direction={{.Direction}}{{end}}"
                   class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-sm transition">
                    Previous
                </a>
                {{end}}

                {{if lt .Page .TotalPages}}
                <a id="next-page-btn"
                   href="/files?page={{add .Page 1}}&limit={{.Limit}}{{if .Orphaned}}&orphaned=true{{end}}{{if .Hardlinks}}&hardlink=true{{end}}{{if .Services}}&services={{range $i, $svc := .Services}}{{if $i}},{{end}}{{$svc}}{{end}}{{end}}{{if .ServiceFilterMode}}&service_filter_mode={{.ServiceFilterMode}}{{end}}{{if .Extensions}}&extensions={{range $i, $ext := .Extensions}}{{if $i}},{{end}}{{$ext}}{{end}}{{end}}{{if .Search}}&search={{.Search}}{{end}}{{if .OrderBy}}&order={{.OrderBy}}{{end}}{{if .Direction}}&direction={{.Direction}}{{end}}"
                   class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-sm transition"
                   hx-get="/files?page={{add .Page 1}}&limit={{.Limit}}{{if .Orphaned}}&orphaned=true{{end}}{{if .Hardlinks}}&hardlink=true{{end}}{{if .Services}}&services={{range $i, $svc := .Services}}{{if $i}},{{end}}{{$svc}}{{end}}{{end}}{{if .ServiceFilterMode}}&service_filter_mode={{.ServiceFilterMode}}{{end}}{{if .Extensions}}&extensions={{range $i, $ext := .Extensions}}{{if $i}},{{end}}{{$ext}}{{end}}{{end}}{{if .Search}}&search={{.Search}}{{end}}{{if .OrderBy}}&order={{.OrderBy}}{{end}}{{if .Direction}}&direction={{.Direction}}{{end}}"
                   hx-trigger="revealed"
                   hx-target="#files-table tbody"
                   hx-swap="beforeend"
                   hx-select="#files-table tbody > tr"
                   hx-indicator="#infinite-scroll-loading"
                   data-current-page="{{.Page}}"
                   data-total-pages="{{.TotalPages}}"
                   hx-disabled="true">
                    Next
                </a>
                <div id="infinite-scroll-loading" class="htmx-indicator px-3 py-1 text-sm text-gray-400">
                    <svg class="animate-spin h-4 w-4 inline-block mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Loading more...
                </div>
                {{end}}
            </div>
        </div>
        {{end}}
    </div>

    <script>
    // Infinite scroll toggle
    const infiniteScrollToggle = document.getElementById('infinite-scroll-toggle');
    const nextPageBtn = document.getElementById('next-page-btn');

    if (infiniteScrollToggle && nextPageBtn) {
        infiniteScrollToggle.addEventListener('change', function() {
            if (this.checked) {
                // Enable infinite scroll
                nextPageBtn.removeAttribute('hx-disabled');
                nextPageBtn.classList.add('hidden');
                document.getElementById('pagination-container').classList.add('border-t-2', 'border-blue-500');
                // Re-initialize htmx on this element to pick up the attribute change
                htmx.process(nextPageBtn);
            } else {
                // Disable infinite scroll
                nextPageBtn.setAttribute('hx-disabled', 'true');
                nextPageBtn.classList.remove('hidden');
                document.getElementById('pagination-container').classList.remove('border-t-2', 'border-blue-500');
            }
        });

        // Update next page URL after each infinite scroll load
        document.body.addEventListener('htmx:afterSwap', function(event) {
            // Only process infinite scroll swaps when enabled
            const isInfiniteScrollEnabled = infiniteScrollToggle && infiniteScrollToggle.checked;
            if (!isInfiniteScrollEnabled) return;

            // Check if this was an infinite scroll load (tbody swap)
            if (event.detail.target && event.detail.target.matches &&
                event.detail.target.matches('#files-table tbody')) {
                const btn = document.getElementById('next-page-btn');
                if (!btn) return;

                const currentPage = parseInt(btn.getAttribute('data-current-page') || '1');
                const totalPages = parseInt(btn.getAttribute('data-total-pages') || '1');
                const nextPage = currentPage + 1;

                if (nextPage <= totalPages) {
                    // Update page number in data attribute
                    btn.setAttribute('data-current-page', nextPage);

                    // Update URLs for the NEXT page to load (not the one we just loaded)
                    const currentUrl = new URL(btn.getAttribute('hx-get'), window.location.origin);
                    currentUrl.searchParams.set('page', nextPage);

                    btn.setAttribute('hx-get', currentUrl.pathname + currentUrl.search);
                    btn.setAttribute('href', currentUrl.pathname + currentUrl.search);

                    // Re-process the element so HTMX picks up the new URL
                    htmx.process(btn);
                } else {
                    // No more pages, disable infinite scroll
                    btn.setAttribute('hx-disabled', 'true');
                    btn.classList.add('hidden');
                }
            }
        });
    }

    // Extension multiselect functionality
    const extensionMultiselect = document.querySelector('[data-extension-multiselect]');
    if (extensionMultiselect) {
        const button = extensionMultiselect.querySelector('[data-extensions-button]');
        const menu = extensionMultiselect.querySelector('[data-extensions-menu]');
        const input = extensionMultiselect.querySelector('[data-extensions-input]');
        const textSpan = extensionMultiselect.querySelector('[data-extensions-text]');
        const extensionsList = extensionMultiselect.querySelector('[data-extensions-list]');
        const selectAllCheckbox = extensionMultiselect.querySelector('[data-select-all-extensions]');

        let availableExtensions = [];
        let selectedExtensions = new Set();

        // Parse initial selected extensions from hidden input
        if (input.value) {
            input.value.split(',').forEach(ext => {
                if (ext.trim()) selectedExtensions.add(ext.trim());
            });
        }

        // Toggle dropdown
        button.addEventListener('click', function() {
            const isOpen = menu.classList.contains('hidden');
            menu.classList.toggle('hidden');
            button.setAttribute('aria-expanded', isOpen ? 'true' : 'false');

            // Load extensions on first open
            if (isOpen && availableExtensions.length === 0) {
                loadExtensions();
            }
        });

        // Close on click outside
        document.addEventListener('click', function(e) {
            if (!extensionMultiselect.contains(e.target)) {
                menu.classList.add('hidden');
                button.setAttribute('aria-expanded', 'false');
            }
        });

        // Load extensions from API
        function loadExtensions() {
            extensionsList.innerHTML = '<div class="text-gray-400 text-sm">Loading...</div>';

            fetch('/api/files/extensions')
                .then(response => {
                    console.log('Extensions API response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Extensions API data:', data);
                    availableExtensions = data.extensions || [];
                    console.log('Available extensions:', availableExtensions);
                    renderExtensions();
                })
                .catch(error => {
                    console.error('Failed to load extensions:', error);
                    extensionsList.innerHTML = '<div class="text-red-400 text-sm px-4 py-2">Failed to load extensions</div>';
                });
        }

        // Render extension checkboxes
        function renderExtensions() {
            console.log('Rendering extensions, count:', availableExtensions.length);
            if (availableExtensions.length === 0) {
                extensionsList.innerHTML = '<div class="text-gray-400 text-sm px-4 py-2">No extensions found. Files may not have been scanned yet.</div>';
                return;
            }

            extensionsList.innerHTML = availableExtensions.map(ext => `
                <label class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-600 cursor-pointer">
                    <input
                        type="checkbox"
                        value="${ext}"
                        ${selectedExtensions.has(ext) ? 'checked' : ''}
                        class="extension-checkbox w-4 h-4 bg-gray-700 border-gray-600 rounded">
                    <span class="text-gray-100">.${ext}</span>
                </label>
            `).join('');

            // Add event listeners to checkboxes
            extensionsList.querySelectorAll('.extension-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', handleExtensionChange);
            });

            updateSelectAllState();
        }

        // Handle individual checkbox change
        function handleExtensionChange(e) {
            const ext = e.target.value;
            if (e.target.checked) {
                selectedExtensions.add(ext);
            } else {
                selectedExtensions.delete(ext);
            }
            updateHiddenInput();
            updateSelectAllState();
        }

        // Handle select all checkbox
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function(e) {
                const checkboxes = extensionsList.querySelectorAll('.extension-checkbox');
                checkboxes.forEach(cb => {
                    cb.checked = e.target.checked;
                    if (e.target.checked) {
                        selectedExtensions.add(cb.value);
                    } else {
                        selectedExtensions.delete(cb.value);
                    }
                });
                updateHiddenInput();
            });
        }

        // Update select all checkbox state
        function updateSelectAllState() {
            if (!selectAllCheckbox) return;
            const checkboxes = extensionsList.querySelectorAll('.extension-checkbox');
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            selectAllCheckbox.checked = checkedCount === checkboxes.length && checkboxes.length > 0;
            selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
        }

        // Update hidden input and button text
        function updateHiddenInput() {
            const values = Array.from(selectedExtensions).join(',');
            input.value = values;

            if (selectedExtensions.size === 0) {
                textSpan.textContent = 'All Extensions';
            } else if (selectedExtensions.size === 1) {
                textSpan.textContent = '1 extension';
            } else {
                textSpan.textContent = `${selectedExtensions.size} extensions`;
            }
        }
    }

    // Service multiselect functionality
    const serviceMultiselect = document.querySelector('[data-service-multiselect]');
    if (serviceMultiselect) {
        const button = serviceMultiselect.querySelector('[data-services-button]');
        const menu = serviceMultiselect.querySelector('[data-services-menu]');
        const servicesInput = serviceMultiselect.querySelector('[data-services-input]');
        const modeInput = serviceMultiselect.querySelector('[data-service-mode-input]');
        const textSpan = serviceMultiselect.querySelector('[data-services-text]');
        const servicesList = serviceMultiselect.querySelector('[data-services-list]');
        const selectAllCheckbox = serviceMultiselect.querySelector('[data-select-all-services]');
        const modeRadios = serviceMultiselect.querySelectorAll('.service-mode-radio');

        let selectedServices = new Set();

        // Parse initial selected services from hidden input
        if (servicesInput.value) {
            servicesInput.value.split(',').forEach(svc => {
                if (svc.trim()) selectedServices.add(svc.trim());
            });
        }

        // Toggle dropdown
        button.addEventListener('click', function() {
            const isOpen = menu.classList.contains('hidden');
            menu.classList.toggle('hidden');
            button.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        });

        // Close on click outside
        document.addEventListener('click', function(e) {
            if (!serviceMultiselect.contains(e.target)) {
                menu.classList.add('hidden');
                button.setAttribute('aria-expanded', 'false');
            }
        });

        // Handle individual checkbox change
        servicesList.querySelectorAll('.service-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function(e) {
                const svc = e.target.value;
                if (e.target.checked) {
                    selectedServices.add(svc);
                } else {
                    selectedServices.delete(svc);
                }
                updateServicesInput();
                updateSelectAllServicesState();
            });
        });

        // Handle select all checkbox
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function(e) {
                const checkboxes = servicesList.querySelectorAll('.service-checkbox');
                checkboxes.forEach(cb => {
                    cb.checked = e.target.checked;
                    if (e.target.checked) {
                        selectedServices.add(cb.value);
                    } else {
                        selectedServices.delete(cb.value);
                    }
                });
                updateServicesInput();
            });
        }

        // Handle mode radio change
        modeRadios.forEach(radio => {
            radio.addEventListener('change', function(e) {
                modeInput.value = e.target.value;
            });
        });

        // Update select all checkbox state
        function updateSelectAllServicesState() {
            if (!selectAllCheckbox) return;
            const checkboxes = servicesList.querySelectorAll('.service-checkbox');
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            selectAllCheckbox.checked = checkedCount === checkboxes.length && checkboxes.length > 0;
            selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
        }

        // Update hidden input and button text
        function updateServicesInput() {
            const values = Array.from(selectedServices).join(',');
            servicesInput.value = values;

            if (selectedServices.size === 0) {
                textSpan.textContent = 'All Services';
            } else if (selectedServices.size === 1) {
                textSpan.textContent = '1 service';
            } else {
                textSpan.textContent = `${selectedServices.size} services`;
            }
        }

        // Initial state
        updateSelectAllServicesState();
    }
    </script>

    <!-- Export and Bulk Actions -->
    <div class="bg-gray-800 rounded-lg p-6">
        <h3 class="text-lg font-semibold mb-4">Actions</h3>

        <div class="space-y-4">
            <!-- Export -->
            <div>
                <h4 class="text-sm font-medium text-gray-400 mb-2">Export</h4>
                <div class="flex space-x-4">
                    <a href="/api/export?format=json{{if .Orphaned}}&orphaned=true{{end}}"
                       class="inline-block px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded transition"
                       download>
                        Export as JSON
                    </a>
                    <a href="/api/export?format=csv{{if .Orphaned}}&orphaned=true{{end}}"
                       class="inline-block px-4 py-2 bg-green-600 hover:bg-green-700 rounded transition"
                       download>
                        Export as CSV
                    </a>
                </div>
            </div>

            <!-- Bulk Actions -->
            {{if .Orphaned}}
            <div>
                <h4 class="text-sm font-medium text-gray-400 mb-2">Bulk Actions on Orphaned Files</h4>
                <div class="flex space-x-4">
                    <button
                        hx-post="/api/files/mark-rescan?orphaned=true"
                        hx-confirm="Mark all {{.Total}} orphaned files for rescan?"
                        class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded transition">
                        Mark All for Rescan
                    </button>
                    <button
                        hx-delete="/api/files/delete?orphaned=true"
                        hx-confirm="Are you ABSOLUTELY SURE you want to delete ALL {{.Total}} orphaned files? This CANNOT be undone!"
                        class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded transition">
                        Delete All Orphaned
                    </button>
                </div>
            </div>
            {{end}}
        </div>
    </div>
</div>
{{end}}

