{{template "layout.html" .}}

{{define "content"}}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h2 class="text-3xl font-bold">Files</h2>
        <div class="text-gray-400">
            Total: {{.Total}} files
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="bg-gray-800 rounded-lg p-6">
        <form hx-get="/files" hx-target="#files-table" hx-select="#files-table" hx-push-url="true" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Search -->
                <div>
                    <label for="search-input" class="block text-sm font-medium text-gray-400 mb-2">Search Files</label>
                    <div class="relative">
                        <input
                            type="text"
                            name="search"
                            id="search-input"
                            value="{{.Search}}"
                            placeholder="Search by path..."
                            hx-get="/files"
                            hx-trigger="keyup changed delay:500ms, search"
                            hx-target="#files-table"
                            hx-include="[name='service'], [name='orphaned'], [name='limit']"
                            class="w-full px-4 py-2 pr-10 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500">
                        <div id="search-spinner" class="absolute right-3 top-1/2 transform -translate-y-1/2 hidden">
                            <svg class="animate-spin h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                    </div>
                    {{if .Search}}
                    <p class="text-xs text-gray-500 mt-1">
                        Showing results for "{{.Search}}"
                        <a href="/files" class="text-blue-400 hover:text-blue-300 ml-2">Clear</a>
                    </p>
                    {{end}}
                </div>

                <!-- Service Filter -->
                <div>
                    <span class="block text-sm font-medium text-gray-400 mb-2">Service</span>
                    <div class="relative z-30" data-custom-dropdown>
                        <input type="hidden" name="service" value="{{.Service}}" data-dropdown-input>
                        <button
                            type="button"
                            data-dropdown-button
                            aria-expanded="false"
                            class="w-full px-4 py-2 pr-10 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 cursor-pointer text-gray-100 text-left">
                            <span data-dropdown-text>{{if .Service}}{{if eq .Service "plex"}}Plex{{else if eq .Service "sonarr"}}Sonarr{{else if eq .Service "radarr"}}Radarr{{else if eq .Service "qbittorrent"}}qBittorrent{{end}}{{else}}All Services{{end}}</span>
                            <svg class="w-4 h-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div data-dropdown-menu class="hidden absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg max-h-60 overflow-auto">
                            <div data-dropdown-option data-value="" class="px-4 py-2 hover:bg-gray-600 cursor-pointer text-gray-100 {{if not .Service}}bg-blue-600{{end}}" aria-selected="{{if not .Service}}true{{else}}false{{end}}">All Services</div>
                            <div data-dropdown-option data-value="plex" class="px-4 py-2 hover:bg-gray-600 cursor-pointer text-gray-100 {{if eq .Service "plex"}}bg-blue-600{{end}}" aria-selected="{{if eq .Service "plex"}}true{{else}}false{{end}}">Plex</div>
                            <div data-dropdown-option data-value="sonarr" class="px-4 py-2 hover:bg-gray-600 cursor-pointer text-gray-100 {{if eq .Service "sonarr"}}bg-blue-600{{end}}" aria-selected="{{if eq .Service "sonarr"}}true{{else}}false{{end}}">Sonarr</div>
                            <div data-dropdown-option data-value="radarr" class="px-4 py-2 hover:bg-gray-600 cursor-pointer text-gray-100 {{if eq .Service "radarr"}}bg-blue-600{{end}}" aria-selected="{{if eq .Service "radarr"}}true{{else}}false{{end}}">Radarr</div>
                            <div data-dropdown-option data-value="qbittorrent" class="px-4 py-2 hover:bg-gray-600 cursor-pointer text-gray-100 {{if eq .Service "qbittorrent"}}bg-blue-600{{end}}" aria-selected="{{if eq .Service "qbittorrent"}}true{{else}}false{{end}}">qBittorrent</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Orphaned Filter -->
            <div class="flex items-center">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input
                        type="checkbox"
                        name="orphaned"
                        value="true"
                        {{if .Orphaned}}checked{{end}}
                        class="w-4 h-4 bg-gray-700 border-gray-600 rounded focus:ring-2 focus:ring-blue-500">
                    <span class="text-sm text-gray-300">Show only orphaned files</span>
                </label>
            </div>

            <div class="flex justify-between items-center">
                <div class="flex space-x-2">
                    <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded transition cursor-pointer">
                        Apply Filters
                    </button>
                    <a href="/files" class="inline-block px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded transition">
                        Clear
                    </a>
                </div>

                <!-- Page Size -->
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-400">Per page:</span>
                        <div class="relative z-10" data-custom-dropdown>
                            <input type="hidden" name="limit" value="{{.Limit}}" data-dropdown-input>
                            <button
                                type="button"
                                data-dropdown-button
                                aria-expanded="false"
                                class="pl-3 pr-8 py-1 bg-gray-700 border border-gray-600 rounded text-sm cursor-pointer focus:outline-none focus:border-blue-500 text-gray-100 text-left w-24">
                                <span data-dropdown-text>{{.Limit}}</span>
                                <svg class="w-3 h-3 absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div data-dropdown-menu class="hidden absolute z-10 w-24 mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg max-h-60 overflow-auto right-0">
                                <div data-dropdown-option data-value="25" class="px-3 py-1 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 {{if eq .Limit 25}}bg-blue-600{{end}}" aria-selected="{{if eq .Limit 25}}true{{else}}false{{end}}">25</div>
                                <div data-dropdown-option data-value="50" class="px-3 py-1 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 {{if eq .Limit 50}}bg-blue-600{{end}}" aria-selected="{{if eq .Limit 50}}true{{else}}false{{end}}">50</div>
                                <div data-dropdown-option data-value="100" class="px-3 py-1 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 {{if eq .Limit 100}}bg-blue-600{{end}}" aria-selected="{{if eq .Limit 100}}true{{else}}false{{end}}">100</div>
                                <div data-dropdown-option data-value="500" class="px-3 py-1 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 {{if eq .Limit 500}}bg-blue-600{{end}}" aria-selected="{{if eq .Limit 500}}true{{else}}false{{end}}">500</div>
                            </div>
                        </div>
                    </div>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input
                            type="checkbox"
                            name="infinite_scroll"
                            id="infinite-scroll-toggle"
                            value="true"
                            class="w-4 h-4 bg-gray-700 border-gray-600 rounded focus:ring-2 focus:ring-blue-500">
                        <span class="text-sm text-gray-400">Infinite Scroll</span>
                    </label>
                </div>
            </div>
        </form>
    </div>

    <!-- Files Table -->
    <div id="files-table" class="bg-gray-800 rounded-lg overflow-hidden" role="region" aria-label="Files list">
        <div class="overflow-x-auto scrollbar-thin">
            <table class="w-full" role="table" aria-label="Media files">
                <thead class="bg-gray-700">
                    <tr role="row">
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                            <a href="/files?order=path&limit={{.Limit}}{{if .Orphaned}}&orphaned=true{{end}}{{if .Hardlinks}}&hardlink=true{{end}}{{if .Service}}&service={{.Service}}{{end}}"
                               class="hover:text-gray-200 cursor-pointer"
                               aria-label="Sort by path">
                                Path ↕
                            </a>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                            <a href="/files?order=size&limit={{.Limit}}{{if .Orphaned}}&orphaned=true{{end}}{{if .Hardlinks}}&hardlink=true{{end}}{{if .Service}}&service={{.Service}}{{end}}"
                               class="hover:text-gray-200 cursor-pointer"
                               aria-label="Sort by size">
                                Size ↕
                            </a>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Services</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-700">
                    {{range .Files}}
                    <tr class="hover:bg-gray-750 transition">
                        <td class="px-6 py-4 text-sm text-gray-300 font-mono break-all max-w-md">
                            <div class="truncate sm:whitespace-normal" title="{{.File.Path}}">
                                {{.File.Path}}
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-400 whitespace-nowrap">
                            {{formatSize .File.Size}}
                        </td>
                        <td class="px-6 py-4 text-sm">
                            {{if .Usage}}
                                <div class="flex flex-wrap gap-1">
                                    {{range .Usage}}
                                    <span class="px-2 py-1 bg-gray-600 rounded text-xs capitalize">{{.Service}}</span>
                                    {{end}}
                                </div>
                            {{else}}
                                <span class="text-gray-500">None</span>
                            {{end}}
                        </td>
                        <td class="px-6 py-4 text-sm whitespace-nowrap">
                            {{if .File.IsOrphaned}}
                                <span class="px-2 py-1 bg-yellow-600 rounded text-xs">Orphaned</span>
                            {{else}}
                                <span class="px-2 py-1 bg-green-600 rounded text-xs">In Use</span>
                            {{end}}
                        </td>
                        <td class="px-6 py-4 text-sm">
                            <div class="flex flex-col sm:flex-row sm:space-x-2 space-y-1 sm:space-y-0">
                                <button
                                    data-file-id="{{.File.ID}}"
                                    data-action="show-details"
                                    aria-label="View file details"
                                    class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-sm transition cursor-pointer whitespace-nowrap">
                                    Details
                                </button>
                                <button
                                    hx-post="/api/files/mark-rescan?id={{.File.ID}}"
                                    aria-label="Mark file for rescan"
                                    class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm transition cursor-pointer whitespace-nowrap">
                                    Rescan
                                </button>
                                <button
                                    hx-delete="/api/files/delete?id={{.File.ID}}"
                                    hx-confirm="Are you sure you want to delete this file? This action cannot be undone."
                                    hx-target="closest tr"
                                    hx-swap="outerHTML"
                                    aria-label="Delete file"
                                    class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm transition cursor-pointer whitespace-nowrap">
                                    Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                    {{else}}
                    <tr>
                        <td colspan="6" class="px-6 py-16">
                            <div class="flex flex-col items-center justify-center text-center space-y-4">
                                <svg class="w-16 h-16 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                {{if .Search}}
                                    <div class="space-y-2">
                                        <p class="text-lg font-medium text-gray-400">No files match your search</p>
                                        <p class="text-sm text-gray-500">Try adjusting your search terms or filters</p>
                                    </div>
                                {{else if .Orphaned}}
                                    <div class="space-y-2">
                                        <p class="text-lg font-medium text-gray-400">No orphaned files found</p>
                                        <p class="text-sm text-gray-500">All your files are being tracked by at least one service!</p>
                                    </div>
                                {{else if .Service}}
                                    <div class="space-y-2">
                                        <p class="text-lg font-medium text-gray-400">No files found for {{.Service}}</p>
                                        <p class="text-sm text-gray-500">This service hasn't indexed any files yet</p>
                                    </div>
                                {{else}}
                                    <div class="space-y-3">
                                        <p class="text-lg font-medium text-gray-400">No files found</p>
                                        <p class="text-sm text-gray-500">Start a scan to discover and track your media files</p>
                                        <button
                                            hx-post="/api/scan/start"
                                            hx-confirm="Start a new scan? This may take a while for large libraries."
                                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition inline-flex items-center space-x-2 cursor-pointer">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                            </svg>
                                            <span>Start Scan</span>
                                        </button>
                                    </div>
                                {{end}}
                            </div>
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>

        <!-- Pagination / Infinite Scroll Trigger -->
        {{if gt .TotalPages 1}}
        <div id="pagination-container" class="bg-gray-700 px-6 py-4 flex items-center justify-between">
            <div class="text-sm text-gray-400">
                Page {{.Page}} of {{.TotalPages}}
            </div>
            <div class="flex space-x-2">
                {{if gt .Page 1}}
                <a href="/files?page={{sub .Page 1}}&limit={{.Limit}}{{if .Orphaned}}&orphaned=true{{end}}{{if .Hardlinks}}&hardlink=true{{end}}{{if .Service}}&service={{.Service}}{{end}}{{if .Search}}&search={{.Search}}{{end}}"
                   class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-sm transition">
                    Previous
                </a>
                {{end}}

                {{if lt .Page .TotalPages}}
                <a id="next-page-btn"
                   href="/files?page={{add .Page 1}}&limit={{.Limit}}{{if .Orphaned}}&orphaned=true{{end}}{{if .Hardlinks}}&hardlink=true{{end}}{{if .Service}}&service={{.Service}}{{end}}{{if .Search}}&search={{.Search}}{{end}}"
                   class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-sm transition"
                   hx-get="/files?page={{add .Page 1}}&limit={{.Limit}}{{if .Orphaned}}&orphaned=true{{end}}{{if .Hardlinks}}&hardlink=true{{end}}{{if .Service}}&service={{.Service}}{{end}}{{if .Search}}&search={{.Search}}{{end}}"
                   hx-trigger="revealed"
                   hx-target="#files-table tbody"
                   hx-swap="beforeend"
                   hx-select="tbody tr"
                   hx-disabled>
                    Next
                </a>
                {{end}}
            </div>
        </div>
        {{end}}
    </div>

    <script>
    // Infinite scroll toggle
    const infiniteScrollToggle = document.getElementById('infinite-scroll-toggle');
    const nextPageBtn = document.getElementById('next-page-btn');

    if (infiniteScrollToggle && nextPageBtn) {
        infiniteScrollToggle.addEventListener('change', function() {
            if (this.checked) {
                // Enable infinite scroll
                nextPageBtn.removeAttribute('hx-disabled');
                nextPageBtn.classList.add('hidden');
                document.getElementById('pagination-container').classList.add('border-t-2', 'border-blue-500');
            } else {
                // Disable infinite scroll
                nextPageBtn.setAttribute('hx-disabled', '');
                nextPageBtn.classList.remove('hidden');
                document.getElementById('pagination-container').classList.remove('border-t-2', 'border-blue-500');
            }
        });
    }
    </script>

    <!-- Export and Bulk Actions -->
    <div class="bg-gray-800 rounded-lg p-6">
        <h3 class="text-lg font-semibold mb-4">Actions</h3>

        <div class="space-y-4">
            <!-- Export -->
            <div>
                <h4 class="text-sm font-medium text-gray-400 mb-2">Export</h4>
                <div class="flex space-x-4">
                    <a href="/api/export?format=json{{if .Orphaned}}&orphaned=true{{end}}"
                       class="inline-block px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded transition"
                       download>
                        Export as JSON
                    </a>
                    <a href="/api/export?format=csv{{if .Orphaned}}&orphaned=true{{end}}"
                       class="inline-block px-4 py-2 bg-green-600 hover:bg-green-700 rounded transition"
                       download>
                        Export as CSV
                    </a>
                </div>
            </div>

            <!-- Bulk Actions -->
            {{if .Orphaned}}
            <div>
                <h4 class="text-sm font-medium text-gray-400 mb-2">Bulk Actions on Orphaned Files</h4>
                <div class="flex space-x-4">
                    <button
                        hx-post="/api/files/mark-rescan?orphaned=true"
                        hx-confirm="Mark all {{.Total}} orphaned files for rescan?"
                        class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded transition">
                        Mark All for Rescan
                    </button>
                    <button
                        hx-delete="/api/files/delete?orphaned=true"
                        hx-confirm="Are you ABSOLUTELY SURE you want to delete ALL {{.Total}} orphaned files? This CANNOT be undone!"
                        class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded transition">
                        Delete All Orphaned
                    </button>
                </div>
            </div>
            {{end}}
        </div>
    </div>
</div>
{{end}}

