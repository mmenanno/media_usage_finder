{{template "layout.html" .}}

{{define "content"}}
<!-- Expose config settings to JavaScript via data attribute -->
<div id="app-config" data-delete-files-from-filesystem="{{.DeleteFilesFromFilesystem}}" style="display:none;"></div>
<script>
    (function() {
        var configEl = document.getElementById('app-config');
        window.appConfig = window.appConfig || {};
        window.appConfig.deleteFilesFromFilesystem = configEl.getAttribute('data-delete-files-from-filesystem') === 'true';
    })();
</script>

<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h2 class="text-3xl font-bold">Files</h2>
        <div class="text-gray-400">
            Total: {{formatNumber .Total}} files
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="bg-gray-800 rounded-lg p-6">
        <form hx-get="/files" hx-target="#files-table" hx-select="#files-table" hx-push-url="true" class="space-y-4" autocomplete="off">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Search -->
                <div class="md:col-span-3">
                    <label for="search-input" class="block text-sm font-medium text-gray-400 mb-2">Search Files</label>
                    <div class="relative">
                        <input
                            type="text"
                            name="search"
                            id="search-input"
                            value="{{.Search}}"
                            placeholder="Search by path..."
                            autocomplete="off"
                            autocorrect="off"
                            autocapitalize="off"
                            spellcheck="false"
                            hx-get="/files"
                            hx-trigger="keyup changed delay:500ms, search"
                            hx-target="#files-table"
                            hx-include="[name='services'], [name='service_filter_mode'], [name='orphaned'], [name='extensions'], [name='devices'], [name='limit'], [name='order'], [name='direction']"
                            class="w-full px-4 py-2 pr-10 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500">
                        <div id="search-spinner" class="absolute right-3 top-1/2 transform -translate-y-1/2 hidden">
                            <svg class="animate-spin h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                    </div>
                    {{if .Search}}
                    <p class="text-xs text-gray-500 mt-1">
                        Showing results for "{{.Search}}"
                        <a href="/files" class="text-blue-400 hover:text-blue-300 ml-2">Clear</a>
                    </p>
                    {{end}}
                </div>

                <!-- Service Filter -->
                <div>
                    <span class="block text-sm font-medium text-gray-400 mb-2">Services</span>
                    <div class="relative z-30" data-service-multiselect>
                        <input type="hidden" name="services" value="{{range $i, $svc := .Services}}{{if $i}},{{end}}{{$svc}}{{end}}" data-services-input>
                        <input type="hidden" name="service_filter_mode" value="{{.ServiceFilterMode}}" data-service-mode-input>
                        <button
                            type="button"
                            data-services-button
                            aria-expanded="false"
                            class="w-full px-4 py-2 pr-10 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 text-gray-100 text-left">
                            <span data-services-text>{{if .Services}}{{len .Services}} {{pluralize (len .Services) "service" "services"}}{{else}}All Services{{end}}</span>
                            <svg class="w-4 h-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div data-services-menu class="hidden absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg max-h-80 overflow-auto">
                            <!-- Filter Mode Selection -->
                            <div class="px-4 py-3 border-b border-gray-600">
                                <div class="text-xs font-medium text-gray-400 mb-2">Filter Mode:</div>
                                <div class="space-y-1">
                                    <label class="flex items-center space-x-2 text-sm">
                                        <input type="radio" name="service_filter_mode_radio" value="any" {{if or (not .ServiceFilterMode) (eq .ServiceFilterMode "any")}}checked{{end}} class="service-mode-radio w-3 h-3">
                                        <span class="text-gray-300">Any of selected</span>
                                    </label>
                                    <label class="flex items-center space-x-2 text-sm">
                                        <input type="radio" name="service_filter_mode_radio" value="all" {{if eq .ServiceFilterMode "all"}}checked{{end}} class="service-mode-radio w-3 h-3">
                                        <span class="text-gray-300">All of selected</span>
                                    </label>
                                    <label class="flex items-center space-x-2 text-sm">
                                        <input type="radio" name="service_filter_mode_radio" value="exact" {{if eq .ServiceFilterMode "exact"}}checked{{end}} class="service-mode-radio w-3 h-3">
                                        <span class="text-gray-300">Only selected (exact)</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Service Checkboxes -->
                            <div class="px-4 py-2 border-b border-gray-600">
                                <div class="flex items-center space-x-2">
                                    <input
                                        type="checkbox"
                                        data-select-all-services
                                        class="w-4 h-4 bg-gray-700 border-gray-600 rounded">
                                    <label class="text-sm font-medium text-gray-300">Select All</label>
                                </div>
                            </div>
                            <div data-services-list>
                                {{$selectedServices := .Services}}
                                <label class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-600">
                                    <input
                                        type="checkbox"
                                        value="plex"
                                        {{range $selectedServices}}{{if eq . "plex"}}checked{{end}}{{end}}
                                        class="service-checkbox w-4 h-4 bg-gray-700 border-gray-600 rounded">
                                    <span class="text-gray-100">Plex</span>
                                </label>
                                <label class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-600">
                                    <input
                                        type="checkbox"
                                        value="sonarr"
                                        {{range $selectedServices}}{{if eq . "sonarr"}}checked{{end}}{{end}}
                                        class="service-checkbox w-4 h-4 bg-gray-700 border-gray-600 rounded">
                                    <span class="text-gray-100">Sonarr</span>
                                </label>
                                <label class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-600">
                                    <input
                                        type="checkbox"
                                        value="radarr"
                                        {{range $selectedServices}}{{if eq . "radarr"}}checked{{end}}{{end}}
                                        class="service-checkbox w-4 h-4 bg-gray-700 border-gray-600 rounded">
                                    <span class="text-gray-100">Radarr</span>
                                </label>
                                <label class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-600">
                                    <input
                                        type="checkbox"
                                        value="qbittorrent"
                                        {{range $selectedServices}}{{if eq . "qbittorrent"}}checked{{end}}{{end}}
                                        class="service-checkbox w-4 h-4 bg-gray-700 border-gray-600 rounded">
                                    <span class="text-gray-100">qBittorrent</span>
                                </label>
                                <label class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-600">
                                    <input
                                        type="checkbox"
                                        value="stash"
                                        {{range $selectedServices}}{{if eq . "stash"}}checked{{end}}{{end}}
                                        class="service-checkbox w-4 h-4 bg-gray-700 border-gray-600 rounded">
                                    <span class="text-gray-100">Stash</span>
                                </label>
                                <label class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-600">
                                    <input
                                        type="checkbox"
                                        value="calibre"
                                        {{range $selectedServices}}{{if eq . "calibre"}}checked{{end}}{{end}}
                                        class="service-checkbox w-4 h-4 bg-gray-700 border-gray-600 rounded">
                                    <span class="text-gray-100">Calibre</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Device/Disk Filter -->
                {{if .HasDiskLocations}}
                <div>
                    <span class="block text-sm font-medium text-gray-400 mb-2">Device/Disk</span>
                    <div class="relative z-20" data-device-multiselect>
                        <input type="hidden" name="devices" value="{{range $i, $dev := .Devices}}{{if $i}},{{end}}{{$dev}}{{end}}" data-devices-input>
                        <button
                            type="button"
                            data-devices-button
                            aria-expanded="false"
                            class="w-full px-4 py-2 pr-10 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 text-gray-100 text-left">
                            <span data-devices-text>{{if .Devices}}{{len .Devices}} {{pluralize (len .Devices) "device" "devices"}}{{else}}All Devices{{end}}</span>
                            <svg class="w-4 h-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div data-devices-menu class="hidden absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg max-h-60 overflow-auto">
                            <div class="px-4 py-2 border-b border-gray-600">
                                <div class="flex items-center space-x-2">
                                    <input
                                        type="checkbox"
                                        data-select-all-devices
                                        class="w-4 h-4 bg-gray-700 border-gray-600 rounded">
                                    <label class="text-sm font-medium text-gray-300">Select All</label>
                                </div>
                            </div>
                            <div data-devices-list>
                                {{$selectedDevices := .Devices}}
                                {{range $disk := .AvailableDisks}}
                                <label class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-600">
                                    <input
                                        type="checkbox"
                                        value="{{$disk.Name}}"
                                        {{range $selectedDevices}}{{if eq . $disk.Name}}checked{{end}}{{end}}
                                        class="device-checkbox w-4 h-4 bg-gray-700 border-gray-600 rounded">
                                    <span class="text-gray-100">{{$disk.Name}}</span>
                                </label>
                                {{end}}
                            </div>
                        </div>
                    </div>
                </div>
                {{end}}

                <!-- Extension Filter -->
                <div>
                    <span class="block text-sm font-medium text-gray-400 mb-2">File Extensions</span>
                    <div class="relative z-10" data-extension-multiselect>
                        <input type="hidden" name="extensions" value="{{range $i, $ext := .Extensions}}{{if $i}},{{end}}{{$ext}}{{end}}" data-extensions-input>
                        <button
                            type="button"
                            data-extensions-button
                            aria-expanded="false"
                            class="w-full px-4 py-2 pr-10 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 text-gray-100 text-left">
                            <span data-extensions-text>{{if .Extensions}}{{len .Extensions}} {{pluralize (len .Extensions) "extension" "extensions"}}{{else}}All Extensions{{end}}</span>
                            <svg class="w-4 h-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div data-extensions-menu class="hidden absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg max-h-60 overflow-auto">
                            <div class="px-4 py-2 border-b border-gray-600">
                                <div class="flex items-center space-x-2">
                                    <input
                                        type="checkbox"
                                        data-select-all-extensions
                                        class="w-4 h-4 bg-gray-700 border-gray-600 rounded">
                                    <label class="text-sm font-medium text-gray-300">Select All</label>
                                </div>
                            </div>
                            <div data-extensions-list class="text-gray-400 text-sm px-4 py-2">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Orphaned Filter -->
            <div class="flex items-center">
                <label class="flex items-center space-x-2">
                    <input
                        type="checkbox"
                        name="orphaned"
                        value="true"
                        {{if .Orphaned}}checked{{end}}
                        class="w-4 h-4 bg-gray-700 border-gray-600 rounded focus:ring-2 focus:ring-blue-500">
                    <span class="text-sm text-gray-300">Show only orphaned files</span>
                </label>
            </div>

            <div class="flex justify-between items-center">
                <div class="flex space-x-2">
                    <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded transition flex items-center gap-2">
                        <span id="apply-filters-icon"></span>
                        <span>Apply Filters</span>
                    </button>
                    <a href="/files" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded transition flex items-center gap-2 no-underline">
                        <span id="clear-filters-icon"></span>
                        <span>Clear</span>
                    </a>
                </div>

                <!-- Page Size -->
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-400">Per page:</span>
                        <div class="relative z-10" data-custom-dropdown>
                            <input type="hidden" name="limit" value="{{.Limit}}" data-dropdown-input>
                            <button
                                type="button"
                                data-dropdown-button
                                aria-expanded="false"
                                class="pl-3 pr-8 py-1 bg-gray-700 border border-gray-600 rounded text-sm focus:outline-none focus:border-blue-500 text-gray-100 text-left w-24">
                                <span data-dropdown-text>{{.Limit}}</span>
                                <svg class="w-3 h-3 absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div data-dropdown-menu class="hidden absolute z-10 w-24 mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg max-h-60 overflow-auto right-0">
                                <div data-dropdown-option data-value="25" class="px-3 py-1 text-sm hover:bg-gray-600 text-gray-100 {{if eq .Limit 25}}bg-blue-600{{end}}" aria-selected="{{if eq .Limit 25}}true{{else}}false{{end}}">25</div>
                                <div data-dropdown-option data-value="50" class="px-3 py-1 text-sm hover:bg-gray-600 text-gray-100 {{if eq .Limit 50}}bg-blue-600{{end}}" aria-selected="{{if eq .Limit 50}}true{{else}}false{{end}}">50</div>
                                <div data-dropdown-option data-value="100" class="px-3 py-1 text-sm hover:bg-gray-600 text-gray-100 {{if eq .Limit 100}}bg-blue-600{{end}}" aria-selected="{{if eq .Limit 100}}true{{else}}false{{end}}">100</div>
                                <div data-dropdown-option data-value="500" class="px-3 py-1 text-sm hover:bg-gray-600 text-gray-100 {{if eq .Limit 500}}bg-blue-600{{end}}" aria-selected="{{if eq .Limit 500}}true{{else}}false{{end}}">500</div>
                            </div>
                        </div>
                    </div>
                    <label class="flex items-center space-x-2">
                        <input
                            type="checkbox"
                            name="infinite_scroll"
                            id="infinite-scroll-toggle"
                            value="true"
                            class="w-4 h-4 bg-gray-700 border-gray-600 rounded focus:ring-2 focus:ring-blue-500">
                        <span class="text-sm text-gray-400">Infinite Scroll</span>
                    </label>
                </div>
            </div>
        </form>
    </div>

    <!-- Files Table -->
    <div id="files-table" class="bg-gray-800 rounded-lg overflow-hidden" role="region" aria-label="Files list">
        <div class="overflow-x-auto scrollbar-thin">
            <table class="w-full" role="table" aria-label="Media files">
                <thead class="bg-gray-700">
                    <tr role="row">
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                            {{if and (eq .OrderBy "path") (eq .Direction "asc")}}
                            <a href="/files?order=path&direction=desc&limit={{.Limit}}{{if .Orphaned}}&orphaned=true{{end}}{{if .Hardlinks}}&hardlink=true{{end}}{{if .Services}}&services={{range $i, $svc := .Services}}{{if $i}},{{end}}{{$svc}}{{end}}{{end}}{{if .ServiceFilterMode}}&service_filter_mode={{.ServiceFilterMode}}{{end}}{{if .Extensions}}&extensions={{range $i, $ext := .Extensions}}{{if $i}},{{end}}{{$ext}}{{end}}{{end}}{{if .Devices}}&devices={{range $i, $dev := .Devices}}{{if $i}},{{end}}{{$dev}}{{end}}{{end}}{{if .Search}}&search={{.Search}}{{end}}"
                               class="inline-block hover:text-gray-200"
                               aria-label="Sort by path descending">
                                Path ↑
                            </a>
                            {{else if and (eq .OrderBy "path") (eq .Direction "desc")}}
                            <a href="/files?order=path&direction=asc&limit={{.Limit}}{{if .Orphaned}}&orphaned=true{{end}}{{if .Hardlinks}}&hardlink=true{{end}}{{if .Services}}&services={{range $i, $svc := .Services}}{{if $i}},{{end}}{{$svc}}{{end}}{{end}}{{if .ServiceFilterMode}}&service_filter_mode={{.ServiceFilterMode}}{{end}}{{if .Extensions}}&extensions={{range $i, $ext := .Extensions}}{{if $i}},{{end}}{{$ext}}{{end}}{{end}}{{if .Devices}}&devices={{range $i, $dev := .Devices}}{{if $i}},{{end}}{{$dev}}{{end}}{{end}}{{if .Search}}&search={{.Search}}{{end}}"
                               class="inline-block hover:text-gray-200"
                               aria-label="Sort by path ascending">
                                Path ↓
                            </a>
                            {{else}}
                            <a href="/files?order=path&direction=asc&limit={{.Limit}}{{if .Orphaned}}&orphaned=true{{end}}{{if .Hardlinks}}&hardlink=true{{end}}{{if .Services}}&services={{range $i, $svc := .Services}}{{if $i}},{{end}}{{$svc}}{{end}}{{end}}{{if .ServiceFilterMode}}&service_filter_mode={{.ServiceFilterMode}}{{end}}{{if .Extensions}}&extensions={{range $i, $ext := .Extensions}}{{if $i}},{{end}}{{$ext}}{{end}}{{end}}{{if .Devices}}&devices={{range $i, $dev := .Devices}}{{if $i}},{{end}}{{$dev}}{{end}}{{end}}{{if .Search}}&search={{.Search}}{{end}}"
                               class="inline-block hover:text-gray-200"
                               aria-label="Sort by path">
                                Path
                            </a>
                            {{end}}
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                            {{if and (eq .OrderBy "size") (eq .Direction "asc")}}
                            <a href="/files?order=size&direction=desc&limit={{.Limit}}{{if .Orphaned}}&orphaned=true{{end}}{{if .Hardlinks}}&hardlink=true{{end}}{{if .Services}}&services={{range $i, $svc := .Services}}{{if $i}},{{end}}{{$svc}}{{end}}{{end}}{{if .ServiceFilterMode}}&service_filter_mode={{.ServiceFilterMode}}{{end}}{{if .Extensions}}&extensions={{range $i, $ext := .Extensions}}{{if $i}},{{end}}{{$ext}}{{end}}{{end}}{{if .Devices}}&devices={{range $i, $dev := .Devices}}{{if $i}},{{end}}{{$dev}}{{end}}{{end}}{{if .Search}}&search={{.Search}}{{end}}"
                               class="inline-block hover:text-gray-200"
                               aria-label="Sort by size descending">
                                Size ↑
                            </a>
                            {{else if and (eq .OrderBy "size") (eq .Direction "desc")}}
                            <a href="/files?order=size&direction=asc&limit={{.Limit}}{{if .Orphaned}}&orphaned=true{{end}}{{if .Hardlinks}}&hardlink=true{{end}}{{if .Services}}&services={{range $i, $svc := .Services}}{{if $i}},{{end}}{{$svc}}{{end}}{{end}}{{if .ServiceFilterMode}}&service_filter_mode={{.ServiceFilterMode}}{{end}}{{if .Extensions}}&extensions={{range $i, $ext := .Extensions}}{{if $i}},{{end}}{{$ext}}{{end}}{{end}}{{if .Devices}}&devices={{range $i, $dev := .Devices}}{{if $i}},{{end}}{{$dev}}{{end}}{{end}}{{if .Search}}&search={{.Search}}{{end}}"
                               class="inline-block hover:text-gray-200"
                               aria-label="Sort by size ascending">
                                Size ↓
                            </a>
                            {{else}}
                            <a href="/files?order=size&direction=desc&limit={{.Limit}}{{if .Orphaned}}&orphaned=true{{end}}{{if .Hardlinks}}&hardlink=true{{end}}{{if .Services}}&services={{range $i, $svc := .Services}}{{if $i}},{{end}}{{$svc}}{{end}}{{end}}{{if .ServiceFilterMode}}&service_filter_mode={{.ServiceFilterMode}}{{end}}{{if .Extensions}}&extensions={{range $i, $ext := .Extensions}}{{if $i}},{{end}}{{$ext}}{{end}}{{end}}{{if .Devices}}&devices={{range $i, $dev := .Devices}}{{if $i}},{{end}}{{$dev}}{{end}}{{end}}{{if .Search}}&search={{.Search}}{{end}}"
                               class="inline-block hover:text-gray-200"
                               aria-label="Sort by size">
                                Size
                            </a>
                            {{end}}
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Services</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-700">
                    {{range .Files}}
                    <tr class="hover:bg-gray-750 transition">
                        <td class="px-6 py-4 text-sm text-gray-300 font-mono break-all max-w-md">
                            <div class="truncate sm:whitespace-normal" title="{{.File.Path}}">
                                {{.File.Path}}
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-400 whitespace-nowrap">
                            {{formatSize .File.Size}}
                        </td>
                        <td class="px-6 py-4 text-sm">
                            {{if .Usage}}
                                <div class="flex flex-wrap gap-1">
                                    {{range .Usage}}
                                    <span class="px-2 py-1 {{serviceClass .Service "bg"}} {{serviceClass .Service "text-on-bg"}} rounded text-xs">{{formatServiceName .Service}}</span>
                                    {{end}}
                                </div>
                            {{else}}
                                <span class="text-gray-500">None</span>
                            {{end}}
                        </td>
                        <td class="px-6 py-4 text-sm whitespace-nowrap">
                            {{if .File.IsOrphaned}}
                                <span class="px-2 py-1 bg-yellow-600 rounded text-xs">Orphaned</span>
                            {{else}}
                                <span class="px-2 py-1 bg-green-600 rounded text-xs">In Use</span>
                            {{end}}
                        </td>
                        <td class="px-6 py-4 text-sm">
                            <div class="flex flex-col sm:flex-row sm:space-x-2 space-y-1 sm:space-y-0">
                                <button
                                    data-file-id="{{.File.ID}}"
                                    data-action="show-details"
                                    aria-label="View file details"
                                    class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-sm transition whitespace-nowrap flex items-center gap-1.5">
                                    <span class="file-details-icon"></span>
                                    <span>Details</span>
                                </button>
                                <button
                                    hx-post="/api/files/rescan?id={{.File.ID}}"
                                    hx-swap="none"
                                    aria-label="Rescan file now"
                                    class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm transition whitespace-nowrap flex items-center gap-1.5">
                                    <span class="file-rescan-icon"></span>
                                    <span>Rescan</span>
                                </button>
                                <button
                                    hx-delete="/api/files/delete?id={{.File.ID}}"
                                    {{if .DeleteFilesFromFilesystem}}
                                    hx-confirm="⚠️  WARNING: Permanently delete this file from the filesystem?\n\nThis will remove the actual file from disk and CANNOT be undone."
                                    {{else}}
                                    hx-confirm="Remove this file from the database?\n\nThe actual file will remain on disk."
                                    {{end}}
                                    hx-target="closest tr"
                                    hx-swap="delete"
                                    aria-label="Delete file"
                                    class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm transition whitespace-nowrap flex items-center gap-1.5">
                                    <span class="file-delete-icon"></span>
                                    <span>{{if .DeleteFilesFromFilesystem}}Delete{{else}}Remove{{end}}</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {{else}}
                    <tr>
                        <td colspan="6" class="px-6 py-16">
                            <div class="flex flex-col items-center justify-center text-center space-y-4">
                                <svg class="w-16 h-16 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                {{if .Search}}
                                    <div class="space-y-2">
                                        <p class="text-lg font-medium text-gray-400">No files match your search</p>
                                        <p class="text-sm text-gray-500">Try adjusting your search terms or filters</p>
                                    </div>
                                {{else if .Orphaned}}
                                    <div class="space-y-2">
                                        <p class="text-lg font-medium text-gray-400">No orphaned files found</p>
                                        <p class="text-sm text-gray-500">All your files are being tracked by at least one service!</p>
                                    </div>
                                {{else if .Services}}
                                    <div class="space-y-2">
                                        <p class="text-lg font-medium text-gray-400">No files found for selected services</p>
                                        <p class="text-sm text-gray-500">{{if eq (len .Services) 1}}This service hasn't indexed any files yet{{else}}No files match the selected service filter{{end}}</p>
                                    </div>
                                {{else}}
                                    <div class="space-y-3">
                                        <p class="text-lg font-medium text-gray-400">No files found</p>
                                        <p class="text-sm text-gray-500">Start a scan to discover and track your media files</p>
                                        <button
                                            hx-post="/api/scan/start"
                                            hx-confirm="Start a new scan? This may take a while for large libraries."
                                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition inline-flex items-center space-x-2">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                            </svg>
                                            <span>Start Scan</span>
                                        </button>
                                    </div>
                                {{end}}
                            </div>
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>

        <!-- Pagination / Infinite Scroll Trigger -->
        {{if gt .TotalPages 1}}
        <div id="pagination-container" class="bg-gray-700 px-6 py-4 flex items-center justify-between">
            <div class="text-sm text-gray-400">
                <span id="current-page-display">Page {{.Page}} of {{.TotalPages}}</span>
            </div>
            <div class="flex space-x-2">
                {{if gt .Page 1}}
                <a href="/files?page={{sub .Page 1}}&limit={{.Limit}}{{if .Orphaned}}&orphaned=true{{end}}{{if .Hardlinks}}&hardlink=true{{end}}{{if .Services}}&services={{range $i, $svc := .Services}}{{if $i}},{{end}}{{$svc}}{{end}}{{end}}{{if .ServiceFilterMode}}&service_filter_mode={{.ServiceFilterMode}}{{end}}{{if .Extensions}}&extensions={{range $i, $ext := .Extensions}}{{if $i}},{{end}}{{$ext}}{{end}}{{end}}{{if .Search}}&search={{.Search}}{{end}}{{if .OrderBy}}&order={{.OrderBy}}{{end}}{{if .Direction}}&direction={{.Direction}}{{end}}"
                   class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-sm transition no-underline">
                    Previous
                </a>
                {{end}}

                {{if lt .Page .TotalPages}}
                <a id="next-page-btn"
                   href="/files?page={{add .Page 1}}&limit={{.Limit}}{{if .Orphaned}}&orphaned=true{{end}}{{if .Hardlinks}}&hardlink=true{{end}}{{if .Services}}&services={{range $i, $svc := .Services}}{{if $i}},{{end}}{{$svc}}{{end}}{{end}}{{if .ServiceFilterMode}}&service_filter_mode={{.ServiceFilterMode}}{{end}}{{if .Extensions}}&extensions={{range $i, $ext := .Extensions}}{{if $i}},{{end}}{{$ext}}{{end}}{{end}}{{if .Search}}&search={{.Search}}{{end}}{{if .OrderBy}}&order={{.OrderBy}}{{end}}{{if .Direction}}&direction={{.Direction}}{{end}}"
                   class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-sm transition no-underline"
                   data-next-url="/files?page={{add .Page 1}}&limit={{.Limit}}{{if .Orphaned}}&orphaned=true{{end}}{{if .Hardlinks}}&hardlink=true{{end}}{{if .Services}}&services={{range $i, $svc := .Services}}{{if $i}},{{end}}{{$svc}}{{end}}{{end}}{{if .ServiceFilterMode}}&service_filter_mode={{.ServiceFilterMode}}{{end}}{{if .Extensions}}&extensions={{range $i, $ext := .Extensions}}{{if $i}},{{end}}{{$ext}}{{end}}{{end}}{{if .Search}}&search={{.Search}}{{end}}{{if .OrderBy}}&order={{.OrderBy}}{{end}}{{if .Direction}}&direction={{.Direction}}{{end}}"
                   data-current-page="{{.Page}}"
                   data-total-pages="{{.TotalPages}}">
                    Next
                </a>
                <div id="infinite-scroll-loading" class="hidden px-3 py-1 text-sm text-gray-400">
                    <svg class="animate-spin h-4 w-4 inline-block mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Loading more...
                </div>
                {{end}}
            </div>
        </div>
        <!-- Infinite scroll sentinel (invisible trigger point) -->
        <div id="infinite-scroll-sentinel"
             class="h-1"
             data-next-url="/files?page={{add .Page 1}}&limit={{.Limit}}{{if .Orphaned}}&orphaned=true{{end}}{{if .Hardlinks}}&hardlink=true{{end}}{{if .Services}}&services={{range $i, $svc := .Services}}{{if $i}},{{end}}{{$svc}}{{end}}{{end}}{{if .ServiceFilterMode}}&service_filter_mode={{.ServiceFilterMode}}{{end}}{{if .Extensions}}&extensions={{range $i, $ext := .Extensions}}{{if $i}},{{end}}{{$ext}}{{end}}{{end}}{{if .Search}}&search={{.Search}}{{end}}{{if .OrderBy}}&order={{.OrderBy}}{{end}}{{if .Direction}}&direction={{.Direction}}{{end}}"
             data-current-page="{{.Page}}"
             data-total-pages="{{.TotalPages}}"
             style="display: none;">
        </div>
        {{end}}
    </div>

    <script>
    // ============================================================================
    // INFINITE SCROLL IMPLEMENTATION
    // ============================================================================

    (function() {
        const infiniteScrollToggle = document.getElementById('infinite-scroll-toggle');
        const nextPageBtn = document.getElementById('next-page-btn');
        const sentinel = document.getElementById('infinite-scroll-sentinel');
        const loadingIndicator = document.getElementById('infinite-scroll-loading');
        const paginationContainer = document.getElementById('pagination-container');
        const currentPageDisplay = document.getElementById('current-page-display');

        if (!infiniteScrollToggle || !nextPageBtn || !sentinel) {
            return;
        }

        // State management
        let isEnabled = false;
        let isLoading = false;
        let currentPage = parseInt(nextPageBtn.getAttribute('data-current-page') || '1');
        let totalPages = parseInt(nextPageBtn.getAttribute('data-total-pages') || '1');
        let observer = null;

        // Function to update the page display
        function updatePageDisplay() {
            if (currentPageDisplay) {
                currentPageDisplay.textContent = `Page 1-${currentPage} of ${totalPages}`;
            }
        }

        // Function to load next page
        async function loadNextPage() {
            if (isLoading || currentPage >= totalPages) {
                return;
            }

            isLoading = true;
            const nextPage = currentPage + 1;
            const nextUrl = sentinel.getAttribute('data-next-url');

            // Show loading indicator
            if (loadingIndicator) {
                loadingIndicator.classList.remove('hidden');
            }
            if (nextPageBtn) {
                nextPageBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }

            try {
                const response = await fetch(nextUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newRows = doc.querySelectorAll('#files-table tbody > tr');

                if (newRows.length === 0) {
                    disableInfiniteScroll();
                    return;
                }

                const tbody = document.querySelector('#files-table tbody');
                if (!tbody) return;

                const clonedRows = [];
                newRows.forEach(row => {
                    const clonedRow = row.cloneNode(true);
                    tbody.appendChild(clonedRow);
                    clonedRows.push(clonedRow);
                });

                // Add batch selection checkboxes to new rows
                if (window.batchSelection) {
                    window.batchSelection.addRowCheckboxes();
                }

                // Re-process HTMX attributes on new rows
                if (window.htmx) {
                    clonedRows.forEach(row => htmx.process(row));
                }

                // Re-inject icons for new rows
                if (window.injectFileIcons) {
                    window.injectFileIcons();
                }

                // Update current page
                currentPage = nextPage;
                updatePageDisplay();

                // Update URL for next page if there are more pages
                if (currentPage < totalPages) {
                    const currentUrl = new URL(nextUrl, window.location.origin);
                    currentUrl.searchParams.set('page', currentPage + 1);
                    const newNextUrl = currentUrl.pathname + currentUrl.search;

                    sentinel.setAttribute('data-next-url', newNextUrl);
                    sentinel.setAttribute('data-current-page', currentPage);

                    if (nextPageBtn) {
                        nextPageBtn.setAttribute('data-next-url', newNextUrl);
                        nextPageBtn.setAttribute('data-current-page', currentPage);
                        nextPageBtn.setAttribute('href', newNextUrl);
                    }
                } else {
                    disableInfiniteScroll();
                }
            } catch (error) {
                console.error('Infinite scroll error:', error);
            } finally {
                isLoading = false;

                if (loadingIndicator) {
                    loadingIndicator.classList.add('hidden');
                }
                if (nextPageBtn) {
                    nextPageBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
        }

        // Function to enable infinite scroll
        function enableInfiniteScroll() {
            if (isEnabled) return;

            isEnabled = true;

            if (nextPageBtn) {
                nextPageBtn.classList.add('hidden');
            }

            if (paginationContainer) {
                paginationContainer.classList.add('border-t-2', 'border-blue-500');
            }

            if (sentinel) {
                sentinel.style.display = 'block';

                observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting && isEnabled && !isLoading) {
                            loadNextPage();
                        }
                    });
                }, {
                    root: null,
                    rootMargin: '100px',
                    threshold: 0.01
                });

                observer.observe(sentinel);
            }
        }

        // Function to disable infinite scroll
        function disableInfiniteScroll() {
            if (!isEnabled) return;

            isEnabled = false;

            if (nextPageBtn) {
                nextPageBtn.classList.remove('hidden');
            }

            if (paginationContainer) {
                paginationContainer.classList.remove('border-t-2', 'border-blue-500');
            }

            if (sentinel) {
                sentinel.style.display = 'none';
            }

            if (observer) {
                observer.disconnect();
                observer = null;
            }
        }

        // Toggle event handler
        infiniteScrollToggle.addEventListener('change', function() {
            if (this.checked) {
                enableInfiniteScroll();
            } else {
                disableInfiniteScroll();
            }
        });

        // Initialize based on checkbox state
        if (infiniteScrollToggle.checked) {
            enableInfiniteScroll();
        }
    })();

    // Extension multiselect functionality
    const extensionMultiselect = document.querySelector('[data-extension-multiselect]');
    if (extensionMultiselect) {
        const button = extensionMultiselect.querySelector('[data-extensions-button]');
        const menu = extensionMultiselect.querySelector('[data-extensions-menu]');
        const input = extensionMultiselect.querySelector('[data-extensions-input]');
        const textSpan = extensionMultiselect.querySelector('[data-extensions-text]');
        const extensionsList = extensionMultiselect.querySelector('[data-extensions-list]');
        const selectAllCheckbox = extensionMultiselect.querySelector('[data-select-all-extensions]');

        let availableExtensions = [];
        let selectedExtensions = new Set();

        // Parse initial selected extensions from hidden input
        if (input.value) {
            input.value.split(',').forEach(ext => {
                if (ext.trim()) selectedExtensions.add(ext.trim());
            });
        }

        // Toggle dropdown
        button.addEventListener('click', function() {
            const isOpen = menu.classList.contains('hidden');
            menu.classList.toggle('hidden');
            button.setAttribute('aria-expanded', isOpen ? 'true' : 'false');

            // Load extensions on first open
            if (isOpen && availableExtensions.length === 0) {
                loadExtensions();
            }
        });

        // Close on click outside
        document.addEventListener('click', function(e) {
            if (!extensionMultiselect.contains(e.target)) {
                menu.classList.add('hidden');
                button.setAttribute('aria-expanded', 'false');
            }
        });

        // Load extensions from API
        function loadExtensions() {
            extensionsList.innerHTML = '<div class="text-gray-400 text-sm">Loading...</div>';

            fetch('/api/files/extensions')
                .then(response => {
                    console.log('Extensions API response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Extensions API data:', data);
                    availableExtensions = data.extensions || [];
                    console.log('Available extensions:', availableExtensions);
                    renderExtensions();
                })
                .catch(error => {
                    console.error('Failed to load extensions:', error);
                    extensionsList.innerHTML = '<div class="text-red-400 text-sm px-4 py-2">Failed to load extensions</div>';
                });
        }

        // Render extension checkboxes
        function renderExtensions() {
            console.log('Rendering extensions, count:', availableExtensions.length);
            if (availableExtensions.length === 0) {
                extensionsList.innerHTML = '<div class="text-gray-400 text-sm px-4 py-2">No extensions found. Files may not have been scanned yet.</div>';
                return;
            }

            extensionsList.innerHTML = availableExtensions.map(ext => `
                <label class="flex items-center space-x-2 px-4 py-2 hover:bg-gray-600">
                    <input
                        type="checkbox"
                        value="${ext}"
                        ${selectedExtensions.has(ext) ? 'checked' : ''}
                        class="extension-checkbox w-4 h-4 bg-gray-700 border-gray-600 rounded">
                    <span class="text-gray-100">.${ext}</span>
                </label>
            `).join('');

            // Add event listeners to checkboxes
            extensionsList.querySelectorAll('.extension-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', handleExtensionChange);
            });

            updateSelectAllState();
        }

        // Handle individual checkbox change
        function handleExtensionChange(e) {
            const ext = e.target.value;
            if (e.target.checked) {
                selectedExtensions.add(ext);
            } else {
                selectedExtensions.delete(ext);
            }
            updateHiddenInput();
            updateSelectAllState();
        }

        // Handle select all checkbox
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function(e) {
                const checkboxes = extensionsList.querySelectorAll('.extension-checkbox');
                checkboxes.forEach(cb => {
                    cb.checked = e.target.checked;
                    if (e.target.checked) {
                        selectedExtensions.add(cb.value);
                    } else {
                        selectedExtensions.delete(cb.value);
                    }
                });
                updateHiddenInput();
            });
        }

        // Update select all checkbox state
        function updateSelectAllState() {
            if (!selectAllCheckbox) return;
            const checkboxes = extensionsList.querySelectorAll('.extension-checkbox');
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            selectAllCheckbox.checked = checkedCount === checkboxes.length && checkboxes.length > 0;
            selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
        }

        // Update hidden input and button text
        function updateHiddenInput() {
            const values = Array.from(selectedExtensions).join(',');
            input.value = values;

            if (selectedExtensions.size === 0) {
                textSpan.textContent = 'All Extensions';
            } else if (selectedExtensions.size === 1) {
                textSpan.textContent = '1 extension';
            } else {
                textSpan.textContent = `${selectedExtensions.size} extensions`;
            }
        }
    }

    // Service multiselect functionality
    const serviceMultiselect = document.querySelector('[data-service-multiselect]');
    if (serviceMultiselect) {
        const button = serviceMultiselect.querySelector('[data-services-button]');
        const menu = serviceMultiselect.querySelector('[data-services-menu]');
        const servicesInput = serviceMultiselect.querySelector('[data-services-input]');
        const modeInput = serviceMultiselect.querySelector('[data-service-mode-input]');
        const textSpan = serviceMultiselect.querySelector('[data-services-text]');
        const servicesList = serviceMultiselect.querySelector('[data-services-list]');
        const selectAllCheckbox = serviceMultiselect.querySelector('[data-select-all-services]');
        const modeRadios = serviceMultiselect.querySelectorAll('.service-mode-radio');

        let selectedServices = new Set();

        // Parse initial selected services from hidden input
        if (servicesInput.value) {
            servicesInput.value.split(',').forEach(svc => {
                if (svc.trim()) selectedServices.add(svc.trim());
            });
        }

        // Toggle dropdown
        button.addEventListener('click', function() {
            const isOpen = menu.classList.contains('hidden');
            menu.classList.toggle('hidden');
            button.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        });

        // Close on click outside
        document.addEventListener('click', function(e) {
            if (!serviceMultiselect.contains(e.target)) {
                menu.classList.add('hidden');
                button.setAttribute('aria-expanded', 'false');
            }
        });

        // Handle individual checkbox change
        servicesList.querySelectorAll('.service-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function(e) {
                const svc = e.target.value;
                if (e.target.checked) {
                    selectedServices.add(svc);
                } else {
                    selectedServices.delete(svc);
                }
                updateServicesInput();
                updateSelectAllServicesState();
            });
        });

        // Handle select all checkbox
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function(e) {
                const checkboxes = servicesList.querySelectorAll('.service-checkbox');
                checkboxes.forEach(cb => {
                    cb.checked = e.target.checked;
                    if (e.target.checked) {
                        selectedServices.add(cb.value);
                    } else {
                        selectedServices.delete(cb.value);
                    }
                });
                updateServicesInput();
            });
        }

        // Handle mode radio change
        modeRadios.forEach(radio => {
            radio.addEventListener('change', function(e) {
                modeInput.value = e.target.value;
            });
        });

        // Update select all checkbox state
        function updateSelectAllServicesState() {
            if (!selectAllCheckbox) return;
            const checkboxes = servicesList.querySelectorAll('.service-checkbox');
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            selectAllCheckbox.checked = checkedCount === checkboxes.length && checkboxes.length > 0;
            selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
        }

        // Update hidden input and button text
        function updateServicesInput() {
            const values = Array.from(selectedServices).join(',');
            servicesInput.value = values;

            if (selectedServices.size === 0) {
                textSpan.textContent = 'All Services';
            } else if (selectedServices.size === 1) {
                textSpan.textContent = '1 service';
            } else {
                textSpan.textContent = `${selectedServices.size} services`;
            }
        }

        // Initial state
        updateSelectAllServicesState();
    }

    // Device multiselect functionality
    const deviceMultiselect = document.querySelector('[data-device-multiselect]');
    if (deviceMultiselect) {
        const button = deviceMultiselect.querySelector('[data-devices-button]');
        const menu = deviceMultiselect.querySelector('[data-devices-menu]');
        const devicesInput = deviceMultiselect.querySelector('[data-devices-input]');
        const textSpan = deviceMultiselect.querySelector('[data-devices-text]');
        const devicesList = deviceMultiselect.querySelector('[data-devices-list]');
        const selectAllCheckbox = deviceMultiselect.querySelector('[data-select-all-devices]');

        let selectedDevices = new Set();

        // Parse initial selected devices from hidden input
        if (devicesInput.value) {
            devicesInput.value.split(',').forEach(dev => {
                if (dev.trim()) selectedDevices.add(dev.trim());
            });
        }

        // Toggle dropdown
        button.addEventListener('click', function() {
            const isOpen = menu.classList.contains('hidden');
            menu.classList.toggle('hidden');
            button.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        });

        // Close on click outside
        document.addEventListener('click', function(e) {
            if (!deviceMultiselect.contains(e.target)) {
                menu.classList.add('hidden');
                button.setAttribute('aria-expanded', 'false');
            }
        });

        // Handle individual checkbox change
        devicesList.querySelectorAll('.device-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function(e) {
                const dev = e.target.value;
                if (e.target.checked) {
                    selectedDevices.add(dev);
                } else {
                    selectedDevices.delete(dev);
                }
                updateDevicesInput();
                updateSelectAllDevicesState();
            });
        });

        // Handle select all checkbox
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function(e) {
                const checkboxes = devicesList.querySelectorAll('.device-checkbox');
                checkboxes.forEach(cb => {
                    cb.checked = e.target.checked;
                    if (e.target.checked) {
                        selectedDevices.add(cb.value);
                    } else {
                        selectedDevices.delete(cb.value);
                    }
                });
                updateDevicesInput();
            });
        }

        // Update select all checkbox state
        function updateSelectAllDevicesState() {
            if (!selectAllCheckbox) return;
            const checkboxes = devicesList.querySelectorAll('.device-checkbox');
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            selectAllCheckbox.checked = checkedCount === checkboxes.length && checkboxes.length > 0;
            selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
        }

        // Update hidden input and button text
        function updateDevicesInput() {
            const values = Array.from(selectedDevices).join(',');
            devicesInput.value = values;

            if (selectedDevices.size === 0) {
                textSpan.textContent = 'All Devices';
            } else if (selectedDevices.size === 1) {
                textSpan.textContent = '1 device';
            } else {
                textSpan.textContent = `${selectedDevices.size} devices`;
            }
        }

        // Initial state
        updateSelectAllDevicesState();
    }
    </script>

    <!-- Export and Bulk Actions -->
    <div class="bg-gray-800 rounded-lg p-6">
        <h3 class="text-lg font-semibold mb-4">Actions</h3>

        <div class="space-y-4">
            <!-- Export -->
            <div>
                <h4 class="text-sm font-medium text-gray-400 mb-2">Export</h4>
                <div class="flex space-x-4">
                    <a href="/api/export?format=json{{if .Orphaned}}&orphaned=true{{end}}"
                       class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded transition flex items-center gap-2"
                       download>
                        <span id="export-json-icon"></span>
                        <span>Export as JSON</span>
                    </a>
                    <a href="/api/export?format=csv{{if .Orphaned}}&orphaned=true{{end}}"
                       class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded transition flex items-center gap-2"
                       download>
                        <span id="export-csv-icon"></span>
                        <span>Export as CSV</span>
                    </a>
                </div>
            </div>

            <!-- Bulk Actions -->
            {{if .Orphaned}}
            <div>
                <h4 class="text-sm font-medium text-gray-400 mb-2">Bulk Actions on Orphaned Files</h4>
                <div class="flex space-x-4">
                    <button
                        hx-post="/api/files/rescan?orphaned=true"
                        hx-swap="none"
                        hx-confirm="Rescan all {{formatNumber .Total}} orphaned files now?"
                        class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded transition">
                        Rescan All Orphaned
                    </button>
                    <button
                        hx-delete="/api/files/delete?orphaned=true"
                        {{if .DeleteFilesFromFilesystem}}
                        hx-confirm="⚠️  WARNING: You are about to PERMANENTLY DELETE ALL {{formatNumber .Total}} orphaned files from the FILESYSTEM.\n\nThis will remove the actual files from disk and CANNOT BE UNDONE.\n\nAre you absolutely sure?"
                        {{else}}
                        hx-confirm="Remove all {{formatNumber .Total}} orphaned files from the database?\n\nThe actual files will remain on disk. You can re-scan to add them back.\n\nContinue?"
                        {{end}}
                        class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded transition">
                        {{if .DeleteFilesFromFilesystem}}Delete All Orphaned{{else}}Remove All Orphaned{{end}}
                    </button>
                </div>
            </div>
            {{end}}
        </div>
    </div>

    <script>
        // Inject icons from centralized Icons object
        window.injectFileIcons = function() {
            // Filter buttons
            const applyIcon = document.getElementById('apply-filters-icon');
            const clearIcon = document.getElementById('clear-filters-icon');
            if (applyIcon) applyIcon.innerHTML = Icons.get('check', 5);
            if (clearIcon) clearIcon.innerHTML = Icons.get('xCircle', 5);

            // Table row action buttons (inject for all rows)
            const detailsIcons = document.querySelectorAll('.file-details-icon');
            const rescanIcons = document.querySelectorAll('.file-rescan-icon');
            const deleteIcons = document.querySelectorAll('.file-delete-icon');

            detailsIcons.forEach(icon => icon.innerHTML = Icons.get('eye', 4));
            rescanIcons.forEach(icon => icon.innerHTML = Icons.get('refresh', 4));
            deleteIcons.forEach(icon => icon.innerHTML = Icons.get('trash', 4));

            // Export buttons
            const exportJsonIcon = document.getElementById('export-json-icon');
            const exportCsvIcon = document.getElementById('export-csv-icon');
            if (exportJsonIcon) exportJsonIcon.innerHTML = Icons.get('download', 5);
            if (exportCsvIcon) exportCsvIcon.innerHTML = Icons.get('download', 5);
        };

        // Initial icon injection on page load
        document.addEventListener('DOMContentLoaded', window.injectFileIcons);

        // Re-inject icons after HTMX swaps content (for search/filter updates)
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            // Only re-inject if the swap target is the files table
            if (evt.detail.target.id === 'files-table') {
                window.injectFileIcons();
            }
        });
    </script>
</div>
{{end}}

