{{template "layout.html" .}}

{{define "content"}}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h2 class="text-3xl font-bold">Duplicate Files</h2>
        <div class="text-gray-400">
            Total potential savings: <span class="text-blue-400 font-semibold">{{.TotalSavings | formatBytes}}</span>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="bg-gray-800 rounded-lg">
        <div class="flex border-b border-gray-700">
            <button
                data-tab="cross-disk"
                class="tab-button px-6 py-3 text-sm font-medium border-b-2 transition-colors {{if or (not .ActiveTab) (eq .ActiveTab "cross-disk")}}border-blue-500 text-blue-400{{else}}border-transparent text-gray-400 hover:text-gray-300{{end}}"
                onclick="switchTab('cross-disk')">
                Cross-Disk Duplicates
                <span class="ml-2 px-2 py-1 text-xs rounded bg-gray-700">{{.CrossDiskCount}}</span>
            </button>
            <button
                data-tab="same-disk"
                class="tab-button px-6 py-3 text-sm font-medium border-b-2 transition-colors {{if eq .ActiveTab "same-disk"}}border-blue-500 text-blue-400{{else}}border-transparent text-gray-400 hover:text-gray-300{{end}}"
                onclick="switchTab('same-disk')">
                Same-Disk Duplicates
                <span class="ml-2 px-2 py-1 text-xs rounded bg-gray-700">{{.SameDiskCount}}</span>
            </button>
        </div>

        <!-- Cross-Disk Tab Content -->
        <div id="cross-disk-tab" class="tab-content {{if eq .ActiveTab "same-disk"}}hidden{{end}} p-6">
            <div class="space-y-4">
                <!-- Summary Card -->
                <div class="bg-gray-750 rounded-lg p-6 border border-gray-700">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <div class="text-sm text-gray-400">Duplicate Groups</div>
                            <div class="text-2xl font-bold text-gray-100">{{.CrossDiskCount}}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-400">Files to Delete</div>
                            <div class="text-2xl font-bold text-gray-100">{{.CrossDiskFilesToDelete}}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-400">Space to Free</div>
                            <div class="text-2xl font-bold text-green-400">{{.CrossDiskSavings | formatBytes}}</div>
                        </div>
                        <div class="flex items-center">
                            {{if gt .CrossDiskCount 0}}
                            <button
                                onclick="previewConsolidation('cross-disk')"
                                class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium transition-colors">
                                Preview Consolidation
                            </button>
                            {{end}}
                        </div>
                    </div>
                </div>

                <!-- Filter Options -->
                <div class="bg-gray-750 rounded-lg p-4 border border-gray-700">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Hash Type Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Hash Type</label>
                            <div class="relative" data-custom-dropdown>
                                <input type="hidden" id="cross-disk-hash-filter" value="all" data-dropdown-input>
                                <button
                                    type="button"
                                    data-dropdown-button
                                    aria-expanded="false"
                                    class="w-full px-4 py-2 pr-10 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 cursor-pointer text-gray-100 text-left">
                                    <span data-dropdown-text>All Hashes</span>
                                    <svg class="w-4 h-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div data-dropdown-menu class="hidden absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg max-h-60 overflow-auto">
                                    <div data-dropdown-option data-value="all" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 bg-blue-600" aria-selected="true">All Hashes</div>
                                    <div data-dropdown-option data-value="full" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">Full Hash Only ‚úì</div>
                                    <div data-dropdown-option data-value="quick" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">Quick Hash Only ‚ö†Ô∏è</div>
                                </div>
                            </div>
                        </div>
                        <!-- Minimum Savings Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Minimum Savings</label>
                            <div class="relative" data-custom-dropdown>
                                <input type="hidden" id="cross-disk-size-filter" value="0" data-dropdown-input>
                                <button
                                    type="button"
                                    data-dropdown-button
                                    aria-expanded="false"
                                    class="w-full px-4 py-2 pr-10 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 cursor-pointer text-gray-100 text-left">
                                    <span data-dropdown-text>Any Size</span>
                                    <svg class="w-4 h-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div data-dropdown-menu class="hidden absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg max-h-60 overflow-auto">
                                    <div data-dropdown-option data-value="0" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 bg-blue-600" aria-selected="true">Any Size</div>
                                    <div data-dropdown-option data-value="10485760" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">10 MB+</div>
                                    <div data-dropdown-option data-value="104857600" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">100 MB+</div>
                                    <div data-dropdown-option data-value="1073741824" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">1 GB+</div>
                                    <div data-dropdown-option data-value="10737418240" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">10 GB+</div>
                                </div>
                            </div>
                        </div>
                        <!-- Sort By Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Sort By</label>
                            <div class="relative" data-custom-dropdown>
                                <input type="hidden" id="cross-disk-sort" value="savings" data-dropdown-input>
                                <button
                                    type="button"
                                    data-dropdown-button
                                    aria-expanded="false"
                                    class="w-full px-4 py-2 pr-10 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 cursor-pointer text-gray-100 text-left">
                                    <span data-dropdown-text>Largest Savings</span>
                                    <svg class="w-4 h-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div data-dropdown-menu class="hidden absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg max-h-60 overflow-auto">
                                    <div data-dropdown-option data-value="savings" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 bg-blue-600" aria-selected="true">Largest Savings</div>
                                    <div data-dropdown-option data-value="size" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">Largest Files</div>
                                    <div data-dropdown-option data-value="copies" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">Most Copies</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Duplicate Groups -->
                <div id="cross-disk-groups" class="space-y-4">
                    {{if gt (len .CrossDiskGroups) 0}}
                        {{range .CrossDiskGroups}}
                        <div class="duplicate-group bg-gray-750 rounded-lg border border-gray-700 overflow-hidden" data-size="{{.SpaceSavings}}" data-hash-type="{{.Group.HashType}}" data-copies="{{.Group.TotalCopies}}" data-file-size="{{.Group.TotalSize}}">
                            <!-- Group Header -->
                            <div class="bg-gray-800 px-6 py-4 border-b border-gray-700">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-3">
                                            <h3 class="text-lg font-semibold text-gray-100">
                                                {{.Group.TotalSize | formatBytes}} √ó {{.Group.TotalCopies}} copies
                                            </h3>
                                            {{if eq .Group.HashType "quick"}}
                                            <span class="px-2 py-1 text-xs rounded bg-yellow-600 text-yellow-100" title="Quick hash - verify before consolidating">
                                                ‚ö†Ô∏è Quick Hash
                                            </span>
                                            {{else if eq .Group.HashType "full"}}
                                            <span class="px-2 py-1 text-xs rounded bg-green-600 text-green-100" title="Full hash - verified duplicate">
                                                ‚úì Full Hash
                                            </span>
                                            {{end}}
                                        </div>
                                        <div class="text-sm text-gray-400 mt-1 font-mono truncate">
                                            Hash: {{.Group.FileHash}}
                                        </div>
                                        <div class="text-sm text-gray-400 mt-1">
                                            Algorithm: {{.Group.HashAlgorithm}} | Disks: {{.Group.UniqueDiskCount}}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm text-gray-400">Potential Savings</div>
                                        <div class="text-xl font-bold text-green-400">{{.SpaceSavings | formatBytes}}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- File Entries -->
                            <div class="px-6 py-4 space-y-3">
                                {{range .Group.Files}}
                                <div class="file-entry flex items-center justify-between p-3 rounded {{if eq .ID $.KeepFile.ID}}bg-green-900 bg-opacity-20 border border-green-700{{else}}bg-red-900 bg-opacity-20 border border-red-700{{end}}">
                                    <div class="flex items-center space-x-3 flex-1 min-w-0">
                                        {{if eq .ID $.KeepFile.ID}}
                                        <div class="shrink-0 w-8 h-8 rounded-full bg-green-600 flex items-center justify-center text-white font-bold">
                                            ‚úì
                                        </div>
                                        {{else}}
                                        <div class="shrink-0 w-8 h-8 rounded-full bg-red-600 flex items-center justify-center text-white font-bold">
                                            ‚úó
                                        </div>
                                        {{end}}
                                        <div class="flex-1 min-w-0">
                                            <div class="text-sm font-medium text-gray-100 truncate">{{.Path}}</div>
                                            <div class="flex items-center space-x-4 mt-1">
                                                <span class="text-xs text-gray-400">
                                                    {{if .DiskName}}{{.DiskName}}{{else}}Device {{.DeviceID}}{{end}}
                                                    {{if .DiskUsedPercent}}
                                                    ({{printf "%.1f" .DiskUsedPercent}}% full)
                                                    {{end}}
                                                </span>
                                                {{if .IsOrphaned}}
                                                <span class="px-2 py-0.5 text-xs rounded bg-gray-600 text-gray-300">
                                                    Orphaned
                                                </span>
                                                {{end}}
                                                {{if .ServiceUsage}}
                                                <span class="text-xs text-gray-400">
                                                    Used by: {{range $i, $svc := .ServiceUsage}}{{if $i}}, {{end}}{{$svc}}{{end}}
                                                </span>
                                                {{end}}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="shrink-0 ml-4 text-right">
                                        {{if eq .ID $.KeepFile.ID}}
                                        <div class="text-sm font-medium text-green-400">KEEP</div>
                                        <div class="text-xs text-gray-400">{{$.ReasonToKeep}}</div>
                                        {{else}}
                                        <div class="text-sm font-medium text-red-400">DELETE</div>
                                        <div class="text-xs text-gray-400">Free {{.Size | formatBytes}}</div>
                                        {{end}}
                                    </div>
                                </div>
                                {{end}}
                            </div>
                        </div>
                        {{end}}
                    {{else}}
                        <div class="bg-gray-750 rounded-lg p-12 text-center border border-gray-700">
                            <div class="text-gray-400 text-lg">No cross-disk duplicates found</div>
                            <div class="text-gray-500 text-sm mt-2">
                                Files with identical hashes on different disks will appear here
                            </div>
                        </div>
                    {{end}}
                </div>
            </div>
        </div>

        <!-- Same-Disk Tab Content -->
        <div id="same-disk-tab" class="tab-content {{if or (not .ActiveTab) (eq .ActiveTab "cross-disk")}}hidden{{end}} p-6">
            <div class="space-y-4">
                <!-- Summary Card -->
                <div class="bg-gray-750 rounded-lg p-6 border border-gray-700">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <div class="text-sm text-gray-400">Hardlink Groups</div>
                            <div class="text-2xl font-bold text-gray-100">{{.SameDiskCount}}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-400">Files to Link</div>
                            <div class="text-2xl font-bold text-gray-100">{{.SameDiskFilesToLink}}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-400">Space to Save</div>
                            <div class="text-2xl font-bold text-green-400">{{.SameDiskSavings | formatBytes}}</div>
                        </div>
                        <div class="flex items-center">
                            {{if gt .SameDiskCount 0}}
                            <button
                                onclick="previewHardlinks()"
                                class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium transition-colors">
                                Preview Hardlinks
                            </button>
                            {{end}}
                        </div>
                    </div>
                </div>

                <!-- Filter Options -->
                <div class="bg-gray-750 rounded-lg p-4 border border-gray-700">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Hash Type Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Hash Type</label>
                            <div class="relative" data-custom-dropdown>
                                <input type="hidden" id="same-disk-hash-filter" value="all" data-dropdown-input>
                                <button
                                    type="button"
                                    data-dropdown-button
                                    aria-expanded="false"
                                    class="w-full px-4 py-2 pr-10 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 cursor-pointer text-gray-100 text-left">
                                    <span data-dropdown-text>All Hashes</span>
                                    <svg class="w-4 h-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div data-dropdown-menu class="hidden absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg max-h-60 overflow-auto">
                                    <div data-dropdown-option data-value="all" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 bg-blue-600" aria-selected="true">All Hashes</div>
                                    <div data-dropdown-option data-value="full" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">Full Hash Only ‚úì</div>
                                    <div data-dropdown-option data-value="quick" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">Quick Hash Only ‚ö†Ô∏è</div>
                                </div>
                            </div>
                        </div>
                        <!-- Minimum Savings Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Minimum Savings</label>
                            <div class="relative" data-custom-dropdown>
                                <input type="hidden" id="same-disk-size-filter" value="0" data-dropdown-input>
                                <button
                                    type="button"
                                    data-dropdown-button
                                    aria-expanded="false"
                                    class="w-full px-4 py-2 pr-10 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 cursor-pointer text-gray-100 text-left">
                                    <span data-dropdown-text>Any Size</span>
                                    <svg class="w-4 h-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div data-dropdown-menu class="hidden absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg max-h-60 overflow-auto">
                                    <div data-dropdown-option data-value="0" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 bg-blue-600" aria-selected="true">Any Size</div>
                                    <div data-dropdown-option data-value="10485760" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">10 MB+</div>
                                    <div data-dropdown-option data-value="104857600" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">100 MB+</div>
                                    <div data-dropdown-option data-value="1073741824" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">1 GB+</div>
                                    <div data-dropdown-option data-value="10737418240" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">10 GB+</div>
                                </div>
                            </div>
                        </div>
                        <!-- Sort By Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Sort By</label>
                            <div class="relative" data-custom-dropdown>
                                <input type="hidden" id="same-disk-sort" value="savings" data-dropdown-input>
                                <button
                                    type="button"
                                    data-dropdown-button
                                    aria-expanded="false"
                                    class="w-full px-4 py-2 pr-10 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 cursor-pointer text-gray-100 text-left">
                                    <span data-dropdown-text>Largest Savings</span>
                                    <svg class="w-4 h-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div data-dropdown-menu class="hidden absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg max-h-60 overflow-auto">
                                    <div data-dropdown-option data-value="savings" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 bg-blue-600" aria-selected="true">Largest Savings</div>
                                    <div data-dropdown-option data-value="size" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">Largest Files</div>
                                    <div data-dropdown-option data-value="copies" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">Most Copies</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Duplicate Groups -->
                <div id="same-disk-groups" class="space-y-4">
                    {{if gt (len .SameDiskGroups) 0}}
                        {{range .SameDiskGroups}}
                        <div class="duplicate-group bg-gray-750 rounded-lg border border-gray-700 overflow-hidden" data-size="{{.SpaceSavings}}" data-hash-type="{{.Group.HashType}}" data-copies="{{.Group.TotalCopies}}" data-file-size="{{.Group.TotalSize}}">
                            <!-- Group Header -->
                            <div class="bg-gray-800 px-6 py-4 border-b border-gray-700">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-3">
                                            <h3 class="text-lg font-semibold text-gray-100">
                                                {{.Group.TotalSize | formatBytes}} √ó {{.Group.TotalCopies}} copies
                                            </h3>
                                            {{if eq .Group.HashType "quick"}}
                                            <span class="px-2 py-1 text-xs rounded bg-yellow-600 text-yellow-100">
                                                ‚ö†Ô∏è Quick Hash
                                            </span>
                                            {{else if eq .Group.HashType "full"}}
                                            <span class="px-2 py-1 text-xs rounded bg-green-600 text-green-100">
                                                ‚úì Full Hash
                                            </span>
                                            {{end}}
                                        </div>
                                        <div class="text-sm text-gray-400 mt-1 font-mono truncate">
                                            Hash: {{.Group.FileHash}}
                                        </div>
                                        <div class="text-sm text-gray-400 mt-1">
                                            Disk: {{if .KeepDisk}}{{.KeepDisk.Name}}{{else}}Unknown{{end}}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm text-gray-400">Potential Savings</div>
                                        <div class="text-xl font-bold text-green-400">{{.SpaceSavings | formatBytes}}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- File Entries -->
                            <div class="px-6 py-4 space-y-3">
                                {{range .Group.Files}}
                                <div class="file-entry flex items-center justify-between p-3 rounded {{if eq .ID $.KeepFile.ID}}bg-blue-900 bg-opacity-20 border border-blue-700{{else}}bg-gray-700 bg-opacity-40 border border-gray-600{{end}}">
                                    <div class="flex items-center space-x-3 flex-1 min-w-0">
                                        {{if eq .ID $.KeepFile.ID}}
                                        <div class="shrink-0 w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold">
                                            ‚òÖ
                                        </div>
                                        {{else}}
                                        <div class="shrink-0 w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center text-white">
                                            üîó
                                        </div>
                                        {{end}}
                                        <div class="flex-1 min-w-0">
                                            <div class="text-sm font-medium text-gray-100 truncate">{{.Path}}</div>
                                            <div class="flex items-center space-x-4 mt-1">
                                                {{if .ServiceUsage}}
                                                <span class="text-xs text-gray-400">
                                                    Used by: {{range $i, $svc := .ServiceUsage}}{{if $i}}, {{end}}{{$svc}}{{end}}
                                                </span>
                                                {{else if .IsOrphaned}}
                                                <span class="px-2 py-0.5 text-xs rounded bg-gray-600 text-gray-300">
                                                    Orphaned
                                                </span>
                                                {{end}}
                                                <span class="text-xs text-gray-500">
                                                    Modified: {{.ModifiedTime | formatTimestamp}}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="shrink-0 ml-4 text-right">
                                        {{if eq .ID $.KeepFile.ID}}
                                        <div class="text-sm font-medium text-blue-400">PRIMARY</div>
                                        <div class="text-xs text-gray-400">{{$.ReasonToKeep}}</div>
                                        {{else}}
                                        <div class="text-sm font-medium text-gray-400">LINK TO PRIMARY</div>
                                        <div class="text-xs text-gray-400">Save {{.Size | formatBytes}}</div>
                                        {{end}}
                                    </div>
                                </div>
                                {{end}}
                            </div>
                        </div>
                        {{end}}
                    {{else}}
                        <div class="bg-gray-750 rounded-lg p-12 text-center border border-gray-700">
                            <div class="text-gray-400 text-lg">No same-disk duplicates found</div>
                            <div class="text-gray-500 text-sm mt-2">
                                Files with identical hashes on the same disk will appear here
                            </div>
                        </div>
                    {{end}}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Tab switching
function switchTab(tabName) {
    // Update URL without reload
    const url = new URL(window.location);
    url.searchParams.set('tab', tabName);
    window.history.pushState({}, '', url);

    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });

    // Show selected tab
    document.getElementById(tabName + '-tab').classList.remove('hidden');

    // Update tab button styles
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('border-blue-500', 'text-blue-400');
        btn.classList.add('border-transparent', 'text-gray-400');
    });

    const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
    activeBtn.classList.remove('border-transparent', 'text-gray-400');
    activeBtn.classList.add('border-blue-500', 'text-blue-400');
}

// Initialize custom dropdown event handlers
document.addEventListener('DOMContentLoaded', function() {
    // Cross-disk dropdown handlers
    const crossDiskHashFilter = document.getElementById('cross-disk-hash-filter');
    const crossDiskSizeFilter = document.getElementById('cross-disk-size-filter');
    const crossDiskSort = document.getElementById('cross-disk-sort');

    if (crossDiskHashFilter) {
        crossDiskHashFilter.addEventListener('change', function() {
            applyFiltersAndSort('cross-disk');
        });
    }

    if (crossDiskSizeFilter) {
        crossDiskSizeFilter.addEventListener('change', function() {
            applyFiltersAndSort('cross-disk');
        });
    }

    if (crossDiskSort) {
        crossDiskSort.addEventListener('change', function() {
            applyFiltersAndSort('cross-disk');
        });
    }

    // Same-disk dropdown handlers
    const sameDiskHashFilter = document.getElementById('same-disk-hash-filter');
    const sameDiskSizeFilter = document.getElementById('same-disk-size-filter');
    const sameDiskSort = document.getElementById('same-disk-sort');

    if (sameDiskHashFilter) {
        sameDiskHashFilter.addEventListener('change', function() {
            applyFiltersAndSort('same-disk');
        });
    }

    if (sameDiskSizeFilter) {
        sameDiskSizeFilter.addEventListener('change', function() {
            applyFiltersAndSort('same-disk');
        });
    }

    if (sameDiskSort) {
        sameDiskSort.addEventListener('change', function() {
            applyFiltersAndSort('same-disk');
        });
    }
});

// Apply all filters and sorting for a given type
function applyFiltersAndSort(type) {
    const hashFilter = document.getElementById(`${type}-hash-filter`);
    const sizeFilter = document.getElementById(`${type}-size-filter`);
    const sortSelect = document.getElementById(`${type}-sort`);

    if (!hashFilter || !sizeFilter || !sortSelect) return;

    const hashType = hashFilter.value;
    const minSize = parseInt(sizeFilter.value);
    const sortBy = sortSelect.value;

    const container = document.getElementById(`${type}-groups`);
    if (!container) return;

    const groups = Array.from(container.querySelectorAll('.duplicate-group'));

    // Filter groups
    groups.forEach(group => {
        let visible = true;

        // Filter by hash type
        if (hashType !== 'all') {
            const groupHashType = group.getAttribute('data-hash-type');
            if (groupHashType !== hashType) {
                visible = false;
            }
        }

        // Filter by minimum size
        if (minSize > 0) {
            const groupSize = parseInt(group.getAttribute('data-size') || '0');
            if (groupSize < minSize) {
                visible = false;
            }
        }

        // Show/hide group
        if (visible) {
            group.style.display = '';
        } else {
            group.style.display = 'none';
        }
    });

    // Sort visible groups
    const visibleGroups = groups.filter(group => group.style.display !== 'none');

    visibleGroups.sort((a, b) => {
        let aValue, bValue;

        switch (sortBy) {
            case 'savings':
                aValue = parseInt(a.getAttribute('data-size') || '0');
                bValue = parseInt(b.getAttribute('data-size') || '0');
                return bValue - aValue; // Descending (largest first)

            case 'size':
                aValue = parseInt(a.getAttribute('data-file-size') || '0');
                bValue = parseInt(b.getAttribute('data-file-size') || '0');
                return bValue - aValue; // Descending (largest first)

            case 'copies':
                aValue = parseInt(a.getAttribute('data-copies') || '0');
                bValue = parseInt(b.getAttribute('data-copies') || '0');
                return bValue - aValue; // Descending (most first)

            default:
                return 0;
        }
    });

    // Re-append groups in sorted order
    visibleGroups.forEach(group => {
        container.appendChild(group);
    });
}

// Legacy functions for backwards compatibility (now just call applyFiltersAndSort)
function filterDuplicates(type, hashType) {
    applyFiltersAndSort(type);
}

function filterBySize(type, minSize) {
    applyFiltersAndSort(type);
}

function sortDuplicates(type, sortBy) {
    applyFiltersAndSort(type);
}

function previewConsolidation(type) {
    if (!confirm('Do you want to run a DRY RUN consolidation first?\n\nThis will show what would happen without actually deleting files.')) {
        return;
    }

    // Run dry-run consolidation
    fetch('/api/duplicates/consolidate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({dry_run: true})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            let message = `DRY RUN COMPLETE\n\n`;
            message += `Groups processed: ${data.groups_processed}\n`;
            message += `Files to delete: ${data.files_deleted}\n`;
            message += `Space to free: ${formatBytes(data.space_freed)}\n`;

            if (data.errors && data.errors.length > 0) {
                message += `\nErrors: ${data.errors.length}`;
            }

            message += '\n\nProceed with actual consolidation?';

            if (confirm(message)) {
                executeConsolidation();
            }
        } else {
            alert('Preview failed: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function executeConsolidation() {
    if (!confirm('‚ö†Ô∏è WARNING: This will DELETE files!\n\nAre you absolutely sure you want to proceed?')) {
        return;
    }

    fetch('/api/duplicates/consolidate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({dry_run: false})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            let message = `CONSOLIDATION COMPLETE\n\n`;
            message += `Groups processed: ${data.groups_processed}\n`;
            message += `Files deleted: ${data.files_deleted}\n`;
            message += `Space freed: ${formatBytes(data.space_freed)}\n`;

            if (data.errors && data.errors.length > 0) {
                message += `\nErrors encountered: ${data.errors.length}`;
            }

            alert(message);
            location.reload(); // Refresh to show updated data
        } else {
            alert('Consolidation failed: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function previewHardlinks() {
    if (!confirm('Do you want to run a DRY RUN hardlink operation first?\n\nThis will show what would happen without actually creating hardlinks.')) {
        return;
    }

    // Run dry-run hardlink
    fetch('/api/duplicates/hardlink', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({dry_run: true})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            let message = `DRY RUN COMPLETE\n\n`;
            message += `Groups processed: ${data.groups_processed}\n`;
            message += `Files to hardlink: ${data.files_linked}\n`;
            message += `Space to save: ${formatBytes(data.space_saved)}\n`;

            if (data.errors && data.errors.length > 0) {
                message += `\nErrors: ${data.errors.length}`;
            }

            message += '\n\nProceed with actual hardlink creation?';

            if (confirm(message)) {
                executeHardlinks();
            }
        } else {
            alert('Preview failed: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function executeHardlinks() {
    if (!confirm('This will replace duplicate files with hardlinks.\n\nProceed?')) {
        return;
    }

    fetch('/api/duplicates/hardlink', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({dry_run: false})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            let message = `HARDLINK CREATION COMPLETE\n\n`;
            message += `Groups processed: ${data.groups_processed}\n`;
            message += `Files hardlinked: ${data.files_linked}\n`;
            message += `Space saved: ${formatBytes(data.space_saved)}\n`;

            if (data.errors && data.errors.length > 0) {
                message += `\nErrors encountered: ${data.errors.length}`;
            }

            alert(message);
            location.reload(); // Refresh to show updated data
        } else {
            alert('Hardlink creation failed: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

// Helper function to format bytes
function formatBytes(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}
</script>
{{end}}
