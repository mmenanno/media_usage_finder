{{template "layout.html" .}}

{{define "content"}}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h2 class="text-3xl font-bold">Duplicate Files</h2>
        <div class="text-gray-400">
            Total potential savings: <span class="text-blue-400 font-semibold">{{.TotalSavings | formatBytes}}</span>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="bg-gray-800 rounded-lg">
        <div class="flex border-b border-gray-700">
            <button
                data-tab="same-disk"
                class="tab-button px-6 py-3 text-sm font-medium border-b-2 transition-colors {{if or (not .ActiveTab) (eq .ActiveTab "same-disk")}}border-blue-500 text-blue-400{{else}}border-transparent text-gray-400 hover:text-gray-300{{end}}"
                onclick="switchTab('same-disk')">
                Same-Disk Duplicates
                <span class="ml-2 px-2 py-1 text-xs rounded bg-gray-700">{{.SameDiskCount}}</span>
            </button>
            <button
                data-tab="cross-disk"
                class="tab-button px-6 py-3 text-sm font-medium border-b-2 transition-colors {{if eq .ActiveTab "cross-disk"}}border-blue-500 text-blue-400{{else}}border-transparent text-gray-400 hover:text-gray-300{{end}}"
                onclick="switchTab('cross-disk')">
                Cross-Disk Duplicates
                <span class="ml-2 px-2 py-1 text-xs rounded bg-gray-700">{{.CrossDiskCount}}</span>
            </button>
        </div>

        <!-- Cross-Disk Tab Content -->
        <div id="cross-disk-tab" class="tab-content {{if or (not .ActiveTab) (eq .ActiveTab "same-disk")}}hidden{{end}} p-6">
            <div class="space-y-4">
                <!-- Summary Card -->
                <div class="bg-gray-750 rounded-lg p-6 border border-gray-700">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <div class="text-sm text-gray-400">Duplicate Groups</div>
                            <div class="text-2xl font-bold text-gray-100">{{.CrossDiskCount}}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-400">Files to Delete</div>
                            <div class="text-2xl font-bold text-gray-100">{{.CrossDiskFilesToDelete}}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-400">Space to Free</div>
                            <div class="text-2xl font-bold text-green-400">{{.CrossDiskSavings | formatBytes}}</div>
                        </div>
                        <div class="flex items-center">
                            {{if gt .CrossDiskCount 0}}
                            <button
                                onclick="previewConsolidation('cross-disk')"
                                class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium transition-colors cursor-pointer">
                                Preview Consolidation
                            </button>
                            {{end}}
                        </div>
                    </div>
                </div>

                <!-- Filter Options -->
                <div class="bg-gray-750 rounded-lg p-4 border border-gray-700">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Hash Type Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Hash Type</label>
                            <div class="relative" data-custom-dropdown>
                                <input type="hidden" id="cross-disk-hash-filter" value="all" data-dropdown-input>
                                <button
                                    type="button"
                                    data-dropdown-button
                                    aria-expanded="false"
                                    class="w-full px-4 py-2 pr-10 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 cursor-pointer text-gray-100 text-left">
                                    <span data-dropdown-text>All Hashes</span>
                                    <svg class="w-4 h-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div data-dropdown-menu class="hidden absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg max-h-60 overflow-auto">
                                    <div data-dropdown-option data-value="all" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 bg-blue-600" aria-selected="true">All Hashes</div>
                                    <div data-dropdown-option data-value="full" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">Full Hash Only ‚úì</div>
                                    <div data-dropdown-option data-value="progressive" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">Progressive Hash Only üîÑ</div>
                                    <div data-dropdown-option data-value="quick" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">Quick Hash Only ‚ö†Ô∏è</div>
                                </div>
                            </div>
                        </div>
                        <!-- Minimum Savings Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Minimum Savings</label>
                            <div class="relative" data-custom-dropdown>
                                <input type="hidden" id="cross-disk-size-filter" value="0" data-dropdown-input>
                                <button
                                    type="button"
                                    data-dropdown-button
                                    aria-expanded="false"
                                    class="w-full px-4 py-2 pr-10 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 cursor-pointer text-gray-100 text-left">
                                    <span data-dropdown-text>Any Size</span>
                                    <svg class="w-4 h-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div data-dropdown-menu class="hidden absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg max-h-60 overflow-auto">
                                    <div data-dropdown-option data-value="0" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 bg-blue-600" aria-selected="true">Any Size</div>
                                    <div data-dropdown-option data-value="10485760" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">10 MB+</div>
                                    <div data-dropdown-option data-value="104857600" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">100 MB+</div>
                                    <div data-dropdown-option data-value="1073741824" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">1 GB+</div>
                                    <div data-dropdown-option data-value="10737418240" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">10 GB+</div>
                                </div>
                            </div>
                        </div>
                        <!-- Sort By Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Sort By</label>
                            <div class="relative" data-custom-dropdown>
                                <input type="hidden" id="cross-disk-sort" value="savings" data-dropdown-input>
                                <button
                                    type="button"
                                    data-dropdown-button
                                    aria-expanded="false"
                                    class="w-full px-4 py-2 pr-10 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 cursor-pointer text-gray-100 text-left">
                                    <span data-dropdown-text>Largest Savings</span>
                                    <svg class="w-4 h-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div data-dropdown-menu class="hidden absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg max-h-60 overflow-auto">
                                    <div data-dropdown-option data-value="savings" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 bg-blue-600" aria-selected="true">Largest Savings</div>
                                    <div data-dropdown-option data-value="size" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">Largest Files</div>
                                    <div data-dropdown-option data-value="copies" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">Most Copies</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Duplicate Groups -->
                <div id="cross-disk-groups" class="space-y-4">
                    {{range $plan := .CrossDiskGroups}}
                        <div class="duplicate-group bg-gray-750 rounded-lg border border-gray-700 overflow-hidden" data-size="{{$plan.SpaceSavings}}" data-hash-type="{{if gt $plan.Group.HashLevel 0}}{{if eq $plan.Group.HashLevel 6}}full{{else if eq $plan.Group.HashLevel 1}}quick{{else}}progressive{{end}}{{else}}{{$plan.Group.HashType}}{{end}}" data-copies="{{$plan.Group.TotalCopies}}" data-file-size="{{$plan.Group.TotalSize}}">
                            <!-- Group Header -->
                            <div class="bg-gray-800 px-6 py-4 border-b border-gray-700">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-3">
                                            <h3 class="text-lg font-semibold text-gray-100">
                                                {{$plan.Group.TotalSize | formatBytes}} √ó {{$plan.Group.TotalCopies}} copies
                                            </h3>
                                            {{if gt $plan.Group.HashLevel 0}}
                                                {{if eq $plan.Group.HashLevel 6}}
                                                <span class="px-2 py-1 text-xs rounded bg-green-600 text-green-100" title="Full hash - verified duplicate">
                                                    ‚úì Full Hash
                                                </span>
                                                {{else if eq $plan.Group.HashLevel 1}}
                                                <span class="px-2 py-1 text-xs rounded bg-yellow-600 text-yellow-100" title="Quick hash - verify before consolidating">
                                                    ‚ö†Ô∏è Quick Hash
                                                </span>
                                                {{else}}
                                                <span class="px-2 py-1 text-xs rounded bg-blue-600 text-blue-100" title="Progressive hash - level {{$plan.Group.HashLevel}}">
                                                    üîÑ {{hashLevelName $plan.Group.HashLevel}}
                                                </span>
                                                {{end}}
                                            {{else}}
                                                {{if eq $plan.Group.HashType "quick"}}
                                                <span class="px-2 py-1 text-xs rounded bg-yellow-600 text-yellow-100" title="Quick hash - verify before consolidating">
                                                    ‚ö†Ô∏è Quick Hash
                                                </span>
                                                {{else if eq $plan.Group.HashType "full"}}
                                                <span class="px-2 py-1 text-xs rounded bg-green-600 text-green-100" title="Full hash - verified duplicate">
                                                    ‚úì Full Hash
                                                </span>
                                                {{end}}
                                            {{end}}
                                        </div>
                                        <div class="text-sm text-gray-400 mt-1 font-mono truncate">
                                            Hash: {{$plan.Group.FileHash}}
                                        </div>
                                        <div class="text-sm text-gray-400 mt-1">
                                            Algorithm: {{$plan.Group.HashAlgorithm}} | Disks: {{$plan.Group.UniqueDiskCount}}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm text-gray-400">Potential Savings</div>
                                        <div class="text-xl font-bold text-green-400">{{$plan.SpaceSavings | formatBytes}}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- File Entries -->
                            <div class="px-6 py-4 space-y-3">
                                {{range $plan.Group.Files}}
                                <div class="file-entry flex items-center justify-between p-3 rounded {{if eq .ID $plan.KeepFile.ID}}bg-green-900 bg-opacity-20 border border-green-700{{else}}bg-red-900 bg-opacity-20 border border-red-700{{end}}">
                                    <div class="flex items-center space-x-3 flex-1 min-w-0">
                                        {{if eq .ID $plan.KeepFile.ID}}
                                        <div class="shrink-0 w-8 h-8 rounded-full bg-green-600 flex items-center justify-center text-white font-bold">
                                            ‚úì
                                        </div>
                                        {{else}}
                                        <div class="shrink-0 w-8 h-8 rounded-full bg-red-600 flex items-center justify-center text-white font-bold">
                                            ‚úó
                                        </div>
                                        {{end}}
                                        <div class="flex-1 min-w-0">
                                            <div class="text-sm font-medium text-gray-100 truncate">{{.Path}}</div>
                                            <div class="flex items-center space-x-4 mt-1">
                                                <span class="text-xs text-gray-400">
                                                    {{if .DiskName}}{{.DiskName}}{{else}}Device {{.DeviceID}}{{end}}
                                                    {{if .DiskUsedPercent}}
                                                    ({{printf "%.1f" .DiskUsedPercent}}% full)
                                                    {{end}}
                                                </span>
                                                {{if .IsOrphaned}}
                                                <span class="px-2 py-0.5 text-xs rounded bg-gray-600 text-gray-300">
                                                    Orphaned
                                                </span>
                                                {{end}}
                                                {{if .ServiceUsage}}
                                                <span class="text-xs text-gray-400">
                                                    Used by: {{range $i, $svc := .ServiceUsage}}{{if $i}}, {{end}}{{$svc}}{{end}}
                                                </span>
                                                {{end}}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="shrink-0 ml-4 text-right">
                                        {{if eq .ID $plan.KeepFile.ID}}
                                        <div class="text-sm font-medium text-green-400">KEEP</div>
                                        <div class="text-xs text-gray-400">{{$plan.ReasonToKeep}}</div>
                                        {{else}}
                                        <div class="text-sm font-medium text-red-400">DELETE</div>
                                        <div class="text-xs text-gray-400">Free {{.Size | formatBytes}}</div>
                                        {{end}}
                                    </div>
                                </div>
                                {{end}}
                            </div>
                        </div>
                    {{else}}
                        <div class="bg-gray-750 rounded-lg p-12 text-center border border-gray-700">
                            <div class="text-gray-400 text-lg">No cross-disk duplicates found</div>
                            <div class="text-gray-500 text-sm mt-2">
                                Files with identical hashes on different disks will appear here
                            </div>
                        </div>
                    {{end}}
                </div>
            </div>
        </div>

        <!-- Same-Disk Tab Content -->
        <div id="same-disk-tab" class="tab-content {{if eq .ActiveTab "cross-disk"}}hidden{{end}} p-6">
            <div class="space-y-4">
                <!-- Summary Card -->
                <div class="bg-gray-750 rounded-lg p-6 border border-gray-700">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <div class="text-sm text-gray-400">Hardlink Groups</div>
                            <div class="text-2xl font-bold text-gray-100">{{.SameDiskCount}}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-400">Files to Link</div>
                            <div class="text-2xl font-bold text-gray-100">{{.SameDiskFilesToLink}}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-400">Space to Save</div>
                            <div class="text-2xl font-bold text-green-400">{{.SameDiskSavings | formatBytes}}</div>
                        </div>
                        <div class="flex items-center">
                            {{if gt .SameDiskCount 0}}
                            <button
                                onclick="previewHardlinks()"
                                class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium transition-colors cursor-pointer">
                                Preview Hardlinks
                            </button>
                            {{end}}
                        </div>
                    </div>
                </div>

                <!-- Filter Options -->
                <div class="bg-gray-750 rounded-lg p-4 border border-gray-700">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Hash Type Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Hash Type</label>
                            <div class="relative" data-custom-dropdown>
                                <input type="hidden" id="same-disk-hash-filter" value="all" data-dropdown-input>
                                <button
                                    type="button"
                                    data-dropdown-button
                                    aria-expanded="false"
                                    class="w-full px-4 py-2 pr-10 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 cursor-pointer text-gray-100 text-left">
                                    <span data-dropdown-text>All Hashes</span>
                                    <svg class="w-4 h-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div data-dropdown-menu class="hidden absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg max-h-60 overflow-auto">
                                    <div data-dropdown-option data-value="all" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 bg-blue-600" aria-selected="true">All Hashes</div>
                                    <div data-dropdown-option data-value="full" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">Full Hash Only ‚úì</div>
                                    <div data-dropdown-option data-value="progressive" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">Progressive Hash Only üîÑ</div>
                                    <div data-dropdown-option data-value="quick" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">Quick Hash Only ‚ö†Ô∏è</div>
                                </div>
                            </div>
                        </div>
                        <!-- Minimum Savings Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Minimum Savings</label>
                            <div class="relative" data-custom-dropdown>
                                <input type="hidden" id="same-disk-size-filter" value="0" data-dropdown-input>
                                <button
                                    type="button"
                                    data-dropdown-button
                                    aria-expanded="false"
                                    class="w-full px-4 py-2 pr-10 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 cursor-pointer text-gray-100 text-left">
                                    <span data-dropdown-text>Any Size</span>
                                    <svg class="w-4 h-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div data-dropdown-menu class="hidden absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg max-h-60 overflow-auto">
                                    <div data-dropdown-option data-value="0" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 bg-blue-600" aria-selected="true">Any Size</div>
                                    <div data-dropdown-option data-value="10485760" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">10 MB+</div>
                                    <div data-dropdown-option data-value="104857600" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">100 MB+</div>
                                    <div data-dropdown-option data-value="1073741824" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">1 GB+</div>
                                    <div data-dropdown-option data-value="10737418240" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">10 GB+</div>
                                </div>
                            </div>
                        </div>
                        <!-- Sort By Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Sort By</label>
                            <div class="relative" data-custom-dropdown>
                                <input type="hidden" id="same-disk-sort" value="savings" data-dropdown-input>
                                <button
                                    type="button"
                                    data-dropdown-button
                                    aria-expanded="false"
                                    class="w-full px-4 py-2 pr-10 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 cursor-pointer text-gray-100 text-left">
                                    <span data-dropdown-text>Largest Savings</span>
                                    <svg class="w-4 h-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div data-dropdown-menu class="hidden absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg max-h-60 overflow-auto">
                                    <div data-dropdown-option data-value="savings" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 bg-blue-600" aria-selected="true">Largest Savings</div>
                                    <div data-dropdown-option data-value="size" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">Largest Files</div>
                                    <div data-dropdown-option data-value="copies" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100" aria-selected="false">Most Copies</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Duplicate Groups -->
                <div id="same-disk-groups" class="space-y-4">
                    {{range $plan := .SameDiskGroups}}
                        <div class="duplicate-group bg-gray-750 rounded-lg border border-gray-700 overflow-hidden" data-size="{{$plan.SpaceSavings}}" data-hash-type="{{if gt $plan.Group.HashLevel 0}}{{if eq $plan.Group.HashLevel 6}}full{{else if eq $plan.Group.HashLevel 1}}quick{{else}}progressive{{end}}{{else}}{{$plan.Group.HashType}}{{end}}" data-copies="{{$plan.Group.TotalCopies}}" data-file-size="{{$plan.Group.TotalSize}}">
                            <!-- Group Header -->
                            <div class="bg-gray-800 px-6 py-4 border-b border-gray-700">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-3">
                                            <h3 class="text-lg font-semibold text-gray-100">
                                                {{$plan.Group.TotalSize | formatBytes}} √ó {{$plan.TotalFiles}} files in {{$plan.ActualCopies}} cluster(s)
                                            </h3>
                                            {{if gt $plan.Group.HashLevel 0}}
                                                {{if eq $plan.Group.HashLevel 6}}
                                                <span class="px-2 py-1 text-xs rounded bg-green-600 text-green-100" title="Full hash - verified duplicate">
                                                    ‚úì Full Hash
                                                </span>
                                                {{else if eq $plan.Group.HashLevel 1}}
                                                <span class="px-2 py-1 text-xs rounded bg-yellow-600 text-yellow-100" title="Quick hash - verify before consolidating">
                                                    ‚ö†Ô∏è Quick Hash
                                                </span>
                                                {{else}}
                                                <span class="px-2 py-1 text-xs rounded bg-blue-600 text-blue-100" title="Progressive hash - level {{$plan.Group.HashLevel}}">
                                                    üîÑ {{hashLevelName $plan.Group.HashLevel}}
                                                </span>
                                                {{end}}
                                            {{else}}
                                                {{if eq $plan.Group.HashType "quick"}}
                                                <span class="px-2 py-1 text-xs rounded bg-yellow-600 text-yellow-100" title="Quick hash - verify before consolidating">
                                                    ‚ö†Ô∏è Quick Hash
                                                </span>
                                                {{else if eq $plan.Group.HashType "full"}}
                                                <span class="px-2 py-1 text-xs rounded bg-green-600 text-green-100" title="Full hash - verified duplicate">
                                                    ‚úì Full Hash
                                                </span>
                                                {{end}}
                                            {{end}}
                                        </div>
                                        {{if gt (len $plan.AlreadyLinked) 0}}
                                        <div class="text-sm text-blue-400 mt-1 flex items-center space-x-1">
                                            <span>‚ÑπÔ∏è</span>
                                            <span>{{len $plan.AlreadyLinked}} cluster(s) already internally linked</span>
                                        </div>
                                        {{end}}
                                        <div class="text-sm text-gray-400 mt-1 font-mono truncate">
                                            Hash: {{$plan.Group.FileHash}}
                                        </div>
                                        <div class="text-sm text-gray-400 mt-1">
                                            Disk: {{if $plan.KeepDisk}}{{$plan.KeepDisk.Name}}{{else}}Unknown{{end}}
                                        </div>
                                    </div>
                                    <div class="text-right space-y-3">
                                        <div>
                                            <div class="text-sm text-gray-400">Actual Savings</div>
                                            <div class="text-xl font-bold text-green-400">{{$plan.SpaceSavings | formatBytes}}</div>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button onclick="previewSingleGroup('{{$plan.Group.FileHash}}')" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded font-medium transition-colors cursor-pointer" title="Preview hardlinks for this group only">
                                                Preview
                                            </button>
                                            <button onclick="linkSingleGroup('{{$plan.Group.FileHash}}')" class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white text-sm rounded font-medium transition-colors cursor-pointer" title="Create hardlinks for this group">
                                                Link Group
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- File Entries Grouped by Hardlink Cluster -->
                            <div class="px-6 py-4 space-y-4">
                                <!-- Primary Cluster -->
                                {{if $plan.KeepCluster}}
                                <div class="hardlink-cluster bg-blue-900 bg-opacity-10 border border-blue-700 rounded-lg p-3">
                                    <div class="text-xs font-semibold text-blue-400 mb-2 flex items-center space-x-2">
                                        <span>PRIMARY CLUSTER (inode {{$plan.KeepCluster.Inode}})</span>
                                        {{if $plan.KeepCluster.IsLinked}}
                                        <span class="px-2 py-0.5 rounded bg-blue-600 bg-opacity-30 text-blue-300">
                                            {{$plan.KeepCluster.LinkCount}} files already linked
                                        </span>
                                        {{end}}
                                    </div>
                                    {{range $plan.KeepCluster.Files}}
                                    <div class="file-entry flex items-center justify-between p-2 rounded bg-blue-900 bg-opacity-20 mb-2">
                                        <div class="flex items-center space-x-3 flex-1 min-w-0">
                                            <div class="shrink-0 w-6 h-6 rounded-full bg-blue-600 flex items-center justify-center text-white text-sm font-bold">
                                                ‚òÖ
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="text-sm font-medium text-gray-100 truncate">{{.Path}}</div>
                                                <div class="flex items-center space-x-3 mt-1">
                                                    {{if .ServiceUsage}}
                                                    <span class="text-xs text-gray-400">
                                                        Used by: {{range $i, $svc := .ServiceUsage}}{{if $i}}, {{end}}{{$svc}}{{end}}
                                                    </span>
                                                    {{else if .IsOrphaned}}
                                                    <span class="px-2 py-0.5 text-xs rounded bg-gray-600 text-gray-300">Orphaned</span>
                                                    {{end}}
                                                    <span class="text-xs text-gray-500">Modified: {{.ModifiedTime | formatTimestamp}}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="shrink-0 ml-4 text-right">
                                            <div class="text-sm font-medium text-blue-400">PRIMARY</div>
                                            {{if eq .ID $plan.KeepFile.ID}}
                                            <div class="text-xs text-gray-400">{{$plan.ReasonToKeep}}</div>
                                            {{else}}
                                            <div class="text-xs text-gray-400">Already linked</div>
                                            {{end}}
                                        </div>
                                    </div>
                                    {{end}}
                                </div>
                                {{end}}

                                <!-- Already Linked Clusters (non-primary) -->
                                {{range $cluster := $plan.AlreadyLinked}}
                                    {{if ne $cluster.Inode $plan.KeepCluster.Inode}}
                                    <div class="hardlink-cluster bg-gray-700 bg-opacity-30 border border-gray-600 rounded-lg p-3">
                                        <div class="text-xs font-semibold text-gray-400 mb-2 flex items-center space-x-2">
                                            <span>LINKED CLUSTER (inode {{$cluster.Inode}})</span>
                                            <span class="px-2 py-0.5 rounded bg-gray-600 text-gray-300">
                                                {{$cluster.LinkCount}} files linked together
                                            </span>
                                            <span class="text-gray-500">‚Üí Will link all to primary</span>
                                        </div>
                                        {{range $cluster.Files}}
                                        <div class="file-entry flex items-center justify-between p-2 rounded bg-gray-700 bg-opacity-40 mb-2">
                                            <div class="flex items-center space-x-3 flex-1 min-w-0">
                                                <div class="shrink-0 w-6 h-6 rounded-full bg-green-600 flex items-center justify-center text-white text-xs">
                                                    üîó‚úì
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <div class="text-sm font-medium text-gray-100 truncate">{{.Path}}</div>
                                                    <div class="flex items-center space-x-3 mt-1">
                                                        {{if .ServiceUsage}}
                                                        <span class="text-xs text-gray-400">
                                                            Used by: {{range $i, $svc := .ServiceUsage}}{{if $i}}, {{end}}{{$svc}}{{end}}
                                                        </span>
                                                        {{else if .IsOrphaned}}
                                                        <span class="px-2 py-0.5 text-xs rounded bg-gray-600 text-gray-300">Orphaned</span>
                                                        {{end}}
                                                        <span class="text-xs text-gray-500">Modified: {{.ModifiedTime | formatTimestamp}}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="shrink-0 ml-4 text-right">
                                                <div class="text-sm font-medium text-gray-400">LINK TO PRIMARY</div>
                                                <div class="text-xs text-green-400">Save {{$plan.Group.TotalSize | formatBytes}}</div>
                                            </div>
                                        </div>
                                        {{end}}
                                    </div>
                                    {{end}}
                                {{end}}

                                <!-- Unlinked Clusters -->
                                {{range $cluster := $plan.LinkClusters}}
                                    {{$isAlreadyLinked := false}}
                                    {{range $linked := $plan.AlreadyLinked}}
                                        {{if eq $linked.Inode $cluster.Inode}}
                                            {{$isAlreadyLinked = true}}
                                        {{end}}
                                    {{end}}
                                    {{if not $isAlreadyLinked}}
                                    <div class="hardlink-cluster bg-gray-700 bg-opacity-30 border border-gray-600 rounded-lg p-3">
                                        <div class="text-xs font-semibold text-gray-400 mb-2 flex items-center space-x-2">
                                            <span>UNLINKED FILES{{if gt $cluster.LinkCount 1}} (inode {{$cluster.Inode}}){{end}}</span>
                                            {{if gt $cluster.LinkCount 1}}
                                            <span class="px-2 py-0.5 rounded bg-gray-600 text-gray-300">
                                                {{$cluster.LinkCount}} files need linking
                                            </span>
                                            {{end}}
                                        </div>
                                        {{range $cluster.Files}}
                                        <div class="file-entry flex items-center justify-between p-2 rounded bg-gray-700 bg-opacity-40 mb-2">
                                            <div class="flex items-center space-x-3 flex-1 min-w-0">
                                                <div class="shrink-0 w-6 h-6 rounded-full bg-gray-600 flex items-center justify-center text-white text-xs">
                                                    üîó
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <div class="text-sm font-medium text-gray-100 truncate">{{.Path}}</div>
                                                    <div class="flex items-center space-x-3 mt-1">
                                                        {{if .ServiceUsage}}
                                                        <span class="text-xs text-gray-400">
                                                            Used by: {{range $i, $svc := .ServiceUsage}}{{if $i}}, {{end}}{{$svc}}{{end}}
                                                        </span>
                                                        {{else if .IsOrphaned}}
                                                        <span class="px-2 py-0.5 text-xs rounded bg-gray-600 text-gray-300">Orphaned</span>
                                                        {{end}}
                                                        <span class="text-xs text-gray-500">Modified: {{.ModifiedTime | formatTimestamp}}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="shrink-0 ml-4 text-right">
                                                <div class="text-sm font-medium text-gray-400">LINK TO PRIMARY</div>
                                                <div class="text-xs text-gray-400">Save {{$plan.Group.TotalSize | formatBytes}}</div>
                                            </div>
                                        </div>
                                        {{end}}
                                    </div>
                                    {{end}}
                                {{end}}
                            </div>
                        </div>
                    {{else}}
                        <div class="bg-gray-750 rounded-lg p-12 text-center border border-gray-700">
                            <div class="text-gray-400 text-lg">No same-disk duplicates found</div>
                            <div class="text-gray-500 text-sm mt-2">
                                Files with identical hashes on the same disk will appear here
                            </div>
                        </div>
                    {{end}}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Dry Run Summary Modal -->
<div id="dryRunSummaryModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4 py-8">
        <!-- Background overlay -->
        <div class="fixed inset-0 bg-black/25 transition-opacity z-0" onclick="closeDryRunSummary()"></div>

        <!-- Modal panel -->
        <div class="bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:max-w-5xl w-full relative z-10 max-h-[90vh] flex flex-col">
            <!-- Header -->
            <div class="bg-gray-750 px-6 py-4 border-b border-gray-700 shrink-0">
                <div class="flex items-center justify-between">
                    <h3 class="text-2xl font-bold text-gray-100 flex items-center space-x-3">
                        <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>Hardlink Preview Results</span>
                    </h3>
                    <button onclick="closeDryRunSummary()" class="text-gray-400 hover:text-gray-200 cursor-pointer">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Content - Scrollable -->
            <div class="overflow-y-auto bg-gray-800 px-6 py-4 space-y-6 flex-1">
                <!-- Summary Statistics -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-gray-750 rounded-lg p-4 border border-gray-700">
                        <div class="text-sm text-gray-400">Groups Processed</div>
                        <div id="summary-groups" class="text-2xl font-bold text-blue-400">-</div>
                    </div>
                    <div class="bg-gray-750 rounded-lg p-4 border border-gray-700">
                        <div class="text-sm text-gray-400">Files Needing Action</div>
                        <div id="summary-files-to-link" class="text-2xl font-bold text-yellow-400">-</div>
                    </div>
                    <div class="bg-gray-750 rounded-lg p-4 border border-gray-700">
                        <div class="text-sm text-gray-400">Already Linked</div>
                        <div id="summary-files-linked" class="text-2xl font-bold text-green-400">-</div>
                    </div>
                    <div class="bg-gray-750 rounded-lg p-4 border border-gray-700">
                        <div class="text-sm text-gray-400">Space to Save</div>
                        <div id="summary-space" class="text-2xl font-bold text-green-400">-</div>
                    </div>
                </div>

                <!-- Cluster Details -->
                <div class="bg-gray-750 rounded-lg p-4 border border-gray-700">
                    <h4 class="text-lg font-semibold text-gray-100 mb-3 flex items-center space-x-2">
                        <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                        </svg>
                        <span>Cluster Details</span>
                    </h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-700 bg-opacity-50 rounded-lg p-3 border border-gray-600">
                            <div class="text-xs text-gray-400 mb-1">Clusters Needing Linking</div>
                            <div id="summary-clusters-needing" class="text-2xl font-bold text-yellow-400">-</div>
                        </div>
                        <div class="bg-gray-700 bg-opacity-50 rounded-lg p-3 border border-gray-600">
                            <div class="text-xs text-gray-400 mb-1">Clusters Already Linked</div>
                            <div id="summary-clusters-linked" class="text-2xl font-bold text-green-400">-</div>
                        </div>
                    </div>
                </div>

                <!-- Hash Breakdown -->
                <div class="bg-gray-750 rounded-lg p-4 border border-gray-700">
                    <h4 class="text-lg font-semibold text-gray-100 mb-3">Hash Verification Confidence</h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="flex items-center justify-between p-3 bg-green-900 bg-opacity-20 border border-green-700 rounded">
                            <span class="text-sm text-gray-300">‚úì Full Hash</span>
                            <span id="summary-hash-full" class="text-lg font-bold text-green-400">-</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-blue-900 bg-opacity-20 border border-blue-700 rounded">
                            <span class="text-sm text-gray-300">üîÑ Progressive</span>
                            <span id="summary-hash-progressive" class="text-lg font-bold text-blue-400">-</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-yellow-900 bg-opacity-20 border border-yellow-700 rounded">
                            <span class="text-sm text-gray-300">‚ö†Ô∏è Quick Hash</span>
                            <span id="summary-hash-quick" class="text-lg font-bold text-yellow-400">-</span>
                        </div>
                    </div>
                </div>

                <!-- Warnings -->
                <div id="summary-warnings-container" class="hidden bg-yellow-900 bg-opacity-20 border border-yellow-600 rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-yellow-400 mb-2 flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        <span>Warnings</span>
                    </h4>
                    <ul id="summary-warnings-list" class="space-y-1 text-sm text-yellow-100"></ul>
                </div>

                <!-- Top Groups -->
                <div class="bg-gray-750 rounded-lg p-4 border border-gray-700">
                    <h4 class="text-lg font-semibold text-gray-100 mb-3 flex items-center space-x-2">
                        <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                        </svg>
                        <span>Top Groups by Savings</span>
                    </h4>
                    <div id="summary-top-groups" class="space-y-2 text-sm">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Files to be Linked -->
                <div id="summary-files-container" class="hidden bg-gray-750 rounded-lg p-4 border border-gray-700">
                    <h4 class="text-lg font-semibold text-gray-100 mb-3 flex items-center space-x-2">
                        <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span>Files to be Linked</span>
                        <span id="summary-files-count" class="text-sm text-gray-400">(0 files)</span>
                    </h4>
                    <div id="summary-files-list" class="max-h-60 overflow-y-auto space-y-1 text-sm">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Footer with action buttons -->
            <div class="bg-gray-750 px-6 py-4 border-t border-gray-700 flex justify-between items-center shrink-0">
                <div class="text-sm text-gray-400">
                    This is a preview. No changes have been made yet.
                </div>
                <div class="flex space-x-3">
                    <button onclick="closeDryRunSummary()" class="px-6 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded font-medium transition-colors cursor-pointer">
                        Cancel
                    </button>
                    <button id="confirmHardlinkBtn" onclick="confirmAndExecuteHardlinks()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium transition-colors cursor-pointer">
                        Proceed with Hardlink Creation
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Tab switching
function switchTab(tabName) {
    // Update URL without reload
    const url = new URL(window.location);
    url.searchParams.set('tab', tabName);
    window.history.pushState({}, '', url);

    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });

    // Show selected tab
    document.getElementById(tabName + '-tab').classList.remove('hidden');

    // Update tab button styles
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('border-blue-500', 'text-blue-400');
        btn.classList.add('border-transparent', 'text-gray-400');
    });

    const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
    activeBtn.classList.remove('border-transparent', 'text-gray-400');
    activeBtn.classList.add('border-blue-500', 'text-blue-400');
}

// Initialize custom dropdown event handlers
document.addEventListener('DOMContentLoaded', function() {
    // Cross-disk dropdown handlers
    const crossDiskHashFilter = document.getElementById('cross-disk-hash-filter');
    const crossDiskSizeFilter = document.getElementById('cross-disk-size-filter');
    const crossDiskSort = document.getElementById('cross-disk-sort');

    if (crossDiskHashFilter) {
        crossDiskHashFilter.addEventListener('change', function() {
            applyFiltersAndSort('cross-disk');
        });
    }

    if (crossDiskSizeFilter) {
        crossDiskSizeFilter.addEventListener('change', function() {
            applyFiltersAndSort('cross-disk');
        });
    }

    if (crossDiskSort) {
        crossDiskSort.addEventListener('change', function() {
            applyFiltersAndSort('cross-disk');
        });
    }

    // Same-disk dropdown handlers
    const sameDiskHashFilter = document.getElementById('same-disk-hash-filter');
    const sameDiskSizeFilter = document.getElementById('same-disk-size-filter');
    const sameDiskSort = document.getElementById('same-disk-sort');

    if (sameDiskHashFilter) {
        sameDiskHashFilter.addEventListener('change', function() {
            applyFiltersAndSort('same-disk');
        });
    }

    if (sameDiskSizeFilter) {
        sameDiskSizeFilter.addEventListener('change', function() {
            applyFiltersAndSort('same-disk');
        });
    }

    if (sameDiskSort) {
        sameDiskSort.addEventListener('change', function() {
            applyFiltersAndSort('same-disk');
        });
    }
});

// Apply all filters and sorting for a given type
function applyFiltersAndSort(type) {
    const hashFilter = document.getElementById(`${type}-hash-filter`);
    const sizeFilter = document.getElementById(`${type}-size-filter`);
    const sortSelect = document.getElementById(`${type}-sort`);

    if (!hashFilter || !sizeFilter || !sortSelect) return;

    const hashType = hashFilter.value;
    const minSize = parseInt(sizeFilter.value);
    const sortBy = sortSelect.value;

    const container = document.getElementById(`${type}-groups`);
    if (!container) return;

    const groups = Array.from(container.querySelectorAll('.duplicate-group'));

    // Filter groups
    groups.forEach(group => {
        let visible = true;

        // Filter by hash type
        if (hashType !== 'all') {
            const groupHashType = group.getAttribute('data-hash-type');
            if (groupHashType !== hashType) {
                visible = false;
            }
        }

        // Filter by minimum size
        if (minSize > 0) {
            const groupSize = parseInt(group.getAttribute('data-size') || '0');
            if (groupSize < minSize) {
                visible = false;
            }
        }

        // Show/hide group
        if (visible) {
            group.style.display = '';
        } else {
            group.style.display = 'none';
        }
    });

    // Sort visible groups
    const visibleGroups = groups.filter(group => group.style.display !== 'none');

    visibleGroups.sort((a, b) => {
        let aValue, bValue;

        switch (sortBy) {
            case 'savings':
                aValue = parseInt(a.getAttribute('data-size') || '0');
                bValue = parseInt(b.getAttribute('data-size') || '0');
                return bValue - aValue; // Descending (largest first)

            case 'size':
                aValue = parseInt(a.getAttribute('data-file-size') || '0');
                bValue = parseInt(b.getAttribute('data-file-size') || '0');
                return bValue - aValue; // Descending (largest first)

            case 'copies':
                aValue = parseInt(a.getAttribute('data-copies') || '0');
                bValue = parseInt(b.getAttribute('data-copies') || '0');
                return bValue - aValue; // Descending (most first)

            default:
                return 0;
        }
    });

    // Re-append groups in sorted order
    visibleGroups.forEach(group => {
        container.appendChild(group);
    });
}

// Legacy functions for backwards compatibility (now just call applyFiltersAndSort)
function filterDuplicates(type, hashType) {
    applyFiltersAndSort(type);
}

function filterBySize(type, minSize) {
    applyFiltersAndSort(type);
}

function sortDuplicates(type, sortBy) {
    applyFiltersAndSort(type);
}

async function previewConsolidation(type) {
    const confirmed = await confirmDialog(
        'This will show what would happen without actually deleting files.',
        'Run Dry Run Consolidation?'
    );

    if (!confirmed) {
        return;
    }

    // Show loading toast
    showToast('Analyzing duplicates...', 'info', {duration: 5000}); // 5 seconds

    // Run dry-run consolidation
    fetch('/api/duplicates/consolidate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({dry_run: true})
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(async data => {
        // Dismiss loading toast
        showToast('Analysis complete!', 'success', {duration: 2000});

        if (data.status === 'success') {
            let message = `DRY RUN COMPLETE\n\n`;
            message += `Groups processed: ${data.groups_processed}\n`;
            message += `Files to delete: ${data.files_deleted}\n`;
            message += `Space to free: ${formatBytes(data.space_freed)}\n`;

            if (data.errors && data.errors.length > 0) {
                message += `\nErrors: ${data.errors.length}`;
            }

            message += '\n\nProceed with actual consolidation?';

            const proceed = await confirmDialog(message, 'Dry Run Results');
            if (proceed) {
                executeConsolidation();
            }
        } else {
            showToast('Preview failed: ' + (data.message || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        showToast('Error: ' + error.message, 'error');
    });
}

async function executeConsolidation() {
    const confirmed = await confirmDialog(
        '‚ö†Ô∏è WARNING: This will DELETE files!\n\nAre you absolutely sure you want to proceed?',
        'Confirm File Deletion'
    );

    if (!confirmed) {
        return;
    }

    // Show loading toast with long duration for potentially long operation
    showToast('Deleting duplicate files...', 'info', {duration: 60000}); // 60 seconds

    fetch('/api/duplicates/consolidate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({dry_run: false})
    })
    .then(response => response.json())
    .then(async data => {
        if (data.status === 'success') {
            // Dismiss loading, show success
            showToast('Files consolidated successfully!', 'success', {duration: 3000});

            let message = `CONSOLIDATION COMPLETE\n\n`;
            message += `Groups processed: ${data.groups_processed}\n`;
            message += `Files deleted: ${data.files_deleted}\n`;
            message += `Space freed: ${formatBytes(data.space_freed)}\n`;

            if (data.errors && data.errors.length > 0) {
                message += `\nErrors encountered: ${data.errors.length}`;
            }

            await alertDialog(message, 'Consolidation Complete', 'success');
            location.reload(); // Refresh to show updated data
        } else {
            showToast('Consolidation failed: ' + (data.message || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        showToast('Error: ' + error.message, 'error');
    });
}

// Dry run summary modal management
let currentDryRunData = null;

function showDryRunSummary(data) {
    currentDryRunData = data;

    // Populate summary statistics
    document.getElementById('summary-groups').textContent = data.groups_processed || 0;
    document.getElementById('summary-files-to-link').textContent = data.files_to_link || 0;
    document.getElementById('summary-files-linked').textContent = data.files_already_linked || 0;
    document.getElementById('summary-space').textContent = formatBytes(data.space_saved || 0);

    // Populate cluster details
    document.getElementById('summary-clusters-needing').textContent = data.clusters_needing_link || 0;
    document.getElementById('summary-clusters-linked').textContent = data.clusters_already_linked || 0;

    // Populate hash breakdown
    const hashBreakdown = data.hash_breakdown || {};
    document.getElementById('summary-hash-full').textContent = hashBreakdown.full_hash || 0;
    document.getElementById('summary-hash-progressive').textContent = hashBreakdown.progressive_hash || 0;
    document.getElementById('summary-hash-quick').textContent = hashBreakdown.quick_hash || 0;

    // Show warnings if any
    const warningsContainer = document.getElementById('summary-warnings-container');
    const warningsList = document.getElementById('summary-warnings-list');
    if (data.warnings && data.warnings.length > 0) {
        warningsContainer.classList.remove('hidden');
        warningsList.innerHTML = '';
        data.warnings.forEach(warning => {
            const li = document.createElement('li');
            li.textContent = warning;
            li.className = 'flex items-start space-x-2';
            warningsList.appendChild(li);
        });
    } else {
        warningsContainer.classList.add('hidden');
    }

    // Populate top groups
    const topGroupsContainer = document.getElementById('summary-top-groups');
    topGroupsContainer.innerHTML = '';

    if (data.top_groups && data.top_groups.length > 0) {
        data.top_groups.forEach((group, index) => {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'flex items-center justify-between p-3 bg-gray-800 border border-gray-700 rounded hover:border-gray-600 transition-colors';
            groupDiv.innerHTML = `
                <div class="flex items-center space-x-3 flex-1">
                    <div class="text-lg font-bold text-gray-400">#${index + 1}</div>
                    <div class="flex-1">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-medium text-gray-100">${formatBytes(group.file_size)} √ó ${group.total_files} files</span>
                            <span class="px-2 py-0.5 text-xs rounded ${
                                group.hash_level === 6 ? 'bg-green-600 text-green-100' :
                                group.hash_level === 1 ? 'bg-yellow-600 text-yellow-100' :
                                'bg-blue-600 text-blue-100'
                            }">${group.hash_level_name}</span>
                        </div>
                        <div class="text-xs text-gray-400 font-mono truncate mt-1">Hash: ${group.hash.substring(0, 16)}...</div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-sm font-semibold text-green-400">${formatBytes(group.savings)}</div>
                    <div class="text-xs text-gray-500">savings</div>
                </div>
            `;
            topGroupsContainer.appendChild(groupDiv);
        });
    } else {
        topGroupsContainer.innerHTML = '<div class="text-center text-gray-400 py-4">No groups to display</div>';
    }

    // Populate files list
    const filesContainer = document.getElementById('summary-files-container');
    const filesList = document.getElementById('summary-files-list');
    const filesCount = document.getElementById('summary-files-count');

    if (data.files_list && data.files_list.length > 0) {
        filesContainer.classList.remove('hidden');
        filesCount.textContent = `(${data.files_list.length} file${data.files_list.length !== 1 ? 's' : ''})`;
        filesList.innerHTML = '';

        data.files_list.forEach(file => {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'p-2 bg-gray-800 border border-gray-700 rounded hover:bg-gray-750 transition-colors';

            // Truncate path for display (show last 60 chars with ellipsis)
            let displayPath = file.path;
            if (displayPath.length > 60) {
                displayPath = '...' + displayPath.substring(displayPath.length - 57);
            }

            fileDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <span class="text-gray-300 font-mono text-xs flex-1 truncate" title="${file.path}">${displayPath}</span>
                    <span class="text-gray-500 text-xs ml-3 shrink-0">${formatBytes(file.size)}</span>
                </div>
            `;
            filesList.appendChild(fileDiv);
        });
    } else {
        // Hide files section if no files
        filesContainer.classList.add('hidden');
    }

    // Show modal
    document.getElementById('dryRunSummaryModal').classList.remove('hidden');
}

function closeDryRunSummary() {
    document.getElementById('dryRunSummaryModal').classList.add('hidden');
    currentDryRunData = null;
}

function confirmAndExecuteHardlinks() {
    closeDryRunSummary();
    executeHardlinks();
}

async function previewHardlinks() {
    const confirmed = await confirmDialog(
        'This will show what would happen without actually creating hardlinks.',
        'Run Dry Run Hardlink?'
    );

    if (!confirmed) {
        return;
    }

    // Show loading toast
    showToast('Analyzing hardlinks...', 'info', {duration: 5000}); // 5 seconds

    // Run dry-run hardlink
    fetch('/api/duplicates/hardlink', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({dry_run: true})
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(async data => {
        console.log('Received data:', data);
        // Dismiss loading toast
        showToast('Analysis complete!', 'success', {duration: 2000});

        if (data.status === 'success') {
            // Show detailed summary modal instead of simple confirm
            showDryRunSummary(data);
        } else {
            console.error('Preview failed, data:', data);
            showToast('Preview failed: ' + (data.message || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error in previewHardlinks:', error);
        showToast('Error: ' + error.message, 'error');
    });
}

async function executeHardlinks() {
    const confirmed = await confirmDialog(
        'This will replace duplicate files with hardlinks.\n\nProceed?',
        'Confirm Hardlink Creation'
    );

    if (!confirmed) {
        return;
    }

    // Show loading toast with long duration for potentially long operation
    showToast('Creating hardlinks...', 'info', {duration: 60000}); // 60 seconds

    fetch('/api/duplicates/hardlink', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({dry_run: false})
    })
    .then(response => response.json())
    .then(async data => {
        if (data.status === 'success') {
            // Dismiss loading, show success
            showToast('Hardlinks created successfully!', 'success', {duration: 3000});

            let message = `HARDLINK CREATION COMPLETE\n\n`;
            message += `Groups processed: ${data.groups_processed}\n`;
            message += `Files hardlinked: ${data.files_linked}\n`;
            message += `Space saved: ${formatBytes(data.space_saved)}\n`;

            if (data.errors && data.errors.length > 0) {
                message += `\nErrors encountered: ${data.errors.length}`;
            }

            await alertDialog(message, 'Hardlink Complete', 'success');
            location.reload(); // Refresh to show updated data
        } else {
            showToast('Hardlink creation failed: ' + (data.message || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        showToast('Error: ' + error.message, 'error');
    });
}

// Single group preview
async function previewSingleGroup(groupHash) {
    // Show loading toast
    showToast('Analyzing group...', 'info', {duration: 5000}); // 5 seconds

    // Run dry-run hardlink for single group
    fetch('/api/duplicates/hardlink', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            dry_run: true,
            group_hashes: [groupHash]
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(async data => {
        // Dismiss loading toast
        showToast('Analysis complete!', 'success', {duration: 2000});

        if (data.status === 'success') {
            // Show detailed summary modal for single group
            showDryRunSummary(data);
        } else {
            showToast('Preview failed: ' + (data.message || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        showToast('Error: ' + error.message, 'error');
    });
}

// Link single group
async function linkSingleGroup(groupHash) {
    const confirmed = await confirmDialog(
        'This will create hardlinks for this group only.\n\nProceed?',
        'Confirm Hardlink Creation'
    );

    if (!confirmed) {
        return;
    }

    executeSingleGroupHardlink(groupHash);
}

// Execute hardlink for single group
function executeSingleGroupHardlink(groupHash) {
    // Show loading toast with long duration
    showToast('Creating hardlinks...', 'info', {duration: 30000}); // 30 seconds

    fetch('/api/duplicates/hardlink', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            dry_run: false,
            group_hashes: [groupHash]
        })
    })
    .then(response => response.json())
    .then(async data => {
        if (data.status === 'success') {
            // Dismiss loading, show success
            showToast('Hardlinks created successfully!', 'success', {duration: 3000});

            let message = `HARDLINK CREATION COMPLETE\n\n`;
            message += `Groups processed: ${data.groups_processed}\n`;
            message += `Files hardlinked: ${data.files_linked}\n`;
            message += `Space saved: ${formatBytes(data.space_saved)}\n`;

            if (data.errors && data.errors.length > 0) {
                message += `\nErrors encountered: ${data.errors.length}`;
            }

            await alertDialog(message, 'Hardlink Complete', 'success');
            location.reload(); // Refresh to show updated data
        } else {
            showToast('Hardlink creation failed: ' + (data.message || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        showToast('Error: ' + error.message, 'error');
    });
}

// Helper function to format bytes
function formatBytes(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}
</script>
{{end}}
