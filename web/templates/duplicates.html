{{template "layout.html" .}}

{{define "content"}}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h2 class="text-3xl font-bold">Duplicate Files</h2>
        <div class="text-gray-400">
            Total potential savings: <span class="text-blue-400 font-semibold">{{.TotalSavings | formatBytes}}</span>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="bg-gray-800 rounded-lg">
        <div class="flex border-b border-gray-700">
            <button
                data-tab="cross-disk"
                class="tab-button px-6 py-3 text-sm font-medium border-b-2 transition-colors {{if or (not .ActiveTab) (eq .ActiveTab "cross-disk")}}border-blue-500 text-blue-400{{else}}border-transparent text-gray-400 hover:text-gray-300{{end}}"
                onclick="switchTab('cross-disk')">
                Cross-Disk Duplicates
                <span class="ml-2 px-2 py-1 text-xs rounded bg-gray-700">{{.CrossDiskCount}}</span>
            </button>
            <button
                data-tab="same-disk"
                class="tab-button px-6 py-3 text-sm font-medium border-b-2 transition-colors {{if eq .ActiveTab "same-disk"}}border-blue-500 text-blue-400{{else}}border-transparent text-gray-400 hover:text-gray-300{{end}}"
                onclick="switchTab('same-disk')">
                Same-Disk Duplicates
                <span class="ml-2 px-2 py-1 text-xs rounded bg-gray-700">{{.SameDiskCount}}</span>
            </button>
        </div>

        <!-- Cross-Disk Tab Content -->
        <div id="cross-disk-tab" class="tab-content {{if eq .ActiveTab "same-disk"}}hidden{{end}} p-6">
            <div class="space-y-4">
                <!-- Summary Card -->
                <div class="bg-gray-750 rounded-lg p-6 border border-gray-700">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <div class="text-sm text-gray-400">Duplicate Groups</div>
                            <div class="text-2xl font-bold text-gray-100">{{.CrossDiskCount}}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-400">Files to Delete</div>
                            <div class="text-2xl font-bold text-gray-100">{{.CrossDiskFilesToDelete}}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-400">Space to Free</div>
                            <div class="text-2xl font-bold text-green-400">{{.CrossDiskSavings | formatBytes}}</div>
                        </div>
                        <div class="flex items-center">
                            {{if gt .CrossDiskCount 0}}
                            <button
                                onclick="previewConsolidation('cross-disk')"
                                class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium transition-colors">
                                Preview Consolidation
                            </button>
                            {{end}}
                        </div>
                    </div>
                </div>

                <!-- Filter Options -->
                <div class="bg-gray-750 rounded-lg p-4 border border-gray-700">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Hash Type</label>
                            <select
                                id="cross-disk-hash-filter"
                                onchange="filterDuplicates('cross-disk', this.value)"
                                class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500">
                                <option value="all">All Hashes</option>
                                <option value="full">Full Hash Only ‚úì</option>
                                <option value="quick">Quick Hash Only ‚ö†Ô∏è</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Minimum Savings</label>
                            <select
                                id="cross-disk-size-filter"
                                onchange="filterBySize('cross-disk', this.value)"
                                class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500">
                                <option value="0">Any Size</option>
                                <option value="10485760">10 MB+</option>
                                <option value="104857600">100 MB+</option>
                                <option value="1073741824">1 GB+</option>
                                <option value="10737418240">10 GB+</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Sort By</label>
                            <select
                                id="cross-disk-sort"
                                onchange="sortDuplicates('cross-disk', this.value)"
                                class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500">
                                <option value="savings">Largest Savings</option>
                                <option value="size">Largest Files</option>
                                <option value="copies">Most Copies</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Duplicate Groups -->
                <div id="cross-disk-groups" class="space-y-4">
                    {{if gt (len .CrossDiskGroups) 0}}
                        {{range .CrossDiskGroups}}
                        <div class="duplicate-group bg-gray-750 rounded-lg border border-gray-700 overflow-hidden" data-size="{{.SpaceSavings}}" data-hash-type="{{.Group.HashType}}">
                            <!-- Group Header -->
                            <div class="bg-gray-800 px-6 py-4 border-b border-gray-700">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-3">
                                            <h3 class="text-lg font-semibold text-gray-100">
                                                {{.Group.TotalSize | formatBytes}} √ó {{.Group.TotalCopies}} copies
                                            </h3>
                                            {{if eq .Group.HashType "quick"}}
                                            <span class="px-2 py-1 text-xs rounded bg-yellow-600 text-yellow-100" title="Quick hash - verify before consolidating">
                                                ‚ö†Ô∏è Quick Hash
                                            </span>
                                            {{else if eq .Group.HashType "full"}}
                                            <span class="px-2 py-1 text-xs rounded bg-green-600 text-green-100" title="Full hash - verified duplicate">
                                                ‚úì Full Hash
                                            </span>
                                            {{end}}
                                        </div>
                                        <div class="text-sm text-gray-400 mt-1 font-mono truncate">
                                            Hash: {{.Group.FileHash}}
                                        </div>
                                        <div class="text-sm text-gray-400 mt-1">
                                            Algorithm: {{.Group.HashAlgorithm}} | Disks: {{.Group.UniqueDiskCount}}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm text-gray-400">Potential Savings</div>
                                        <div class="text-xl font-bold text-green-400">{{.SpaceSavings | formatBytes}}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- File Entries -->
                            <div class="px-6 py-4 space-y-3">
                                {{range .Group.Files}}
                                <div class="file-entry flex items-center justify-between p-3 rounded {{if eq .ID $.KeepFile.ID}}bg-green-900 bg-opacity-20 border border-green-700{{else}}bg-red-900 bg-opacity-20 border border-red-700{{end}}">
                                    <div class="flex items-center space-x-3 flex-1 min-w-0">
                                        {{if eq .ID $.KeepFile.ID}}
                                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-green-600 flex items-center justify-center text-white font-bold">
                                            ‚úì
                                        </div>
                                        {{else}}
                                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-red-600 flex items-center justify-center text-white font-bold">
                                            ‚úó
                                        </div>
                                        {{end}}
                                        <div class="flex-1 min-w-0">
                                            <div class="text-sm font-medium text-gray-100 truncate">{{.Path}}</div>
                                            <div class="flex items-center space-x-4 mt-1">
                                                <span class="text-xs text-gray-400">
                                                    {{if .DiskName}}{{.DiskName}}{{else}}Device {{.DeviceID}}{{end}}
                                                    {{if .DiskUsedPercent}}
                                                    ({{printf "%.1f" .DiskUsedPercent}}% full)
                                                    {{end}}
                                                </span>
                                                {{if .IsOrphaned}}
                                                <span class="px-2 py-0.5 text-xs rounded bg-gray-600 text-gray-300">
                                                    Orphaned
                                                </span>
                                                {{end}}
                                                {{if .ServiceUsage}}
                                                <span class="text-xs text-gray-400">
                                                    Used by: {{range $i, $svc := .ServiceUsage}}{{if $i}}, {{end}}{{$svc}}{{end}}
                                                </span>
                                                {{end}}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex-shrink-0 ml-4 text-right">
                                        {{if eq .ID $.KeepFile.ID}}
                                        <div class="text-sm font-medium text-green-400">KEEP</div>
                                        <div class="text-xs text-gray-400">{{$.ReasonToKeep}}</div>
                                        {{else}}
                                        <div class="text-sm font-medium text-red-400">DELETE</div>
                                        <div class="text-xs text-gray-400">Free {{.Size | formatBytes}}</div>
                                        {{end}}
                                    </div>
                                </div>
                                {{end}}
                            </div>
                        </div>
                        {{end}}
                    {{else}}
                        <div class="bg-gray-750 rounded-lg p-12 text-center border border-gray-700">
                            <div class="text-gray-400 text-lg">No cross-disk duplicates found</div>
                            <div class="text-gray-500 text-sm mt-2">
                                Files with identical hashes on different disks will appear here
                            </div>
                        </div>
                    {{end}}
                </div>
            </div>
        </div>

        <!-- Same-Disk Tab Content -->
        <div id="same-disk-tab" class="tab-content {{if or (not .ActiveTab) (eq .ActiveTab "cross-disk")}}hidden{{end}} p-6">
            <div class="space-y-4">
                <!-- Summary Card -->
                <div class="bg-gray-750 rounded-lg p-6 border border-gray-700">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <div class="text-sm text-gray-400">Hardlink Groups</div>
                            <div class="text-2xl font-bold text-gray-100">{{.SameDiskCount}}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-400">Files to Link</div>
                            <div class="text-2xl font-bold text-gray-100">{{.SameDiskFilesToLink}}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-400">Space to Save</div>
                            <div class="text-2xl font-bold text-green-400">{{.SameDiskSavings | formatBytes}}</div>
                        </div>
                        <div class="flex items-center">
                            {{if gt .SameDiskCount 0}}
                            <button
                                onclick="previewHardlinks()"
                                class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium transition-colors">
                                Preview Hardlinks
                            </button>
                            {{end}}
                        </div>
                    </div>
                </div>

                <!-- Duplicate Groups -->
                <div id="same-disk-groups" class="space-y-4">
                    {{if gt (len .SameDiskGroups) 0}}
                        {{range .SameDiskGroups}}
                        <div class="duplicate-group bg-gray-750 rounded-lg border border-gray-700 overflow-hidden">
                            <!-- Group Header -->
                            <div class="bg-gray-800 px-6 py-4 border-b border-gray-700">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-3">
                                            <h3 class="text-lg font-semibold text-gray-100">
                                                {{.Group.TotalSize | formatBytes}} √ó {{.Group.TotalCopies}} copies
                                            </h3>
                                            {{if eq .Group.HashType "quick"}}
                                            <span class="px-2 py-1 text-xs rounded bg-yellow-600 text-yellow-100">
                                                ‚ö†Ô∏è Quick Hash
                                            </span>
                                            {{else if eq .Group.HashType "full"}}
                                            <span class="px-2 py-1 text-xs rounded bg-green-600 text-green-100">
                                                ‚úì Full Hash
                                            </span>
                                            {{end}}
                                        </div>
                                        <div class="text-sm text-gray-400 mt-1 font-mono truncate">
                                            Hash: {{.Group.FileHash}}
                                        </div>
                                        <div class="text-sm text-gray-400 mt-1">
                                            Disk: {{if .KeepDisk}}{{.KeepDisk.Name}}{{else}}Unknown{{end}}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm text-gray-400">Potential Savings</div>
                                        <div class="text-xl font-bold text-green-400">{{.SpaceSavings | formatBytes}}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- File Entries -->
                            <div class="px-6 py-4 space-y-3">
                                {{range .Group.Files}}
                                <div class="file-entry flex items-center justify-between p-3 rounded {{if eq .ID $.KeepFile.ID}}bg-blue-900 bg-opacity-20 border border-blue-700{{else}}bg-gray-700 bg-opacity-40 border border-gray-600{{end}}">
                                    <div class="flex items-center space-x-3 flex-1 min-w-0">
                                        {{if eq .ID $.KeepFile.ID}}
                                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold">
                                            ‚òÖ
                                        </div>
                                        {{else}}
                                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center text-white">
                                            üîó
                                        </div>
                                        {{end}}
                                        <div class="flex-1 min-w-0">
                                            <div class="text-sm font-medium text-gray-100 truncate">{{.Path}}</div>
                                            <div class="flex items-center space-x-4 mt-1">
                                                {{if .ServiceUsage}}
                                                <span class="text-xs text-gray-400">
                                                    Used by: {{range $i, $svc := .ServiceUsage}}{{if $i}}, {{end}}{{$svc}}{{end}}
                                                </span>
                                                {{else if .IsOrphaned}}
                                                <span class="px-2 py-0.5 text-xs rounded bg-gray-600 text-gray-300">
                                                    Orphaned
                                                </span>
                                                {{end}}
                                                <span class="text-xs text-gray-500">
                                                    Modified: {{.ModifiedTime | formatTimestamp}}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex-shrink-0 ml-4 text-right">
                                        {{if eq .ID $.KeepFile.ID}}
                                        <div class="text-sm font-medium text-blue-400">PRIMARY</div>
                                        <div class="text-xs text-gray-400">{{$.ReasonToKeep}}</div>
                                        {{else}}
                                        <div class="text-sm font-medium text-gray-400">LINK TO PRIMARY</div>
                                        <div class="text-xs text-gray-400">Save {{.Size | formatBytes}}</div>
                                        {{end}}
                                    </div>
                                </div>
                                {{end}}
                            </div>
                        </div>
                        {{end}}
                    {{else}}
                        <div class="bg-gray-750 rounded-lg p-12 text-center border border-gray-700">
                            <div class="text-gray-400 text-lg">No same-disk duplicates found</div>
                            <div class="text-gray-500 text-sm mt-2">
                                Files with identical hashes on the same disk will appear here
                            </div>
                        </div>
                    {{end}}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Tab switching
function switchTab(tabName) {
    // Update URL without reload
    const url = new URL(window.location);
    url.searchParams.set('tab', tabName);
    window.history.pushState({}, '', url);

    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });

    // Show selected tab
    document.getElementById(tabName + '-tab').classList.remove('hidden');

    // Update tab button styles
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('border-blue-500', 'text-blue-400');
        btn.classList.add('border-transparent', 'text-gray-400');
    });

    const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
    activeBtn.classList.remove('border-transparent', 'text-gray-400');
    activeBtn.classList.add('border-blue-500', 'text-blue-400');
}

// Filter and sort functions (to be implemented in Phase 4)
function filterDuplicates(type, hashType) {
    console.log('Filter duplicates:', type, hashType);
    // TODO: Implement filtering
}

function filterBySize(type, minSize) {
    console.log('Filter by size:', type, minSize);
    // TODO: Implement size filtering
}

function sortDuplicates(type, sortBy) {
    console.log('Sort duplicates:', type, sortBy);
    // TODO: Implement sorting
}

function previewConsolidation(type) {
    if (!confirm('Do you want to run a DRY RUN consolidation first?\n\nThis will show what would happen without actually deleting files.')) {
        return;
    }

    // Run dry-run consolidation
    fetch('/api/duplicates/consolidate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({dry_run: true})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            let message = `DRY RUN COMPLETE\n\n`;
            message += `Groups processed: ${data.groups_processed}\n`;
            message += `Files to delete: ${data.files_deleted}\n`;
            message += `Space to free: ${formatBytes(data.space_freed)}\n`;

            if (data.errors && data.errors.length > 0) {
                message += `\nErrors: ${data.errors.length}`;
            }

            message += '\n\nProceed with actual consolidation?';

            if (confirm(message)) {
                executeConsolidation();
            }
        } else {
            alert('Preview failed: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function executeConsolidation() {
    if (!confirm('‚ö†Ô∏è WARNING: This will DELETE files!\n\nAre you absolutely sure you want to proceed?')) {
        return;
    }

    fetch('/api/duplicates/consolidate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({dry_run: false})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            let message = `CONSOLIDATION COMPLETE\n\n`;
            message += `Groups processed: ${data.groups_processed}\n`;
            message += `Files deleted: ${data.files_deleted}\n`;
            message += `Space freed: ${formatBytes(data.space_freed)}\n`;

            if (data.errors && data.errors.length > 0) {
                message += `\nErrors encountered: ${data.errors.length}`;
            }

            alert(message);
            location.reload(); // Refresh to show updated data
        } else {
            alert('Consolidation failed: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function previewHardlinks() {
    if (!confirm('Do you want to run a DRY RUN hardlink operation first?\n\nThis will show what would happen without actually creating hardlinks.')) {
        return;
    }

    // Run dry-run hardlink
    fetch('/api/duplicates/hardlink', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({dry_run: true})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            let message = `DRY RUN COMPLETE\n\n`;
            message += `Groups processed: ${data.groups_processed}\n`;
            message += `Files to hardlink: ${data.files_linked}\n`;
            message += `Space to save: ${formatBytes(data.space_saved)}\n`;

            if (data.errors && data.errors.length > 0) {
                message += `\nErrors: ${data.errors.length}`;
            }

            message += '\n\nProceed with actual hardlink creation?';

            if (confirm(message)) {
                executeHardlinks();
            }
        } else {
            alert('Preview failed: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function executeHardlinks() {
    if (!confirm('This will replace duplicate files with hardlinks.\n\nProceed?')) {
        return;
    }

    fetch('/api/duplicates/hardlink', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({dry_run: false})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            let message = `HARDLINK CREATION COMPLETE\n\n`;
            message += `Groups processed: ${data.groups_processed}\n`;
            message += `Files hardlinked: ${data.files_linked}\n`;
            message += `Space saved: ${formatBytes(data.space_saved)}\n`;

            if (data.errors && data.errors.length > 0) {
                message += `\nErrors encountered: ${data.errors.length}`;
            }

            alert(message);
            location.reload(); // Refresh to show updated data
        } else {
            alert('Hardlink creation failed: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

// Helper function to format bytes
function formatBytes(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}
</script>
{{end}}
