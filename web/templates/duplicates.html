{{template "layout.html" .}}

{{define "content"}}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h2 class="text-3xl font-bold">Duplicate Files</h2>
        <div class="text-gray-400">
            Total potential savings: <span class="text-blue-400 font-semibold">{{.TotalSavings | formatBytes}}</span>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="bg-gray-800 rounded-lg">
        <div class="flex border-b border-gray-700">
            <button
                data-tab="same-disk"
                class="tab-button px-6 py-3 text-sm font-medium border-b-2 transition-colors {{if or (not .ActiveTab) (eq .ActiveTab "same-disk")}}border-blue-500 text-blue-400{{else}}border-transparent text-gray-400 hover:text-gray-300{{end}}"
                onclick="switchTab('same-disk')">
                Same-Disk Duplicates
                <span class="ml-2 px-2 py-1 text-xs rounded bg-gray-700">{{.SameDiskCount}}</span>
            </button>
            <button
                data-tab="cross-disk"
                class="tab-button px-6 py-3 text-sm font-medium border-b-2 transition-colors {{if eq .ActiveTab "cross-disk"}}border-blue-500 text-blue-400{{else}}border-transparent text-gray-400 hover:text-gray-300{{end}}"
                onclick="switchTab('cross-disk')">
                Cross-Disk Duplicates
                <span class="ml-2 px-2 py-1 text-xs rounded bg-gray-700">{{.CrossDiskCount}}</span>
            </button>
        </div>

        <!-- Cross-Disk Tab Content -->
        <div id="cross-disk-tab" class="tab-content {{if or (not .ActiveTab) (eq .ActiveTab "same-disk")}}hidden{{end}} p-6">
            <div class="space-y-4">
                <!-- Summary Card -->
                <div class="bg-gray-750 rounded-lg p-6 border border-gray-700">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <div class="text-sm text-gray-400">Duplicate Groups</div>
                            <div class="text-2xl font-bold text-gray-100">{{.CrossDiskCount}}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-400">Files to Delete</div>
                            <div class="text-2xl font-bold text-gray-100">{{.CrossDiskFilesToDelete}}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-400">Space to Free</div>
                            <div class="text-2xl font-bold text-green-400">{{.CrossDiskSavings | formatBytes}}</div>
                        </div>
                        <div class="flex items-center">
                            {{if gt .CrossDiskCount 0}}
                            <button
                                id="preview-button-cross-disk"
                                onclick="previewConsolidation('cross-disk')"
                                class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium transition-colors flex items-center justify-center gap-2">
                                <span class="preview-button-loading">Loading...</span>
                                <span class="preview-button-text hidden flex items-center gap-2">
                                    <span class="preview-icon"></span>
                                    <span>Preview All ({{.CrossDiskCount}} groups)</span>
                                </span>
                            </button>
                            {{end}}
                        </div>
                    </div>
                </div>

                <!-- Filter Options -->
                <div class="bg-gray-750 rounded-lg p-4 border border-gray-700">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Hash Type Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Hash Type</label>
                            <div class="relative" data-custom-dropdown>
                                <input type="hidden" id="cross-disk-hash-filter" value="all" data-dropdown-input>
                                <button
                                    type="button"
                                    data-dropdown-button
                                    aria-expanded="false"
                                    class="w-full px-4 py-2 pr-10 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 text-gray-100 text-left">
                                    <span data-dropdown-text>All Hashes</span>
                                    <svg class="w-4 h-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div data-dropdown-menu class="hidden absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg max-h-60 overflow-auto">
                                    <div data-dropdown-option data-value="all" class="px-4 py-2 text-sm hover:bg-gray-600 text-gray-100 bg-blue-600" aria-selected="true">All Hashes</div>
                                    <div data-dropdown-option data-value="full" class="px-4 py-2 text-sm hover:bg-gray-600 text-gray-100 flex items-center space-x-2" aria-selected="false">
                                        <svg class="w-3.5 h-3.5 text-green-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        <span>Full Hash Only</span>
                                    </div>
                                    <div data-dropdown-option data-value="progressive" class="px-4 py-2 text-sm hover:bg-gray-600 text-gray-100 flex items-center space-x-2" aria-selected="false">
                                        <svg class="w-3.5 h-3.5 text-blue-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        <span>Progressive Hash Only</span>
                                    </div>
                                    <div data-dropdown-option data-value="quick" class="px-4 py-2 text-sm hover:bg-gray-600 text-gray-100 flex items-center space-x-2" aria-selected="false">
                                        <svg class="w-3.5 h-3.5 text-yellow-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                        </svg>
                                        <span>Quick Hash Only</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Minimum Savings Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Minimum Savings</label>
                            <div class="relative" data-custom-dropdown>
                                <input type="hidden" id="cross-disk-size-filter" value="0" data-dropdown-input>
                                <button
                                    type="button"
                                    data-dropdown-button
                                    aria-expanded="false"
                                    class="w-full px-4 py-2 pr-10 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 text-gray-100 text-left">
                                    <span data-dropdown-text>Any Size</span>
                                    <svg class="w-4 h-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div data-dropdown-menu class="hidden absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg max-h-60 overflow-auto">
                                    <div data-dropdown-option data-value="0" class="px-4 py-2 text-sm hover:bg-gray-600 text-gray-100 bg-blue-600" aria-selected="true">Any Size</div>
                                    <div data-dropdown-option data-value="10485760" class="px-4 py-2 text-sm hover:bg-gray-600 text-gray-100" aria-selected="false">10 MB+</div>
                                    <div data-dropdown-option data-value="104857600" class="px-4 py-2 text-sm hover:bg-gray-600 text-gray-100" aria-selected="false">100 MB+</div>
                                    <div data-dropdown-option data-value="1073741824" class="px-4 py-2 text-sm hover:bg-gray-600 text-gray-100" aria-selected="false">1 GB+</div>
                                    <div data-dropdown-option data-value="10737418240" class="px-4 py-2 text-sm hover:bg-gray-600 text-gray-100" aria-selected="false">10 GB+</div>
                                </div>
                            </div>
                        </div>
                        <!-- Sort By Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Sort By</label>
                            <div class="relative" data-custom-dropdown>
                                <input type="hidden" id="cross-disk-sort" value="savings" data-dropdown-input>
                                <button
                                    type="button"
                                    data-dropdown-button
                                    aria-expanded="false"
                                    class="w-full px-4 py-2 pr-10 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 text-gray-100 text-left">
                                    <span data-dropdown-text>Largest Savings</span>
                                    <svg class="w-4 h-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div data-dropdown-menu class="hidden absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg max-h-60 overflow-auto">
                                    <div data-dropdown-option data-value="savings" class="px-4 py-2 text-sm hover:bg-gray-600 text-gray-100 bg-blue-600" aria-selected="true">Largest Savings</div>
                                    <div data-dropdown-option data-value="size" class="px-4 py-2 text-sm hover:bg-gray-600 text-gray-100" aria-selected="false">Largest Files</div>
                                    <div data-dropdown-option data-value="copies" class="px-4 py-2 text-sm hover:bg-gray-600 text-gray-100" aria-selected="false">Most Copies</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Duplicate Groups -->
                <div id="cross-disk-groups" class="space-y-4">
                    {{range $plan := .CrossDiskGroups}}
                        <div class="duplicate-group bg-gray-750 rounded-lg border border-gray-700 overflow-hidden" data-size="{{$plan.SpaceSavings}}" data-hash-type="{{if gt $plan.Group.HashLevel 0}}{{if eq $plan.Group.HashLevel 6}}full{{else if eq $plan.Group.HashLevel 1}}quick{{else}}progressive{{end}}{{else}}{{$plan.Group.HashType}}{{end}}" data-copies="{{$plan.Group.TotalCopies}}" data-file-size="{{$plan.Group.TotalSize}}">
                            <!-- Group Header -->
                            <div class="bg-gray-800 px-6 py-4 border-b border-gray-700">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-3">
                                            <h3 class="text-lg font-semibold text-gray-100">
                                                {{$plan.Group.TotalSize | formatBytes}} × {{$plan.Group.TotalCopies}} copies
                                            </h3>
                                            {{if gt $plan.Group.HashLevel 0}}
                                                {{if eq $plan.Group.HashLevel 6}}
                                                <span class="px-2 py-1 text-xs rounded bg-green-600 text-green-100 inline-flex items-center space-x-1" title="Full hash - verified duplicate">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                    </svg>
                                                    <span>Full Hash</span>
                                                </span>
                                                {{else if eq $plan.Group.HashLevel 1}}
                                                <span class="px-2 py-1 text-xs rounded bg-yellow-600 text-yellow-100 inline-flex items-center space-x-1" title="Quick hash - verify before consolidating">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                                    </svg>
                                                    <span>Quick Hash</span>
                                                </span>
                                                {{else}}
                                                <span class="px-2 py-1 text-xs rounded bg-blue-600 text-blue-100 inline-flex items-center space-x-1" title="Progressive hash - level {{$plan.Group.HashLevel}}">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                                    </svg>
                                                    <span>{{hashLevelName $plan.Group.HashLevel}}</span>
                                                </span>
                                                {{end}}
                                            {{else}}
                                                {{if eq $plan.Group.HashType "quick"}}
                                                <span class="px-2 py-1 text-xs rounded bg-yellow-600 text-yellow-100 inline-flex items-center space-x-1" title="Quick hash - verify before consolidating">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                                    </svg>
                                                    <span>Quick Hash</span>
                                                </span>
                                                {{else if eq $plan.Group.HashType "full"}}
                                                <span class="px-2 py-1 text-xs rounded bg-green-600 text-green-100 inline-flex items-center space-x-1" title="Full hash - verified duplicate">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                    </svg>
                                                    <span>Full Hash</span>
                                                </span>
                                                {{end}}
                                            {{end}}
                                        </div>
                                        <div class="text-sm text-gray-400 mt-1 font-mono truncate">
                                            Hash: {{$plan.Group.FileHash}}
                                        </div>
                                        <div class="text-sm text-gray-400 mt-1">
                                            Algorithm: {{$plan.Group.HashAlgorithm}} | Disks: {{$plan.Group.UniqueDiskCount}}
                                        </div>
                                    </div>
                                    <div class="flex flex-col items-end space-y-3">
                                        <div class="text-right">
                                            <div class="text-sm text-gray-400">Potential Savings</div>
                                            <div class="text-xl font-bold text-green-400">{{$plan.SpaceSavings | formatBytes}}</div>
                                        </div>
                                        <div class="flex space-x-2">
                                            {{$maxLevel := maxProgressiveLevel $plan.Group.TotalSize}}
                                            {{if lt $plan.Group.HashLevel $maxLevel}}
                                            <button onclick="upgradeGroupProgressive('{{$plan.Group.FileHash}}')" class="px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white text-sm rounded font-medium transition-colors flex items-center space-x-1" title="Upgrade to next progressive hash level">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12"></path>
                                                </svg>
                                                <span>Upgrade Progressive</span>
                                            </button>
                                            {{end}}
                                            {{if lt $plan.Group.HashLevel 6}}
                                            <button onclick="upgradeGroupToFull('{{$plan.Group.FileHash}}')" class="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white text-sm rounded font-medium transition-colors flex items-center space-x-1" title="Upgrade to full hash">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                                </svg>
                                                <span>Upgrade to Full</span>
                                            </button>
                                            {{end}}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- File Entries -->
                            <div class="px-6 py-4 space-y-3">
                                {{range $plan.Group.Files}}
                                <div class="file-entry flex items-center justify-between p-3 rounded {{if eq .ID $plan.KeepFile.ID}}bg-green-900 bg-opacity-20 border border-green-700{{else}}bg-red-900 bg-opacity-20 border border-red-700{{end}}">
                                    <div class="flex items-center space-x-3 flex-1 min-w-0">
                                        {{if eq .ID $plan.KeepFile.ID}}
                                        <div class="shrink-0 w-8 h-8 rounded-full bg-green-600 flex items-center justify-center text-white font-bold">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                        </div>
                                        {{else}}
                                        <div class="shrink-0 w-8 h-8 rounded-full bg-red-600 flex items-center justify-center text-white font-bold">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </div>
                                        {{end}}
                                        <div class="flex-1 min-w-0">
                                            <div class="text-sm font-medium text-gray-100 truncate">{{.Path}}</div>
                                            <div class="flex items-center space-x-4 mt-1">
                                                <span class="text-xs text-gray-400">
                                                    {{if .DiskName}}{{.DiskName}}{{else}}Device {{.DeviceID}}{{end}}
                                                    {{if .DiskUsedPercent}}
                                                    ({{printf "%.1f" .DiskUsedPercent}}% full)
                                                    {{end}}
                                                </span>
                                                {{if .IsOrphaned}}
                                                <span class="px-2 py-0.5 text-xs rounded bg-gray-600 text-gray-300">
                                                    Orphaned
                                                </span>
                                                {{end}}
                                                {{if .ServiceUsage}}
                                                <span class="text-xs text-gray-400">
                                                    Used by: {{range $i, $svc := .ServiceUsage}}{{if $i}}, {{end}}{{$svc}}{{end}}
                                                </span>
                                                {{end}}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="shrink-0 ml-4 text-right">
                                        {{if eq .ID $plan.KeepFile.ID}}
                                        <div class="text-sm font-medium text-green-400">KEEP</div>
                                        <div class="text-xs text-gray-400">{{$plan.ReasonToKeep}}</div>
                                        {{else}}
                                        <div class="text-sm font-medium text-red-400">DELETE</div>
                                        <div class="text-xs text-gray-400">Free {{.Size | formatBytes}}</div>
                                        {{end}}
                                    </div>
                                </div>
                                {{end}}
                            </div>
                        </div>
                    {{else}}
                        <div class="bg-gray-750 rounded-lg p-12 text-center border border-gray-700">
                            <div class="text-gray-400 text-lg">No cross-disk duplicates found</div>
                            <div class="text-gray-500 text-sm mt-2">
                                Files with identical hashes on different disks will appear here
                            </div>
                        </div>
                    {{end}}
                </div>
            </div>
        </div>

        <!-- Same-Disk Tab Content -->
        <div id="same-disk-tab" class="tab-content {{if eq .ActiveTab "cross-disk"}}hidden{{end}} p-6">
            <div class="space-y-4">
                <!-- Summary Card -->
                <div class="bg-gray-750 rounded-lg p-6 border border-gray-700">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <div class="text-sm text-gray-400">Hardlink Groups</div>
                            <div class="text-2xl font-bold text-gray-100">{{.SameDiskCount}}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-400">Files to Link</div>
                            <div class="text-2xl font-bold text-gray-100">{{.SameDiskFilesToLink}}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-400">Space to Save</div>
                            <div class="text-2xl font-bold text-green-400">{{.SameDiskSavings | formatBytes}}</div>
                        </div>
                        <div class="flex items-center">
                            {{if gt .SameDiskCount 0}}
                            <button
                                id="preview-button-same-disk"
                                onclick="previewHardlinks()"
                                class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium transition-colors flex items-center justify-center gap-2">
                                <span class="preview-button-loading">Loading...</span>
                                <span class="preview-button-text hidden flex items-center gap-2">
                                    <span class="preview-icon"></span>
                                    <span>Preview All ({{.SameDiskCount}} groups)</span>
                                </span>
                            </button>
                            {{end}}
                        </div>
                    </div>
                </div>

                <!-- Filter Options -->
                <div class="bg-gray-750 rounded-lg p-4 border border-gray-700">
                    <form id="same-disk-filters-form">
                    <div class="grid grid-cols-1 gap-4 mb-3">
                        <!-- Search Input -->
                        <div>
                            <label for="same-disk-search" class="block text-sm font-medium text-gray-400 mb-2">Search</label>
                            <input type="text" id="same-disk-search" name="search" placeholder="Search paths or hashes..."
                                   class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Hash Type Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Hash Type</label>
                            <div class="relative" data-custom-dropdown>
                                <input type="hidden" id="same-disk-hash-filter" name="hash_type" value="all" data-dropdown-input>
                                <button
                                    type="button"
                                    data-dropdown-button
                                    aria-expanded="false"
                                    class="w-full px-4 py-2 pr-10 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 text-gray-100 text-left">
                                    <span data-dropdown-text>All Hashes</span>
                                    <svg class="w-4 h-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div data-dropdown-menu class="hidden absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg max-h-60 overflow-auto">
                                    <div data-dropdown-option data-value="all" class="px-4 py-2 text-sm hover:bg-gray-600 text-gray-100 bg-blue-600" aria-selected="true">All Hashes</div>
                                    <div data-dropdown-option data-value="full" class="px-4 py-2 text-sm hover:bg-gray-600 text-gray-100 flex items-center space-x-2" aria-selected="false">
                                        <svg class="w-3.5 h-3.5 text-green-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        <span>Full Hash Only</span>
                                    </div>
                                    <div data-dropdown-option data-value="progressive" class="px-4 py-2 text-sm hover:bg-gray-600 text-gray-100 flex items-center space-x-2" aria-selected="false">
                                        <svg class="w-3.5 h-3.5 text-blue-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        <span>Progressive Hash Only</span>
                                    </div>
                                    <div data-dropdown-option data-value="quick" class="px-4 py-2 text-sm hover:bg-gray-600 text-gray-100 flex items-center space-x-2" aria-selected="false">
                                        <svg class="w-3.5 h-3.5 text-yellow-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                        </svg>
                                        <span>Quick Hash Only</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Minimum Savings Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Minimum Savings</label>
                            <div class="relative" data-custom-dropdown>
                                <input type="hidden" id="same-disk-size-filter" name="min_size" value="" data-dropdown-input>
                                <button
                                    type="button"
                                    data-dropdown-button
                                    aria-expanded="false"
                                    class="w-full px-4 py-2 pr-10 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 text-gray-100 text-left">
                                    <span data-dropdown-text>Any Size</span>
                                    <svg class="w-4 h-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div data-dropdown-menu class="hidden absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg max-h-60 overflow-auto">
                                    <div data-dropdown-option data-value="" class="px-4 py-2 text-sm hover:bg-gray-600 text-gray-100 bg-blue-600" aria-selected="true">Any Size</div>
                                    <div data-dropdown-option data-value="1gb" class="px-4 py-2 text-sm hover:bg-gray-600 text-gray-100" aria-selected="false">1 GB+</div>
                                    <div data-dropdown-option data-value="10gb" class="px-4 py-2 text-sm hover:bg-gray-600 text-gray-100" aria-selected="false">10 GB+</div>
                                    <div data-dropdown-option data-value="100gb" class="px-4 py-2 text-sm hover:bg-gray-600 text-gray-100" aria-selected="false">100 GB+</div>
                                    <div data-dropdown-option data-value="1tb" class="px-4 py-2 text-sm hover:bg-gray-600 text-gray-100" aria-selected="false">1 TB+</div>
                                </div>
                            </div>
                        </div>
                        <!-- Sort By Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Sort By</label>
                            <div class="relative" data-custom-dropdown>
                                <input type="hidden" id="same-disk-sort" name="sort" value="savings" data-dropdown-input>
                                <button
                                    type="button"
                                    data-dropdown-button
                                    aria-expanded="false"
                                    class="w-full px-4 py-2 pr-10 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 text-gray-100 text-left">
                                    <span data-dropdown-text>Largest Savings</span>
                                    <svg class="w-4 h-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div data-dropdown-menu class="hidden absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg max-h-60 overflow-auto">
                                    <div data-dropdown-option data-value="savings" class="px-4 py-2 text-sm hover:bg-gray-600 text-gray-100 bg-blue-600" aria-selected="true">Largest Savings</div>
                                    <div data-dropdown-option data-value="size" class="px-4 py-2 text-sm hover:bg-gray-600 text-gray-100" aria-selected="false">Largest Files</div>
                                    <div data-dropdown-option data-value="copies" class="px-4 py-2 text-sm hover:bg-gray-600 text-gray-100" aria-selected="false">Most Copies</div>
                                </div>
                            </div>
                        </div>
                        <!-- Items Per Page Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Items Per Page</label>
                            <div class="relative" data-custom-dropdown>
                                <input type="hidden" id="same-disk-limit" name="limit" value="25" data-dropdown-input>
                                <button
                                    type="button"
                                    data-dropdown-button
                                    aria-expanded="false"
                                    class="w-full px-4 py-2 pr-10 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 text-gray-100 text-left">
                                    <span data-dropdown-text>25</span>
                                    <svg class="w-4 h-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div data-dropdown-menu class="hidden absolute z-50 w-full mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg max-h-60 overflow-auto">
                                    <div data-dropdown-option data-value="10" class="px-4 py-2 text-sm hover:bg-gray-600 text-gray-100" aria-selected="false">10</div>
                                    <div data-dropdown-option data-value="25" class="px-4 py-2 text-sm hover:bg-gray-600 text-gray-100 bg-blue-600" aria-selected="true">25</div>
                                    <div data-dropdown-option data-value="50" class="px-4 py-2 text-sm hover:bg-gray-600 text-gray-100" aria-selected="false">50</div>
                                    <div data-dropdown-option data-value="100" class="px-4 py-2 text-sm hover:bg-gray-600 text-gray-100" aria-selected="false">100</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 flex gap-2">
                        <button type="button" id="apply-same-disk-filters" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded transition flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                            </svg>
                            Apply Filters
                        </button>
                        <button type="button" id="clear-same-disk-filters" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded transition flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            Clear
                        </button>
                    </div>
                    </form>
                </div>

                <!-- Duplicate Groups -->
                <div id="same-disk-groups-container" class="bg-gray-750 rounded-lg border border-gray-700">
                    {{if .SameDiskGroups}}
                    <!-- Groups Summary -->
                    <div class="px-6 py-4 border-b border-gray-700">
                        <p class="text-sm text-gray-400">
                            Showing {{len .SameDiskGroups}} of {{.Total}} groups
                            {{if gt .TotalPages 1}} (Page {{.Page}} of {{.TotalPages}}){{end}}
                        </p>
                    </div>

                    <!-- Duplicate Groups -->
                    <div id="same-disk-groups" class="space-y-4 p-6">
                    {{range $plan := .SameDiskGroups}}
                        <div class="duplicate-group bg-gray-750 rounded-lg border border-gray-700 overflow-hidden" data-size="{{$plan.SpaceSavings}}" data-hash-type="{{if gt $plan.Group.HashLevel 0}}{{if eq $plan.Group.HashLevel 6}}full{{else if eq $plan.Group.HashLevel 1}}quick{{else}}progressive{{end}}{{else}}{{$plan.Group.HashType}}{{end}}" data-copies="{{$plan.Group.TotalCopies}}" data-file-size="{{$plan.Group.TotalSize}}">
                            <!-- Group Header -->
                            <div class="bg-gray-800 px-6 py-4 border-b border-gray-700">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-3">
                                            <h3 class="text-lg font-semibold text-gray-100">
                                                {{$plan.Group.TotalSize | formatBytes}} × {{$plan.TotalFiles}} files in {{$plan.ActualCopies}} cluster(s)
                                            </h3>
                                            {{if gt $plan.Group.HashLevel 0}}
                                                {{if eq $plan.Group.HashLevel 6}}
                                                <span class="px-2 py-1 text-xs rounded bg-green-600 text-green-100 inline-flex items-center space-x-1" title="Full hash - verified duplicate">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                    </svg>
                                                    <span>Full Hash</span>
                                                </span>
                                                {{else if eq $plan.Group.HashLevel 1}}
                                                <span class="px-2 py-1 text-xs rounded bg-yellow-600 text-yellow-100 inline-flex items-center space-x-1" title="Quick hash - verify before consolidating">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                                    </svg>
                                                    <span>Quick Hash</span>
                                                </span>
                                                {{else}}
                                                <span class="px-2 py-1 text-xs rounded bg-blue-600 text-blue-100 inline-flex items-center space-x-1" title="Progressive hash - level {{$plan.Group.HashLevel}}">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                                    </svg>
                                                    <span>{{hashLevelName $plan.Group.HashLevel}}</span>
                                                </span>
                                                {{end}}
                                            {{else}}
                                                {{if eq $plan.Group.HashType "quick"}}
                                                <span class="px-2 py-1 text-xs rounded bg-yellow-600 text-yellow-100 inline-flex items-center space-x-1" title="Quick hash - verify before consolidating">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                                    </svg>
                                                    <span>Quick Hash</span>
                                                </span>
                                                {{else if eq $plan.Group.HashType "full"}}
                                                <span class="px-2 py-1 text-xs rounded bg-green-600 text-green-100 inline-flex items-center space-x-1" title="Full hash - verified duplicate">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                    </svg>
                                                    <span>Full Hash</span>
                                                </span>
                                                {{end}}
                                            {{end}}
                                        </div>
                                        {{if gt (len $plan.AlreadyLinked) 0}}
                                        <div class="text-sm text-blue-400 mt-1 flex items-center space-x-1">
                                            <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            <span>{{len $plan.AlreadyLinked}} cluster(s) already internally linked</span>
                                        </div>
                                        {{end}}
                                        <div class="text-sm text-gray-400 mt-1 font-mono truncate">
                                            Hash: {{$plan.Group.FileHash}}
                                        </div>
                                        <div class="text-sm text-gray-400 mt-1">
                                            Disk: {{if $plan.KeepDisk}}{{$plan.KeepDisk.Name}}{{else}}Unknown{{end}}
                                        </div>
                                    </div>
                                    <div class="text-right space-y-3">
                                        <div>
                                            <div class="text-sm text-gray-400">Actual Savings</div>
                                            <div class="text-xl font-bold text-green-400">{{$plan.SpaceSavings | formatBytes}}</div>
                                        </div>
                                        <div class="flex flex-wrap gap-2">
                                            <button onclick="previewSingleGroup('{{$plan.Group.FileHash}}')" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded font-medium transition-colors flex items-center space-x-1" title="Preview hardlinks for this group only">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                                </svg>
                                                <span>Preview</span>
                                            </button>
                                            <button onclick="linkSingleGroup('{{$plan.Group.FileHash}}')" class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white text-sm rounded font-medium transition-colors flex items-center space-x-1" title="Create hardlinks for this group">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                                                </svg>
                                                <span>Link Group</span>
                                            </button>
                                            <button onclick="refreshGroupInodes('{{$plan.Group.FileHash}}')" class="px-3 py-1.5 bg-gray-600 hover:bg-gray-500 text-white text-sm rounded font-medium transition-colors flex items-center space-x-1" title="Refresh inodes from filesystem">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                                </svg>
                                                <span>Refresh</span>
                                            </button>
                                            {{$maxLevel := maxProgressiveLevel $plan.Group.TotalSize}}
                                            {{if lt $plan.Group.HashLevel $maxLevel}}
                                            <button onclick="upgradeGroupProgressive('{{$plan.Group.FileHash}}')" class="px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white text-sm rounded font-medium transition-colors flex items-center space-x-1" title="Upgrade to next progressive hash level">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12"></path>
                                                </svg>
                                                <span>Upgrade Progressive</span>
                                            </button>
                                            {{end}}
                                            {{if lt $plan.Group.HashLevel 6}}
                                            <button onclick="upgradeGroupToFull('{{$plan.Group.FileHash}}')" class="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white text-sm rounded font-medium transition-colors flex items-center space-x-1" title="Upgrade to full hash">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                                </svg>
                                                <span>Upgrade to Full</span>
                                            </button>
                                            {{end}}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- File Entries Grouped by Hardlink Cluster -->
                            <div class="px-6 py-4 space-y-4">
                                <!-- Primary Cluster -->
                                {{if $plan.KeepCluster}}
                                <div class="hardlink-cluster bg-blue-900 bg-opacity-10 border border-blue-700 rounded-lg p-3">
                                    <div class="text-xs font-semibold text-blue-400 mb-2 flex items-center space-x-2">
                                        <span>PRIMARY CLUSTER (inode {{$plan.KeepCluster.Inode}})</span>
                                        {{if $plan.KeepCluster.IsLinked}}
                                        <span class="px-2 py-0.5 rounded bg-blue-600 bg-opacity-30 text-blue-300">
                                            {{$plan.KeepCluster.LinkCount}} files already linked
                                        </span>
                                        {{end}}
                                    </div>
                                    {{range $plan.KeepCluster.Files}}
                                    <div class="file-entry flex items-center justify-between p-2 rounded bg-blue-900 bg-opacity-20 mb-2">
                                        <div class="flex items-center space-x-3 flex-1 min-w-0">
                                            <div class="shrink-0 w-6 h-6 rounded-full bg-blue-600 flex items-center justify-center text-white text-sm font-bold">
                                                <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                                </svg>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="text-sm font-medium text-gray-100 truncate">{{.Path}}</div>
                                                <div class="flex items-center space-x-3 mt-1">
                                                    {{if .ServiceUsage}}
                                                    <span class="text-xs text-gray-400">
                                                        Used by: {{range $i, $svc := .ServiceUsage}}{{if $i}}, {{end}}{{$svc}}{{end}}
                                                    </span>
                                                    {{else if .IsOrphaned}}
                                                    <span class="px-2 py-0.5 text-xs rounded bg-gray-600 text-gray-300">Orphaned</span>
                                                    {{end}}
                                                    <span class="text-xs text-gray-500">Modified: {{.ModifiedTime | formatTimestamp}}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="shrink-0 ml-4 text-right">
                                            <div class="text-sm font-medium text-blue-400">PRIMARY</div>
                                            {{if eq .ID $plan.KeepFile.ID}}
                                            <div class="text-xs text-gray-400">{{$plan.ReasonToKeep}}</div>
                                            {{else}}
                                            <div class="text-xs text-gray-400">Already linked</div>
                                            {{end}}
                                        </div>
                                    </div>
                                    {{end}}
                                </div>
                                {{end}}

                                <!-- Already Linked Clusters (non-primary) -->
                                {{range $cluster := $plan.AlreadyLinked}}
                                    {{if ne $cluster.Inode $plan.KeepCluster.Inode}}
                                    <div class="hardlink-cluster bg-gray-700 bg-opacity-30 border border-gray-600 rounded-lg p-3">
                                        <div class="text-xs font-semibold text-gray-400 mb-2 flex items-center space-x-2">
                                            <span>LINKED CLUSTER (inode {{$cluster.Inode}})</span>
                                            <span class="px-2 py-0.5 rounded bg-gray-600 text-gray-300">
                                                {{$cluster.LinkCount}} files linked together
                                            </span>
                                            <span class="text-gray-500">→ Will link all to primary</span>
                                        </div>
                                        {{range $cluster.Files}}
                                        <div class="file-entry flex items-center justify-between p-2 rounded bg-gray-700 bg-opacity-40 mb-2">
                                            <div class="flex items-center space-x-3 flex-1 min-w-0">
                                                <div class="shrink-0 w-6 h-6 rounded-full bg-green-600 flex items-center justify-center text-white text-xs">
                                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                                                    </svg>
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <div class="text-sm font-medium text-gray-100 truncate">{{.Path}}</div>
                                                    <div class="flex items-center space-x-3 mt-1">
                                                        {{if .ServiceUsage}}
                                                        <span class="text-xs text-gray-400">
                                                            Used by: {{range $i, $svc := .ServiceUsage}}{{if $i}}, {{end}}{{$svc}}{{end}}
                                                        </span>
                                                        {{else if .IsOrphaned}}
                                                        <span class="px-2 py-0.5 text-xs rounded bg-gray-600 text-gray-300">Orphaned</span>
                                                        {{end}}
                                                        <span class="text-xs text-gray-500">Modified: {{.ModifiedTime | formatTimestamp}}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="shrink-0 ml-4 text-right">
                                                <div class="text-sm font-medium text-gray-400">LINK TO PRIMARY</div>
                                                <div class="text-xs text-green-400">Save {{$plan.Group.TotalSize | formatBytes}}</div>
                                            </div>
                                        </div>
                                        {{end}}
                                    </div>
                                    {{end}}
                                {{end}}

                                <!-- Unlinked Clusters -->
                                {{range $cluster := $plan.LinkClusters}}
                                    {{$isAlreadyLinked := false}}
                                    {{range $linked := $plan.AlreadyLinked}}
                                        {{if eq $linked.Inode $cluster.Inode}}
                                            {{$isAlreadyLinked = true}}
                                        {{end}}
                                    {{end}}
                                    {{if not $isAlreadyLinked}}
                                    <div class="hardlink-cluster bg-gray-700 bg-opacity-30 border border-gray-600 rounded-lg p-3">
                                        <div class="text-xs font-semibold text-gray-400 mb-2 flex items-center space-x-2">
                                            <span>UNLINKED FILES{{if gt $cluster.LinkCount 1}} (inode {{$cluster.Inode}}){{end}}</span>
                                            {{if gt $cluster.LinkCount 1}}
                                            <span class="px-2 py-0.5 rounded bg-gray-600 text-gray-300">
                                                {{$cluster.LinkCount}} files need linking
                                            </span>
                                            {{end}}
                                        </div>
                                        {{range $cluster.Files}}
                                        <div class="file-entry flex items-center justify-between p-2 rounded bg-gray-700 bg-opacity-40 mb-2">
                                            <div class="flex items-center space-x-3 flex-1 min-w-0">
                                                <div class="shrink-0 w-6 h-6 rounded-full bg-gray-600 flex items-center justify-center text-white text-xs">
                                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                                                    </svg>
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <div class="text-sm font-medium text-gray-100 truncate">{{.Path}}</div>
                                                    <div class="flex items-center space-x-3 mt-1">
                                                        {{if .ServiceUsage}}
                                                        <span class="text-xs text-gray-400">
                                                            Used by: {{range $i, $svc := .ServiceUsage}}{{if $i}}, {{end}}{{$svc}}{{end}}
                                                        </span>
                                                        {{else if .IsOrphaned}}
                                                        <span class="px-2 py-0.5 text-xs rounded bg-gray-600 text-gray-300">Orphaned</span>
                                                        {{end}}
                                                        <span class="text-xs text-gray-500">Modified: {{.ModifiedTime | formatTimestamp}}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="shrink-0 ml-4 text-right">
                                                <div class="text-sm font-medium text-gray-400">LINK TO PRIMARY</div>
                                                <div class="text-xs text-gray-400">Save {{$plan.Group.TotalSize | formatBytes}}</div>
                                            </div>
                                        </div>
                                        {{end}}
                                    </div>
                                    {{end}}
                                {{end}}
                            </div>
                        </div>
                    {{end}}
                    </div>
                    {{else}}
                        <div class="p-12 text-center">
                            <div class="text-gray-400 text-lg">No same-disk duplicates found</div>
                            <div class="text-gray-500 text-sm mt-2">
                                Files with identical hashes on the same disk will appear here
                            </div>
                        </div>
                    {{end}}
                </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Dry Run Summary Modal -->
<div id="dryRunSummaryModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4 py-8">
        <!-- Background overlay -->
        <div class="fixed inset-0 bg-black/75 transition-opacity z-0" onclick="closeDryRunSummary()"></div>

        <!-- Modal panel -->
        <div class="bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:max-w-5xl w-full relative z-10 max-h-[90vh] flex flex-col">
            <!-- Header -->
            <div class="bg-gray-750 px-6 py-4 border-b border-gray-700 shrink-0">
                <div class="flex items-center justify-between">
                    <h3 class="text-2xl font-bold text-gray-100 flex items-center space-x-3">
                        <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>Hardlink Preview Results</span>
                    </h3>
                    <button onclick="closeDryRunSummary()" class="text-gray-400 hover:text-gray-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Content - Scrollable -->
            <div class="overflow-y-auto bg-gray-800 px-6 py-4 space-y-6 flex-1">
                <!-- Summary Statistics -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-gray-750 rounded-lg p-4 border border-gray-700">
                        <div class="text-sm text-gray-400">Groups Processed</div>
                        <div id="summary-groups" class="text-2xl font-bold text-blue-400">-</div>
                    </div>
                    <div class="bg-gray-750 rounded-lg p-4 border border-gray-700">
                        <div class="text-sm text-gray-400">Files Needing Action</div>
                        <div id="summary-files-to-link" class="text-2xl font-bold text-yellow-400">-</div>
                    </div>
                    <div class="bg-gray-750 rounded-lg p-4 border border-gray-700">
                        <div class="text-sm text-gray-400">Already Linked</div>
                        <div id="summary-files-linked" class="text-2xl font-bold text-green-400">-</div>
                    </div>
                    <div class="bg-gray-750 rounded-lg p-4 border border-gray-700">
                        <div class="text-sm text-gray-400">Space to Save</div>
                        <div id="summary-space" class="text-2xl font-bold text-green-400">-</div>
                    </div>
                </div>

                <!-- Cluster Details -->
                <div class="bg-gray-750 rounded-lg p-4 border border-gray-700">
                    <h4 class="text-lg font-semibold text-gray-100 mb-3 flex items-center space-x-2">
                        <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                        </svg>
                        <span>Cluster Details</span>
                    </h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-700 bg-opacity-50 rounded-lg p-3 border border-gray-600">
                            <div class="text-xs text-gray-400 mb-1">Clusters Needing Linking</div>
                            <div id="summary-clusters-needing" class="text-2xl font-bold text-yellow-400">-</div>
                        </div>
                        <div class="bg-gray-700 bg-opacity-50 rounded-lg p-3 border border-gray-600">
                            <div class="text-xs text-gray-400 mb-1">Clusters Already Linked</div>
                            <div id="summary-clusters-linked" class="text-2xl font-bold text-green-400">-</div>
                        </div>
                    </div>
                </div>

                <!-- Hash Breakdown -->
                <div class="bg-gray-750 rounded-lg p-4 border border-gray-700">
                    <h4 class="text-lg font-semibold text-gray-100 mb-3">Hash Verification Confidence</h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="flex items-center justify-between p-3 bg-green-900 bg-opacity-20 border border-green-700 rounded">
                            <span class="text-sm text-gray-300 flex items-center space-x-2">
                                <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span>Full Hash</span>
                            </span>
                            <span id="summary-hash-full" class="text-lg font-bold text-green-400">-</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-blue-900 bg-opacity-20 border border-blue-700 rounded">
                            <span class="text-sm text-gray-300 flex items-center space-x-2">
                                <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                <span>Progressive</span>
                            </span>
                            <span id="summary-hash-progressive" class="text-lg font-bold text-blue-400">-</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-yellow-900 bg-opacity-20 border border-yellow-700 rounded">
                            <span class="text-sm text-gray-300 flex items-center space-x-2">
                                <svg class="w-4 h-4 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                                <span>Quick Hash</span>
                            </span>
                            <span id="summary-hash-quick" class="text-lg font-bold text-yellow-400">-</span>
                        </div>
                    </div>
                </div>

                <!-- Warnings -->
                <div id="summary-warnings-container" class="hidden bg-yellow-900 bg-opacity-20 border border-yellow-600 rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-yellow-400 mb-2 flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        <span>Warnings</span>
                    </h4>
                    <ul id="summary-warnings-list" class="space-y-1 text-sm text-yellow-100"></ul>
                </div>

                <!-- Top Groups -->
                <div class="bg-gray-750 rounded-lg p-4 border border-gray-700">
                    <h4 class="text-lg font-semibold text-gray-100 mb-3 flex items-center space-x-2">
                        <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                        </svg>
                        <span>Top Groups by Savings</span>
                    </h4>
                    <div id="summary-top-groups" class="space-y-2 text-sm">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Files to be Linked -->
                <div id="summary-files-container" class="hidden bg-gray-750 rounded-lg p-4 border border-gray-700">
                    <h4 class="text-lg font-semibold text-gray-100 mb-3 flex items-center space-x-2">
                        <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span>Files to be Linked</span>
                        <span id="summary-files-count" class="text-sm text-gray-400">(0 files)</span>
                    </h4>
                    <div id="summary-files-list" class="max-h-60 overflow-y-auto space-y-1 text-sm">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Footer with action buttons -->
            <div class="bg-gray-750 px-6 py-4 border-t border-gray-700 flex justify-between items-center shrink-0">
                <div class="text-sm text-gray-400">
                    This is a preview. No changes have been made yet.
                </div>
                <div class="flex space-x-3">
                    <button onclick="closeDryRunSummary()" class="px-6 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded font-medium transition-colors">
                        Cancel
                    </button>
                    <button id="confirmHardlinkBtn" onclick="confirmAndExecuteHardlinks()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium transition-colors">
                        Proceed with Hardlink Creation
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Tab switching
function switchTab(tabName) {
    // Update URL without reload
    const url = new URL(window.location);
    url.searchParams.set('tab', tabName);
    window.history.pushState({}, '', url);

    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });

    // Show selected tab
    document.getElementById(tabName + '-tab').classList.remove('hidden');

    // Update tab button styles
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('border-blue-500', 'text-blue-400');
        btn.classList.add('border-transparent', 'text-gray-400');
    });

    const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
    activeBtn.classList.remove('border-transparent', 'text-gray-400');
    activeBtn.classList.add('border-blue-500', 'text-blue-400');
}

// Initialize custom dropdown event handlers
document.addEventListener('DOMContentLoaded', function() {
    // Cross-disk dropdown handlers
    const crossDiskHashFilter = document.getElementById('cross-disk-hash-filter');
    const crossDiskSizeFilter = document.getElementById('cross-disk-size-filter');
    const crossDiskSort = document.getElementById('cross-disk-sort');

    if (crossDiskHashFilter) {
        crossDiskHashFilter.addEventListener('change', function() {
            applyFiltersAndSort('cross-disk');
        });
    }

    if (crossDiskSizeFilter) {
        crossDiskSizeFilter.addEventListener('change', function() {
            applyFiltersAndSort('cross-disk');
        });
    }

    if (crossDiskSort) {
        crossDiskSort.addEventListener('change', function() {
            applyFiltersAndSort('cross-disk');
        });
    }

    // Same-disk dropdown handlers - trigger server-side filtering
    const sameDiskHashFilter = document.getElementById('same-disk-hash-filter');
    const sameDiskSizeFilter = document.getElementById('same-disk-size-filter');
    const sameDiskSort = document.getElementById('same-disk-sort');
    const sameDiskLimitFilter = document.getElementById('same-disk-limit');
    const sameDiskApplyBtn = document.getElementById('apply-same-disk-filters');

    if (sameDiskHashFilter && sameDiskApplyBtn) {
        sameDiskHashFilter.addEventListener('change', function() {
            // Trigger form submission for server-side filtering
            sameDiskApplyBtn.click();
        });
    }

    if (sameDiskSizeFilter && sameDiskApplyBtn) {
        sameDiskSizeFilter.addEventListener('change', function() {
            // Trigger form submission for server-side filtering
            sameDiskApplyBtn.click();
        });
    }

    if (sameDiskSort && sameDiskApplyBtn) {
        sameDiskSort.addEventListener('change', function() {
            // Trigger form submission for server-side filtering
            sameDiskApplyBtn.click();
        });
    }

    if (sameDiskLimitFilter && sameDiskApplyBtn) {
        sameDiskLimitFilter.addEventListener('change', function() {
            // Trigger form submission for server-side filtering
            sameDiskApplyBtn.click();
        });
    }
});

// Apply all filters and sorting for a given type (client-side)
// Note: Only used for cross-disk tab. Same-disk tab uses server-side filtering.
function applyFiltersAndSort(type) {
    const hashFilter = document.getElementById(`${type}-hash-filter`);
    const sizeFilter = document.getElementById(`${type}-size-filter`);
    const sortSelect = document.getElementById(`${type}-sort`);

    if (!hashFilter || !sizeFilter || !sortSelect) return;

    const hashType = hashFilter.value;
    const minSize = parseInt(sizeFilter.value);
    const sortBy = sortSelect.value;

    const container = document.getElementById(`${type}-groups`);
    if (!container) return;

    const groups = Array.from(container.querySelectorAll('.duplicate-group'));

    // Filter groups
    groups.forEach(group => {
        let visible = true;

        // Filter by hash type
        if (hashType !== 'all') {
            const groupHashType = group.getAttribute('data-hash-type');
            if (groupHashType !== hashType) {
                visible = false;
            }
        }

        // Filter by minimum size
        if (minSize > 0) {
            const groupSize = parseInt(group.getAttribute('data-size') || '0');
            if (groupSize < minSize) {
                visible = false;
            }
        }

        // Show/hide group
        if (visible) {
            group.style.display = '';
        } else {
            group.style.display = 'none';
        }
    });

    // Sort visible groups
    const visibleGroups = groups.filter(group => group.style.display !== 'none');

    visibleGroups.sort((a, b) => {
        let aValue, bValue;

        switch (sortBy) {
            case 'savings':
                aValue = parseInt(a.getAttribute('data-size') || '0');
                bValue = parseInt(b.getAttribute('data-size') || '0');
                return bValue - aValue; // Descending (largest first)

            case 'size':
                aValue = parseInt(a.getAttribute('data-file-size') || '0');
                bValue = parseInt(b.getAttribute('data-file-size') || '0');
                return bValue - aValue; // Descending (largest first)

            case 'copies':
                aValue = parseInt(a.getAttribute('data-copies') || '0');
                bValue = parseInt(b.getAttribute('data-copies') || '0');
                return bValue - aValue; // Descending (most first)

            default:
                return 0;
        }
    });

    // Re-append groups in sorted order
    visibleGroups.forEach(group => {
        container.appendChild(group);
    });
}

// Legacy functions for backwards compatibility (now just call applyFiltersAndSort)
function filterDuplicates(type, hashType) {
    applyFiltersAndSort(type);
}

function filterBySize(type, minSize) {
    applyFiltersAndSort(type);
}

function sortDuplicates(type, sortBy) {
    applyFiltersAndSort(type);
}

async function previewConsolidation(type) {
    const confirmed = await confirmDialog(
        'This will show what would happen without actually deleting files.',
        'Run Dry Run Consolidation?'
    );

    if (!confirmed) {
        return;
    }

    // Show loading toast
    showToast('Analyzing duplicates...', 'info', {duration: 5000}); // 5 seconds

    // Run dry-run consolidation
    fetch('/api/duplicates/consolidate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({dry_run: true})
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(async data => {
        // Dismiss loading toast
        showToast('Analysis complete!', 'success', {duration: 2000});

        if (data.status === 'success') {
            let message = `DRY RUN COMPLETE\n\n`;
            message += `Groups processed: ${data.groups_processed}\n`;
            message += `Files to delete: ${data.files_deleted}\n`;
            message += `Space to free: ${formatBytes(data.space_freed)}\n`;

            if (data.errors && data.errors.length > 0) {
                message += `\nErrors: ${data.errors.length}`;
            }

            message += '\n\nProceed with actual consolidation?';

            const proceed = await confirmDialog(message, 'Dry Run Results');
            if (proceed) {
                executeConsolidation();
            }
        } else {
            showToast('Preview failed: ' + (data.message || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        showToast('Error: ' + error.message, 'error');
    });
}

async function executeConsolidation() {
    const confirmed = await confirmDialog(
        'WARNING: This will DELETE files!\n\nAre you absolutely sure you want to proceed?',
        'Confirm File Deletion'
    );

    if (!confirmed) {
        return;
    }

    // Show loading toast with long duration for potentially long operation
    showToast('Deleting duplicate files...', 'info', {duration: 60000}); // 60 seconds

    fetch('/api/duplicates/consolidate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({dry_run: false})
    })
    .then(response => response.json())
    .then(async data => {
        if (data.status === 'success') {
            // Dismiss loading, show success
            showToast('Files consolidated successfully!', 'success', {duration: 3000});

            let message = `CONSOLIDATION COMPLETE\n\n`;
            message += `Groups processed: ${data.groups_processed}\n`;
            message += `Files deleted: ${data.files_deleted}\n`;
            message += `Space freed: ${formatBytes(data.space_freed)}\n`;

            if (data.errors && data.errors.length > 0) {
                message += `\nErrors encountered: ${data.errors.length}`;
            }

            await alertDialog(message, 'Consolidation Complete', 'success');
            location.reload(); // Refresh to show updated data
        } else {
            showToast('Consolidation failed: ' + (data.message || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        showToast('Error: ' + error.message, 'error');
    });
}

// Dry run summary modal management
let currentDryRunData = null;
let currentPreviewGroupHashes = null; // Track which groups were previewed

function showDryRunSummary(data, groupHashes = null) {
    currentDryRunData = data;
    currentPreviewGroupHashes = groupHashes; // Store the group hashes used in preview

    // Populate summary statistics
    document.getElementById('summary-groups').textContent = data.groups_processed || 0;
    document.getElementById('summary-files-to-link').textContent = data.files_to_link || 0;
    document.getElementById('summary-files-linked').textContent = data.files_already_linked || 0;
    document.getElementById('summary-space').textContent = formatBytes(data.space_saved || 0);

    // Populate cluster details
    document.getElementById('summary-clusters-needing').textContent = data.clusters_needing_link || 0;
    document.getElementById('summary-clusters-linked').textContent = data.clusters_already_linked || 0;

    // Populate hash breakdown
    const hashBreakdown = data.hash_breakdown || {};
    document.getElementById('summary-hash-full').textContent = hashBreakdown.full_hash || 0;
    document.getElementById('summary-hash-progressive').textContent = hashBreakdown.progressive_hash || 0;
    document.getElementById('summary-hash-quick').textContent = hashBreakdown.quick_hash || 0;

    // Show warnings if any
    const warningsContainer = document.getElementById('summary-warnings-container');
    const warningsList = document.getElementById('summary-warnings-list');
    if (data.warnings && data.warnings.length > 0) {
        warningsContainer.classList.remove('hidden');
        warningsList.innerHTML = '';
        data.warnings.forEach(warning => {
            const li = document.createElement('li');
            li.textContent = warning;
            li.className = 'flex items-start space-x-2';
            warningsList.appendChild(li);
        });
    } else {
        warningsContainer.classList.add('hidden');
    }

    // Populate top groups
    const topGroupsContainer = document.getElementById('summary-top-groups');
    topGroupsContainer.innerHTML = '';

    if (data.top_groups && data.top_groups.length > 0) {
        data.top_groups.forEach((group, index) => {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'flex items-center justify-between p-3 bg-gray-800 border border-gray-700 rounded hover:border-gray-600 transition-colors';
            groupDiv.innerHTML = `
                <div class="flex items-center space-x-3 flex-1">
                    <div class="text-lg font-bold text-gray-400">#${index + 1}</div>
                    <div class="flex-1">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-medium text-gray-100">${formatBytes(group.file_size)} × ${group.total_files} files</span>
                            <span class="px-2 py-0.5 text-xs rounded ${
                                group.hash_level === 6 ? 'bg-green-600 text-green-100' :
                                group.hash_level === 1 ? 'bg-yellow-600 text-yellow-100' :
                                'bg-blue-600 text-blue-100'
                            }">${group.hash_level_name}</span>
                        </div>
                        <div class="text-xs text-gray-400 font-mono truncate mt-1">Hash: ${group.hash.substring(0, 16)}...</div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-sm font-semibold text-green-400">${formatBytes(group.savings)}</div>
                    <div class="text-xs text-gray-500">savings</div>
                </div>
            `;
            topGroupsContainer.appendChild(groupDiv);
        });
    } else {
        topGroupsContainer.innerHTML = '<div class="text-center text-gray-400 py-4">No groups to display</div>';
    }

    // Populate files list
    const filesContainer = document.getElementById('summary-files-container');
    const filesList = document.getElementById('summary-files-list');
    const filesCount = document.getElementById('summary-files-count');

    if (data.files_list && data.files_list.length > 0) {
        filesContainer.classList.remove('hidden');
        filesCount.textContent = `(${data.files_list.length} file${data.files_list.length !== 1 ? 's' : ''})`;
        filesList.innerHTML = '';

        data.files_list.forEach(file => {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'p-2 bg-gray-800 border border-gray-700 rounded hover:bg-gray-750 transition-colors';

            // Truncate path for display (show last 60 chars with ellipsis)
            let displayPath = file.path;
            if (displayPath.length > 60) {
                displayPath = '...' + displayPath.substring(displayPath.length - 57);
            }

            fileDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <span class="text-gray-300 font-mono text-xs flex-1 truncate" title="${file.path}">${displayPath}</span>
                    <span class="text-gray-500 text-xs ml-3 shrink-0">${formatBytes(file.size)}</span>
                </div>
            `;
            filesList.appendChild(fileDiv);
        });
    } else {
        // Hide files section if no files
        filesContainer.classList.add('hidden');
    }

    // Show modal
    document.getElementById('dryRunSummaryModal').classList.remove('hidden');
}

function closeDryRunSummary() {
    document.getElementById('dryRunSummaryModal').classList.add('hidden');
    currentDryRunData = null;
    currentPreviewGroupHashes = null;
}

function confirmAndExecuteHardlinks() {
    // Store group hashes before closing (which clears them)
    const groupHashes = currentPreviewGroupHashes;
    closeDryRunSummary();

    // If we previewed specific groups, execute only those groups
    if (groupHashes && groupHashes.length > 0) {
        executeSingleGroupHardlink(groupHashes[0]);
    } else {
        // Otherwise execute all hardlinks
        executeHardlinks();
    }
}

async function previewHardlinks() {
    const confirmed = await confirmDialog(
        'This will show what would happen without actually creating hardlinks.',
        'Run Dry Run Hardlink?'
    );

    if (!confirmed) {
        return;
    }

    // Show loading toast
    showToast('Analyzing hardlinks...', 'info', {duration: 5000}); // 5 seconds

    // Get current filter values
    const searchText = document.getElementById('same-disk-search')?.value || '';
    const hashType = document.getElementById('same-disk-hash-filter')?.value || 'all';
    const minSizeStr = document.getElementById('same-disk-size-filter')?.value || '';

    // Convert min_size string to bytes (matching backend expectations)
    let minSize = 0;
    switch (minSizeStr) {
        case '1gb': minSize = 1024 * 1024 * 1024; break;
        case '10gb': minSize = 10 * 1024 * 1024 * 1024; break;
        case '100gb': minSize = 100 * 1024 * 1024 * 1024; break;
        case '1tb': minSize = 1024 * 1024 * 1024 * 1024; break;
    }

    // Build request body with filters
    const requestBody = {
        dry_run: true,
        search_text: searchText,
        hash_type: hashType === 'all' ? '' : hashType,
        min_size: minSize
    };

    // Run dry-run hardlink with filters
    fetch('/api/duplicates/hardlink', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(requestBody)
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(async data => {
        console.log('Received data:', data);
        // Dismiss loading toast
        showToast('Analysis complete!', 'success', {duration: 2000});

        if (data.status === 'success') {
            // Show detailed summary modal instead of simple confirm
            showDryRunSummary(data, null); // null = all groups
        } else {
            console.error('Preview failed, data:', data);
            showToast('Preview failed: ' + (data.message || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error in previewHardlinks:', error);
        showToast('Error: ' + error.message, 'error');
    });
}

async function executeHardlinks() {
    const confirmed = await confirmDialog(
        'This will replace duplicate files with hardlinks.\n\nProceed?',
        'Confirm Hardlink Creation'
    );

    if (!confirmed) {
        return;
    }

    // Show loading toast with long duration for potentially long operation
    showToast('Creating hardlinks...', 'info', {duration: 60000}); // 60 seconds

    // Get current filter values
    const searchText = document.getElementById('same-disk-search')?.value || '';
    const hashType = document.getElementById('same-disk-hash-filter')?.value || 'all';
    const minSizeStr = document.getElementById('same-disk-size-filter')?.value || '';

    // Convert min_size string to bytes (matching backend expectations)
    let minSize = 0;
    switch (minSizeStr) {
        case '1gb': minSize = 1024 * 1024 * 1024; break;
        case '10gb': minSize = 10 * 1024 * 1024 * 1024; break;
        case '100gb': minSize = 100 * 1024 * 1024 * 1024; break;
        case '1tb': minSize = 1024 * 1024 * 1024 * 1024; break;
    }

    // Build request body with filters
    const requestBody = {
        dry_run: false,
        search_text: searchText,
        hash_type: hashType === 'all' ? '' : hashType,
        min_size: minSize
    };

    fetch('/api/duplicates/hardlink', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(requestBody)
    })
    .then(response => response.json())
    .then(async data => {
        if (data.status === 'success') {
            // Dismiss loading, show success
            showToast('Hardlinks created successfully!', 'success', {duration: 3000});

            let message = `Hardlink operation completed successfully.\n\n`;
            message += `• Groups processed: ${data.groups_processed}\n`;
            message += `• Files hardlinked: ${data.files_linked}\n`;
            message += `• Space saved: ${formatBytes(data.space_saved)}\n`;

            if (data.errors && data.errors.length > 0) {
                message += `\nWarning: ${data.errors.length} error(s) encountered during operation.`;
            }

            await alertDialog(message, 'Hardlink Operation Complete', 'success');
            location.reload(); // Refresh to show updated data
        } else {
            showToast('Hardlink creation failed: ' + (data.message || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        showToast('Error: ' + error.message, 'error');
    });
}

// Single group preview
async function previewSingleGroup(groupHash) {
    // Show loading toast
    showToast('Analyzing group...', 'info', {duration: 5000}); // 5 seconds

    // Run dry-run hardlink for single group
    fetch('/api/duplicates/hardlink', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            dry_run: true,
            group_hashes: [groupHash]
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(async data => {
        // Dismiss loading toast
        showToast('Analysis complete!', 'success', {duration: 2000});

        if (data.status === 'success') {
            // Show detailed summary modal for single group
            showDryRunSummary(data, [groupHash]); // Pass the group hash so we execute only this group
        } else {
            showToast('Preview failed: ' + (data.message || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        showToast('Error: ' + error.message, 'error');
    });
}

// Link single group
async function linkSingleGroup(groupHash) {
    const confirmed = await confirmDialog(
        'This will create hardlinks for this group only.\n\nProceed?',
        'Confirm Hardlink Creation'
    );

    if (!confirmed) {
        return;
    }

    executeSingleGroupHardlink(groupHash);
}

// Execute hardlink for single group
function executeSingleGroupHardlink(groupHash) {
    // Show loading toast with long duration
    showToast('Creating hardlinks...', 'info', {duration: 30000}); // 30 seconds

    console.log('Executing single group hardlink for hash:', groupHash);
    const requestBody = {
        dry_run: false,
        group_hashes: [groupHash]
    };
    console.log('Request body:', JSON.stringify(requestBody));

    fetch('/api/duplicates/hardlink', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(requestBody)
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(async data => {
        console.log('Response data:', data);
        if (data.status === 'success') {
            // Dismiss loading, show success
            showToast('Hardlinks created successfully!', 'success', {duration: 3000});

            let message = `Hardlink operation completed successfully.\n\n`;
            message += `• Groups processed: ${data.groups_processed}\n`;
            message += `• Files hardlinked: ${data.files_linked}\n`;
            message += `• Space saved: ${formatBytes(data.space_saved)}\n`;

            if (data.errors && data.errors.length > 0) {
                message += `\nWarning: ${data.errors.length} error(s) encountered during operation.`;
            }

            await alertDialog(message, 'Hardlink Operation Complete', 'success');
            location.reload(); // Refresh to show updated data
        } else {
            showToast('Hardlink creation failed: ' + (data.message || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        showToast('Error: ' + error.message, 'error');
    });
}

// Refresh inodes from filesystem for a duplicate group
async function refreshGroupInodes(groupHash) {
    showToast('Refreshing inodes from filesystem...', 'info', {duration: 5000});

    try {
        const response = await fetch(`/api/duplicates/refresh-inodes?group_hash=${encodeURIComponent(groupHash)}`, {
            method: 'POST'
        });

        const result = await response.json();

        if (response.ok) {
            showToast(`Successfully refreshed ${result.updated} file(s)`, 'success');
            // Reload page to show updated state
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showToast(result.message || 'Failed to refresh inodes', 'error');
        }
    } catch (error) {
        console.error('Error refreshing inodes:', error);
        showToast('Failed to refresh inodes', 'error');
    }
}

// Upgrade group to full hash (level 6)
async function upgradeGroupToFull(groupHash) {
    const confirmed = await confirmDialog(
        'Upgrade all files in this group to full hash?\n\nThis will calculate complete file hashes for verification.',
        'Confirm Full Hash Upgrade'
    );

    if (!confirmed) {
        return;
    }

    showToast('Upgrading to full hash...', 'info', {duration: 10000});

    try {
        const response = await fetch(`/api/hash/upgrade-group-full?group_hash=${encodeURIComponent(groupHash)}`, {
            method: 'POST'
        });

        const result = await response.json();

        if (response.ok) {
            showToast(`Upgrading ${result.count} file(s) to full hash`, 'success');
            // Reload page after a delay to show updated state
            setTimeout(() => window.location.reload(), 2000);
        } else {
            showToast(result.message || 'Failed to upgrade hashes', 'error');
        }
    } catch (error) {
        console.error('Error upgrading to full hash:', error);
        showToast('Failed to upgrade hashes', 'error');
    }
}

// Upgrade group progressively through hash levels
async function upgradeGroupProgressive(groupHash) {
    const confirmed = await confirmDialog(
        'Upgrade all files in this group to the next progressive hash level?\n\nThis will incrementally improve hash accuracy.',
        'Confirm Progressive Hash Upgrade'
    );

    if (!confirmed) {
        return;
    }

    showToast('Upgrading hashes progressively...', 'info', {duration: 10000});

    try {
        const response = await fetch(`/api/hash/upgrade-group-progressive?group_hash=${encodeURIComponent(groupHash)}`, {
            method: 'POST'
        });

        const result = await response.json();

        if (response.ok) {
            showToast(`Upgrading ${result.count} file(s) progressively`, 'success');
            // Reload page after a delay to show updated state
            setTimeout(() => window.location.reload(), 2000);
        } else {
            showToast(result.message || 'Failed to upgrade hashes', 'error');
        }
    } catch (error) {
        console.error('Error upgrading progressively:', error);
        showToast('Failed to upgrade hashes', 'error');
    }
}

// Helper function to format bytes
function formatBytes(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// Server-side filtering and pagination for same-disk duplicates
const sameDiskForm = document.getElementById('same-disk-filters-form');
const sameDiskContainer = document.getElementById('same-disk-groups-container');
const applyFiltersBtn = document.getElementById('apply-same-disk-filters');
const clearFiltersBtn = document.getElementById('clear-same-disk-filters');
const searchInput = document.getElementById('same-disk-search');

// Helper function to set dropdown value
function setDropdownValue(dropdown, value, text) {
    const input = dropdown.querySelector('[data-dropdown-input]');
    const button = dropdown.querySelector('[data-dropdown-button]');
    const textSpan = button.querySelector('[data-dropdown-text]');
    const options = dropdown.querySelectorAll('[data-dropdown-option]');

    input.value = value;
    textSpan.textContent = text;

    options.forEach(opt => {
        if (opt.dataset.value === value) {
            opt.classList.add('bg-blue-600');
            opt.setAttribute('aria-selected', 'true');
        } else {
            opt.classList.remove('bg-blue-600');
            opt.setAttribute('aria-selected', 'false');
        }
    });
}

// Global function for pagination (called from dynamically loaded content)
window.loadPageSameDisk = function(page) {
    const formData = new FormData(sameDiskForm);
    const params = new URLSearchParams(formData);
    params.set('page', page);
    params.set('tab', 'same-disk');

    sameDiskContainer.innerHTML = '<div class="p-8 text-center text-gray-400"><div class="animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto"></div><p class="mt-4">Loading groups...</p></div>';

    // Scroll to top of container
    sameDiskContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });

    fetch('/duplicates?' + params.toString(), {
        headers: {
            'HX-Request': 'true'
        }
    })
    .then(response => response.text())
    .then(html => {
        sameDiskContainer.innerHTML = html;
    })
    .catch(error => {
        sameDiskContainer.innerHTML = '<div class="p-8 text-center text-red-400">Error loading groups: ' + error.message + '</div>';
    });
};

// Load groups with current filters
function loadSameDiskGroups() {
    window.loadPageSameDisk(1); // Always start at page 1 when applying filters
}

// Event listeners
if (applyFiltersBtn) {
    applyFiltersBtn.addEventListener('click', function(e) {
        e.preventDefault();
        loadSameDiskGroups();
    });
}

if (clearFiltersBtn) {
    clearFiltersBtn.addEventListener('click', function(e) {
        e.preventDefault();

        // Reset search input
        searchInput.value = '';

        // Reset dropdowns
        const hashDropdown = document.querySelector('#same-disk-hash-filter').closest('[data-custom-dropdown]');
        const sizeDropdown = document.querySelector('#same-disk-size-filter').closest('[data-custom-dropdown]');
        const sortDropdown = document.querySelector('#same-disk-sort').closest('[data-custom-dropdown]');
        const limitDropdown = document.querySelector('#same-disk-limit').closest('[data-custom-dropdown]');

        setDropdownValue(hashDropdown, 'all', 'All Hashes');
        setDropdownValue(sizeDropdown, '', 'Any Size');
        setDropdownValue(sortDropdown, 'savings', 'Largest Savings');
        setDropdownValue(limitDropdown, '25', '25');

        // Reload with cleared filters
        loadSameDiskGroups();
    });
}

// Allow Enter key to apply filters in search input
if (searchInput) {
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            loadSameDiskGroups();
        }
    });
}

// Event delegation for pagination buttons
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('pagination-btn') || e.target.closest('.pagination-btn')) {
        const btn = e.target.classList.contains('pagination-btn') ? e.target : e.target.closest('.pagination-btn');
        const page = parseInt(btn.dataset.page, 10);
        if (page && window.loadPageSameDisk) {
            window.loadPageSameDisk(page);
        }
    }
});

// ========== FILTERED PREVIEW FUNCTIONALITY ==========

// Get current filter values for a given tab
function getCurrentFilters(tab) {
    const search = document.getElementById(`${tab}-search`)?.value || '';
    const hashType = document.getElementById(`${tab}-hash-filter`)?.value || 'all';
    const minSize = parseInt(document.getElementById(`${tab}-size-filter`)?.value || '0');

    return {
        search: search.trim(),
        hash_type: hashType,
        min_size: minSize
    };
}

// Check if any filters are active
function hasActiveFilters(tab) {
    const filters = getCurrentFilters(tab);
    return filters.search !== '' ||
           (filters.hash_type !== 'all' && filters.hash_type !== '') ||
           filters.min_size > 0;
}

// Update preview button text with current group count
async function updatePreviewButton(tab) {
    const button = document.getElementById(`preview-button-${tab}`);
    if (!button) return;

    const loadingSpan = button.querySelector('.preview-button-loading');
    const textSpan = button.querySelector('.preview-button-text');

    if (!loadingSpan || !textSpan) return;

    // Show loading
    loadingSpan.classList.remove('hidden');
    textSpan.classList.add('hidden');

    try {
        // Get current filters
        const filters = getCurrentFilters(tab);
        const hasFilters = hasActiveFilters(tab);

        // Build query string
        const params = new URLSearchParams({
            type: tab,
            search: filters.search,
            hash_type: filters.hash_type
        });

        if (filters.min_size > 0) {
            // Convert bytes to filter string
            if (filters.min_size >= 1099511627776) params.append('min_size', '1tb');
            else if (filters.min_size >= 107374182400) params.append('min_size', '100gb');
            else if (filters.min_size >= 10737418240) params.append('min_size', '10gb');
            else if (filters.min_size >= 1073741824) params.append('min_size', '1gb');
        }

        // Fetch count from API
        const response = await fetch(`/api/duplicates/count?${params.toString()}`);
        const data = await response.json();

        // Update button text (preserve icon)
        const count = data.count || 0;
        const label = hasFilters ? 'Preview Filtered' : 'Preview All';

        // Find or create the text span (after the icon)
        let textNode = textSpan.querySelector('span:last-child');
        if (!textNode) {
            textNode = document.createElement('span');
            textSpan.appendChild(textNode);
        }
        textNode.textContent = `${label} (${count} groups)`;

    } catch (error) {
        console.error('Failed to update preview button:', error);
        const label = hasActiveFilters(tab) ? 'Preview Filtered' : 'Preview All';
        let textNode = textSpan.querySelector('span:last-child');
        if (textNode) textNode.textContent = label;
    } finally {
        // Show text, hide loading
        loadingSpan.classList.add('hidden');
        textSpan.classList.remove('hidden');
    }
}

// Initialize preview buttons on page load
document.addEventListener('DOMContentLoaded', async function() {
    // Update both buttons
    await Promise.all([
        updatePreviewButton('same-disk'),
        updatePreviewButton('cross-disk')
    ]);
});

// Add filter change listeners to update button
document.addEventListener('DOMContentLoaded', function() {
    // Same-disk tab listeners
    const sameDiskSearch = document.getElementById('same-disk-search');
    const sameDiskHashFilter = document.getElementById('same-disk-hash-filter');
    const sameDiskSizeFilter = document.getElementById('same-disk-size-filter');

    if (sameDiskSearch) {
        sameDiskSearch.addEventListener('input', debounce(() => updatePreviewButton('same-disk'), 500));
    }
    if (sameDiskHashFilter) {
        sameDiskHashFilter.addEventListener('change', () => updatePreviewButton('same-disk'));
    }
    if (sameDiskSizeFilter) {
        sameDiskSizeFilter.addEventListener('change', () => updatePreviewButton('same-disk'));
    }

    // Cross-disk tab listeners
    const crossDiskHashFilter = document.getElementById('cross-disk-hash-filter');
    const crossDiskSizeFilter = document.getElementById('cross-disk-size-filter');

    if (crossDiskHashFilter) {
        crossDiskHashFilter.addEventListener('change', () => updatePreviewButton('cross-disk'));
    }
    if (crossDiskSizeFilter) {
        crossDiskSizeFilter.addEventListener('change', () => updatePreviewButton('cross-disk'));
    }
});

// Debounce helper for search input
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Store filter params for modal display
let currentActiveFilters = {};

// Override previewHardlinks to include filters
const originalPreviewHardlinks = window.previewHardlinks;
window.previewHardlinks = async function() {
    const confirmed = await confirmDialog(
        'This will show what would happen without actually creating hardlinks.',
        'Run Dry Run Hardlink?'
    );

    if (!confirmed) {
        return;
    }

    // Get current filters
    const filters = getCurrentFilters('same-disk');
    currentActiveFilters = filters;

    // Show loading toast
    showToast('Analyzing hardlinks...', 'info', {duration: 5000});

    // Run dry-run hardlink with filters
    fetch('/api/duplicates/hardlink', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            dry_run: true,
            search_text: filters.search,
            hash_type: filters.hash_type,
            min_size: filters.min_size
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(async data => {
        showToast('Analysis complete!', 'success', {duration: 2000});

        if (data.status === 'success') {
            showDryRunSummary(data, null);
        } else {
            showToast('Preview failed: ' + (data.message || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error in previewHardlinks:', error);
        showToast('Error: ' + error.message, 'error');
    });
};

// Override showDryRunSummary to display active filters
const originalShowDryRunSummary = showDryRunSummary;
window.showDryRunSummary = function(data, groupHashes = null) {
    // Call original function
    originalShowDryRunSummary(data, groupHashes);

    // Only show filter indicator for "all groups" preview (groupHashes === null)
    // Skip for single-group preview where filters aren't relevant
    const modalTitle = document.querySelector('#dryRunSummaryModal h3');
    if (modalTitle) {
        // Check if filter indicator already exists
        let filterIndicator = modalTitle.nextElementSibling;
        if (filterIndicator && filterIndicator.classList.contains('filter-indicator')) {
            // Remove existing indicator
            filterIndicator.remove();
            filterIndicator = null;
        }

        // Only show filters for "all groups" preview
        if (groupHashes === null && data.active_filters && Object.keys(data.active_filters).length > 0) {
            // Build filter description
            const filters = [];
            if (data.active_filters.search) {
                filters.push(`Search: "${data.active_filters.search}"`);
            }
            if (data.active_filters.hash_type && data.active_filters.hash_type !== 'all') {
                const hashLabels = {full: 'Full Hash', progressive: 'Progressive Hash', quick: 'Quick Hash'};
                filters.push(hashLabels[data.active_filters.hash_type] || data.active_filters.hash_type);
            }
            if (data.active_filters.min_size) {
                const sizeLabel = data.active_filters.min_size >= 1099511627776 ? '1TB+' :
                                data.active_filters.min_size >= 107374182400 ? '100GB+' :
                                data.active_filters.min_size >= 10737418240 ? '10GB+' :
                                data.active_filters.min_size >= 1073741824 ? '1GB+' : formatBytes(data.active_filters.min_size) + '+';
                filters.push(sizeLabel);
            }

            if (filters.length > 0) {
                // Create improved filter indicator with better styling
                filterIndicator = document.createElement('div');
                filterIndicator.className = 'filter-indicator mt-4 px-6 py-3 bg-blue-500/10 border border-blue-500/30 rounded-lg';

                const filterBadges = filters.map(filter =>
                    `<span class="inline-flex items-center px-3 py-1.5 rounded-md text-sm font-medium bg-blue-500/20 text-blue-200 border border-blue-500/30">${filter}</span>`
                ).join('');

                filterIndicator.innerHTML = `
                    <div class="flex items-center flex-wrap gap-3">
                        <div class="flex items-center space-x-2 text-blue-300">
                            <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                            </svg>
                            <span class="font-medium">Active Filters:</span>
                        </div>
                        ${filterBadges}
                    </div>
                `;

                modalTitle.parentNode.insertBefore(filterIndicator, modalTitle.nextSibling);
            }
        }
    }
};

// Inject preview button icons and initialize button states
document.addEventListener('DOMContentLoaded', function() {
    // Show preview button text and hide loading text FIRST
    const loadingTexts = document.querySelectorAll('.preview-button-loading');
    const buttonTexts = document.querySelectorAll('.preview-button-text');

    loadingTexts.forEach(loading => loading.classList.add('hidden'));
    buttonTexts.forEach(text => text.classList.remove('hidden'));

    // Then inject icons after buttons are visible
    if (typeof Icons !== 'undefined') {
        const previewIcons = document.querySelectorAll('.preview-icon');
        previewIcons.forEach(icon => {
            icon.innerHTML = Icons.get('playCircle', 5);
        });
    }
});

</script>
{{end}}
