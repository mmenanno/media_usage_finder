{{template "layout.html" .}}

{{define "content"}}
<div class="space-y-6">
    <h2 class="text-3xl font-bold">Configuration</h2>

    <!-- Validation Errors Container -->
    <div id="validation-errors" class="hidden"></div>

    <form hx-post="/api/config/save" hx-swap="none" class="space-y-6">
        <!-- General Settings -->
        <div class="bg-gray-800 rounded-lg p-6">
            <h3 class="text-xl font-semibold mb-4">General Settings</h3>
            <div class="space-y-4">
                <div>
                    <label for="database_path" class="block text-sm font-medium text-gray-400 mb-2">Database Path</label>
                    <input
                        id="database_path"
                        type="text"
                        name="database_path"
                        value="{{.Config.DatabasePath}}"
                        class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500">
                </div>
                <div>
                    <label for="scan_workers" class="block text-sm font-medium text-gray-400 mb-2">Scan Workers</label>
                    <input
                        id="scan_workers"
                        type="number"
                        name="scan_workers"
                        value="{{.Config.ScanWorkers}}"
                        class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500">
                </div>
                <div>
                    <label for="scan_log_retention_days" class="block text-sm font-medium text-gray-400 mb-2">
                        Scan Log Retention (Days)
                        <span class="text-xs text-gray-500 font-normal ml-2">0 = keep forever, -1 = disable logging</span>
                    </label>
                    <input
                        id="scan_log_retention_days"
                        type="number"
                        name="scan_log_retention_days"
                        value="{{.Config.ScanLogRetentionDays}}"
                        class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500"
                        min="-1">
                    <p class="text-xs text-gray-500 mt-1">How long to keep scan logs in the database before automatic cleanup</p>
                </div>
            </div>
        </div>

        <!-- Scan Paths Configuration -->
        <div class="bg-gray-800 rounded-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h3 class="text-xl font-semibold">Scan Paths</h3>
                    <p class="text-sm text-gray-400 mt-1">Directories to scan for media files (one per line)</p>
                </div>
                <button
                    type="button"
                    hx-post="/api/config/test-scan-paths"
                    hx-include="[name='scan_paths']"
                    hx-target="#validation-errors"
                    hx-swap="innerHTML"
                    hx-indicator="#scan-paths-test-indicator"
                    class="flex items-center gap-2 px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm transition cursor-pointer">
                    <svg class="htmx-indicator hidden animate-spin h-4 w-4 text-white" id="scan-paths-test-indicator" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="htmx-indicator-hidden">Test Paths</span>
                </button>
            </div>
            <textarea
                name="scan_paths"
                rows="3"
                data-autoresize
                class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 font-mono text-sm resize-none"
                placeholder="/media&#10;/downloads">{{range .Config.ScanPaths}}{{.}}&#10;{{end}}</textarea>
        </div>

        <!-- Path Mappings Configuration -->
        <div class="bg-gray-800 rounded-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h3 class="text-xl font-semibold">Path Mappings</h3>
                    <p class="text-sm text-gray-400 mt-1">Configure path translations between services and local storage</p>
                </div>
                <button
                    type="button"
                    hx-post="/api/config/test-path-mappings"
                    hx-include="[name='local_path_mappings'], [name='service_path_mappings'], [name='plex_url'], [name='plex_token'], [name='sonarr_url'], [name='sonarr_api_key'], [name='radarr_url'], [name='radarr_api_key']"
                    hx-target="#validation-errors"
                    hx-swap="innerHTML"
                    hx-indicator="#path-mappings-test-indicator"
                    class="flex items-center gap-2 px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm transition cursor-pointer">
                    <svg class="htmx-indicator hidden animate-spin h-4 w-4 text-white" id="path-mappings-test-indicator" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="htmx-indicator-hidden">Test Mappings</span>
                </button>
            </div>

            <div class="space-y-6">
                <!-- Local Path Mappings -->
                <div>
                    <h4 class="text-lg font-medium mb-2">Local Path Mappings</h4>
                    <p class="text-xs text-gray-500 mb-1">Format: service_path=local_path (one per line)</p>
                    <p class="text-xs text-gray-400 mb-2">Maps paths inside media-finder's container to the actual host filesystem</p>
                    <textarea
                        name="local_path_mappings"
                        rows="3"
                        data-autoresize
                        class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 font-mono text-sm resize-none"
                        placeholder="/media=/mnt/user/data/media&#10;/downloads=/mnt/user/data/downloads/torrents">{{range .Config.LocalPathMappings}}{{.Service}}={{.Local}}&#10;{{end}}</textarea>
                </div>

                <!-- Service Path Mappings -->
                <div>
                    <h4 class="text-lg font-medium mb-2">Service-Specific Path Mappings</h4>
                    <p class="text-xs text-gray-500 mb-1">Format: service:service_path=local_path (one per line)</p>
                    <p class="text-xs text-gray-400 mb-2">Maps paths from external services to paths in media-finder's database</p>
                    <textarea
                        name="service_path_mappings"
                        rows="8"
                        data-autoresize
                        class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 font-mono text-sm resize-none"
                        placeholder="plex:/media=/mnt/user/data/media&#10;sonarr:/tv=/mnt/user/data/media/tv&#10;sonarr:/downloads=/mnt/user/data/downloads/torrents&#10;radarr:/movies=/mnt/user/data/media/movies&#10;radarr:/downloads=/mnt/user/data/downloads/torrents&#10;qbittorrent:/downloads=/mnt/user/data/downloads/torrents">{{range $service, $mappings := .Config.ServicePathMappings}}{{range $mappings}}{{$service}}:{{.Service}}={{.Local}}&#10;{{end}}{{end}}</textarea>
                </div>
            </div>
        </div>

        <!-- Plex Configuration -->
        <div class="bg-gray-800 bg-service-plex-faded rounded-lg p-6 border border-service-plex border-opacity-20">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Plex</h3>
                <button
                    type="button"
                    hx-post="/api/config/test?service=plex"
                    hx-include="[name='plex_url'], [name='plex_token']"
                    hx-indicator="#plex-test-indicator"
                    class="flex items-center gap-2 px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm transition cursor-pointer">
                    <svg class="htmx-indicator hidden animate-spin h-4 w-4 text-white" id="plex-test-indicator" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="htmx-indicator-hidden">Test Connection</span>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="plex_url" class="block text-sm font-medium text-gray-400 mb-2">URL</label>
                    <input
                        id="plex_url"
                        type="text"
                        name="plex_url"
                        value="{{.Config.Services.Plex.URL}}"
                        placeholder="http://plex:32400"
                        class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500">
                </div>
                <div>
                    <label for="plex_token" class="block text-sm font-medium text-gray-400 mb-2">Token</label>
                    <input
                        id="plex_token"
                        type="password"
                        name="plex_token"
                        value="{{.Config.Services.Plex.Token}}"
                        class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500">
                </div>
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium text-gray-400">Libraries</label>
                        <button
                            type="button"
                            id="fetch-plex-libraries-btn"
                            class="flex items-center gap-2 px-2 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs transition cursor-pointer">
                            <svg class="hidden animate-spin h-3 w-3 text-white" id="plex-libraries-spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span id="fetch-libraries-text">Fetch Libraries</span>
                        </button>
                    </div>
                    <div id="plex-libraries-container" class="hidden">
                        <div class="mb-2">
                            <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-700 px-2 py-1 rounded">
                                <input type="checkbox" id="plex-select-all" class="w-4 h-4 bg-gray-700 border-gray-600 rounded">
                                <span class="text-sm font-medium">Select All</span>
                            </label>
                        </div>
                        <div id="plex-libraries-list" class="space-y-1 max-h-48 overflow-y-auto border border-gray-700 rounded p-2 bg-gray-900">
                            <!-- Libraries will be populated here via JavaScript -->
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Select specific libraries to scan (leave empty to scan all)</p>
                </div>
            </div>
        </div>

        <!-- Sonarr Configuration -->
        <div class="bg-gray-800 bg-service-sonarr-faded rounded-lg p-6 border border-service-sonarr border-opacity-20">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Sonarr</h3>
                <button
                    type="button"
                    hx-post="/api/config/test?service=sonarr"
                    hx-include="[name='sonarr_url'], [name='sonarr_api_key']"
                    hx-indicator="#sonarr-test-indicator"
                    class="flex items-center gap-2 px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm transition cursor-pointer">
                    <svg class="htmx-indicator hidden animate-spin h-4 w-4 text-white" id="sonarr-test-indicator" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="htmx-indicator-hidden">Test Connection</span>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="sonarr_url" class="block text-sm font-medium text-gray-400 mb-2">URL</label>
                    <input
                        id="sonarr_url"
                        type="text"
                        name="sonarr_url"
                        value="{{.Config.Services.Sonarr.URL}}"
                        placeholder="http://sonarr:8989"
                        class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500">
                </div>
                <div>
                    <label for="sonarr_api_key" class="block text-sm font-medium text-gray-400 mb-2">API Key</label>
                    <input
                        id="sonarr_api_key"
                        type="password"
                        name="sonarr_api_key"
                        value="{{.Config.Services.Sonarr.APIKey}}"
                        class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500">
                </div>
            </div>
        </div>

        <!-- Radarr Configuration -->
        <div class="bg-gray-800 bg-service-radarr-faded rounded-lg p-6 border border-service-radarr border-opacity-20">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Radarr</h3>
                <button
                    type="button"
                    hx-post="/api/config/test?service=radarr"
                    hx-include="[name='radarr_url'], [name='radarr_api_key']"
                    hx-indicator="#radarr-test-indicator"
                    class="flex items-center gap-2 px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm transition cursor-pointer">
                    <svg class="htmx-indicator hidden animate-spin h-4 w-4 text-white" id="radarr-test-indicator" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="htmx-indicator-hidden">Test Connection</span>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="radarr_url" class="block text-sm font-medium text-gray-400 mb-2">URL</label>
                    <input
                        id="radarr_url"
                        type="text"
                        name="radarr_url"
                        value="{{.Config.Services.Radarr.URL}}"
                        placeholder="http://radarr:7878"
                        class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500">
                </div>
                <div>
                    <label for="radarr_api_key" class="block text-sm font-medium text-gray-400 mb-2">API Key</label>
                    <input
                        id="radarr_api_key"
                        type="password"
                        name="radarr_api_key"
                        value="{{.Config.Services.Radarr.APIKey}}"
                        class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500">
                </div>
            </div>
        </div>

        <!-- qBittorrent Configuration -->
        <div class="bg-gray-800 bg-service-qbittorrent-faded rounded-lg p-6 border border-service-qbittorrent border-opacity-20">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">qBittorrent</h3>
                <button
                    type="button"
                    hx-post="/api/config/test?service=qbittorrent"
                    hx-include="[name='qbittorrent_url'], [name='qbittorrent_username'], [name='qbittorrent_password'], [name='qbittorrent_qui_proxy_url']"
                    hx-indicator="#qbit-test-indicator"
                    class="flex items-center gap-2 px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm transition cursor-pointer">
                    <svg class="htmx-indicator hidden animate-spin h-4 w-4 text-white" id="qbit-test-indicator" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="htmx-indicator-hidden">Test Connection</span>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="qbittorrent_url" class="block text-sm font-medium text-gray-400 mb-2">URL</label>
                    <input
                        id="qbittorrent_url"
                        type="text"
                        name="qbittorrent_url"
                        value="{{.Config.Services.QBittorrent.URL}}"
                        placeholder="http://qbittorrent:8080"
                        class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="qbittorrent_username" class="block text-sm font-medium text-gray-400 mb-2">Username</label>
                        <input
                            id="qbittorrent_username"
                            type="text"
                            name="qbittorrent_username"
                            value="{{.Config.Services.QBittorrent.Username}}"
                            class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label for="qbittorrent_password" class="block text-sm font-medium text-gray-400 mb-2">Password</label>
                        <input
                            id="qbittorrent_password"
                            type="password"
                            name="qbittorrent_password"
                            value="{{.Config.Services.QBittorrent.Password}}"
                            class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500">
                    </div>
                </div>
                <div>
                    <label for="qbittorrent_qui_proxy_url" class="block text-sm font-medium text-gray-400 mb-2">Qui Proxy URL (Optional)</label>
                    <input
                        id="qbittorrent_qui_proxy_url"
                        type="text"
                        name="qbittorrent_qui_proxy_url"
                        value="{{.Config.Services.QBittorrent.QuiProxyURL}}"
                        placeholder="http://qui:7476/proxy/xxx"
                        class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500">
                </div>
            </div>
        </div>

        <!-- Stash Configuration -->
        <div class="bg-gray-800 bg-service-stash-faded rounded-lg p-6 border border-service-stash border-opacity-20">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Stash</h3>
                <button
                    type="button"
                    hx-post="/api/config/test?service=stash"
                    hx-include="[name='stash_url'], [name='stash_api_key']"
                    hx-indicator="#stash-test-indicator"
                    class="flex items-center gap-2 px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm transition cursor-pointer">
                    <svg class="htmx-indicator hidden animate-spin h-4 w-4 text-white" id="stash-test-indicator" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    <span class="htmx-indicator-hidden">Test Connection</span>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="stash_url" class="block text-sm font-medium text-gray-400 mb-2">URL</label>
                    <input
                        id="stash_url"
                        type="text"
                        name="stash_url"
                        value="{{.Config.Services.Stash.URL}}"
                        placeholder="http://stash:9999"
                        class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500">
                </div>
                <div>
                    <label for="stash_api_key" class="block text-sm font-medium text-gray-400 mb-2">API Key</label>
                    <input
                        id="stash_api_key"
                        type="password"
                        name="stash_api_key"
                        value="{{.Config.Services.Stash.APIKey}}"
                        class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500">
                </div>
            </div>
        </div>

        <!-- Disk Configuration -->
        <div class="bg-gray-800 rounded-lg p-6 border border-purple-500 border-opacity-20">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h3 class="text-xl font-semibold">Disk Configuration</h3>
                    <p class="text-sm text-gray-400 mt-1">Configure individual disk mounts for cross-disk duplicate detection</p>
                </div>
                <button
                    type="button"
                    id="test-disk-detection-btn"
                    class="flex items-center gap-2 px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm transition cursor-pointer">
                    <svg class="hidden animate-spin h-4 w-4 text-white" id="disk-detection-spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span id="test-disk-detection-text">Test Disk Detection</span>
                </button>
            </div>

            <div id="disks-container" class="space-y-2 mb-4">
                {{range $i, $disk := .Config.Disks}}
                <div class="disk-row flex gap-2 items-center bg-gray-700 p-3 rounded">
                    <input type="text" name="disk_name_{{$i}}" value="{{$disk.Name}}" placeholder="Disk Name"
                           class="flex-1 px-3 py-2 bg-gray-600 border border-gray-500 rounded focus:outline-none focus:border-blue-500">
                    <input type="text" name="disk_mount_{{$i}}" value="{{$disk.MountPath}}" placeholder="/disk1"
                           class="flex-1 px-3 py-2 bg-gray-600 border border-gray-500 rounded focus:outline-none focus:border-blue-500 font-mono text-sm">
                    <button type="button" onclick="this.parentElement.remove()"
                            class="px-3 py-2 bg-red-600 hover:bg-red-700 rounded text-sm transition">Remove</button>
                </div>
                {{end}}
            </div>

            <button type="button" id="add-disk-btn"
                    class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded text-sm transition">
                + Add Disk
            </button>

            <p class="text-xs text-gray-500 mt-3">
                <strong>Important:</strong> Disks must be mounted in docker-compose.yml (e.g., <code class="bg-gray-700 px-1 rounded">/mnt/disk1:/disk1:rw</code>)
            </p>
        </div>

        <!-- Duplicate Detection Settings -->
        <div class="bg-gray-800 rounded-lg p-6 border border-purple-500 border-opacity-20">
            <h3 class="text-xl font-semibold mb-4">Duplicate Detection Settings</h3>
            <div class="space-y-4">
                <div class="flex items-center gap-2 mb-4">
                    <input type="checkbox" id="duplicate_detection_enabled" name="duplicate_detection_enabled"
                           {{if .Config.DuplicateDetection.Enabled}}checked{{end}}
                           class="w-5 h-5 bg-gray-700 border-gray-600 rounded">
                    <label for="duplicate_detection_enabled" class="text-sm font-medium">Enable Duplicate Detection</label>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Hash Algorithm</label>
                        <div class="relative" data-custom-dropdown>
                            <input type="hidden" name="hash_algorithm" value="{{.Config.DuplicateDetection.HashAlgorithm}}" data-dropdown-input>
                            <button
                                type="button"
                                data-dropdown-button
                                aria-expanded="false"
                                class="w-full pl-4 pr-10 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 text-gray-100 text-left cursor-pointer">
                                <span data-dropdown-text>
                                    {{if eq .Config.DuplicateDetection.HashAlgorithm "blake3"}}BLAKE3 (Faster, experimental){{else}}SHA-256 (Recommended){{end}}
                                </span>
                                <svg class="w-4 h-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div data-dropdown-menu class="hidden absolute z-10 w-full mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg">
                                <div data-dropdown-option data-value="sha256" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 {{if eq .Config.DuplicateDetection.HashAlgorithm "sha256"}}bg-blue-600{{end}}">SHA-256 (Recommended)</div>
                                <div data-dropdown-option data-value="blake3" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 {{if eq .Config.DuplicateDetection.HashAlgorithm "blake3"}}bg-blue-600{{end}}">BLAKE3 (Faster, experimental)</div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Algorithm for calculating file hashes. BLAKE3 is 2-3× faster with hardware acceleration (AVX2/AVX-512)</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Hash Mode</label>
                        <div class="relative" data-custom-dropdown>
                            <input type="hidden" name="hash_mode" value="{{.Config.DuplicateDetection.HashMode}}" data-dropdown-input>
                            <button
                                type="button"
                                data-dropdown-button
                                aria-expanded="false"
                                class="w-full pl-4 pr-10 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 text-gray-100 text-left cursor-pointer">
                                <span data-dropdown-text>
                                    {{if eq .Config.DuplicateDetection.HashMode "full"}}Full File Hashing{{else if eq .Config.DuplicateDetection.HashMode "progressive"}}Progressive Hashing{{else if eq .Config.DuplicateDetection.HashMode "quick_auto"}}Quick Hash (Auto Verify){{else}}Quick Hash (Manual Verify){{end}}
                                </span>
                                <svg class="w-4 h-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div data-dropdown-menu class="hidden absolute z-10 w-full mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg">
                                <div data-dropdown-option data-value="full" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 {{if eq .Config.DuplicateDetection.HashMode "full"}}bg-blue-600{{end}}">
                                    <div class="font-medium">Full File Hashing</div>
                                    <div class="text-xs text-gray-400">Hash entire file content (slowest, most accurate)</div>
                                </div>
                                <div data-dropdown-option data-value="quick_manual" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 {{if eq .Config.DuplicateDetection.HashMode "quick_manual"}}bg-blue-600{{end}}">
                                    <div class="font-medium">Quick Hash (Manual Verify)</div>
                                    <div class="text-xs text-gray-400">Hash first+last 1MB only, manually verify duplicates (recommended)</div>
                                </div>
                                <div data-dropdown-option data-value="quick_auto" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 {{if eq .Config.DuplicateDetection.HashMode "quick_auto"}}bg-blue-600{{end}}">
                                    <div class="font-medium">Quick Hash (Auto Verify)</div>
                                    <div class="text-xs text-gray-400">Hash first+last 1MB, auto full-hash any quick duplicates</div>
                                </div>
                                <div data-dropdown-option data-value="progressive" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 {{if eq .Config.DuplicateDetection.HashMode "progressive"}}bg-blue-600{{end}}">
                                    <div class="font-medium">Progressive Hashing</div>
                                    <div class="text-xs text-gray-400">Start at 1MB, incrementally upgrade duplicates (1MB→10MB→100MB→1GB→10GB→Full)</div>
                                </div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">
                            <strong>Quick hashing</strong> reads only the first and last 1MB of each file for fast duplicate detection,
                            then optionally full-hashes files with matching quick hashes to confirm they are true duplicates.
                            <strong>Progressive hashing</strong> starts with 1MB and only upgrades files that remain duplicates at each level.
                        </p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Hash Order Strategy</label>
                        <div class="relative" data-custom-dropdown>
                            <input type="hidden" name="hash_order" value="{{.Config.DuplicateDetection.HashOrder}}" data-dropdown-input>
                            <button
                                type="button"
                                data-dropdown-button
                                aria-expanded="false"
                                class="w-full pl-4 pr-10 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 text-gray-100 text-left cursor-pointer">
                                <span data-dropdown-text>
                                    {{if eq .Config.DuplicateDetection.HashOrder "smallest_first"}}Smallest Files First{{else if eq .Config.DuplicateDetection.HashOrder "largest_first"}}Largest Files First{{else if eq .Config.DuplicateDetection.HashOrder "random"}}Random Order{{else if eq .Config.DuplicateDetection.HashOrder "by_disk"}}Group by Disk{{else if eq .Config.DuplicateDetection.HashOrder "by_duplicate_probability"}}By Duplicate Probability{{else if eq .Config.DuplicateDetection.HashOrder "by_modification_time_newest"}}Newest Files First{{else if eq .Config.DuplicateDetection.HashOrder "by_modification_time_oldest"}}Oldest Files First{{else}}Database Order{{end}}
                                </span>
                                <svg class="w-4 h-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div data-dropdown-menu class="hidden absolute z-10 w-full mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg max-h-60 overflow-y-auto">
                                <div data-dropdown-option data-value="smallest_first" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 {{if eq .Config.DuplicateDetection.HashOrder "smallest_first"}}bg-blue-600{{end}}">
                                    <div class="font-medium">Smallest Files First</div>
                                    <div class="text-xs text-gray-400">Fast initial progress (default, recommended)</div>
                                </div>
                                <div data-dropdown-option data-value="largest_first" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 {{if eq .Config.DuplicateDetection.HashOrder "largest_first"}}bg-blue-600{{end}}">
                                    <div class="font-medium">Largest Files First</div>
                                    <div class="text-xs text-gray-400">Prioritize space savings potential</div>
                                </div>
                                <div data-dropdown-option data-value="random" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 {{if eq .Config.DuplicateDetection.HashOrder "random"}}bg-blue-600{{end}}">
                                    <div class="font-medium">Random Order</div>
                                    <div class="text-xs text-gray-400">Avoid disk seek patterns</div>
                                </div>
                                <div data-dropdown-option data-value="by_disk" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 {{if eq .Config.DuplicateDetection.HashOrder "by_disk"}}bg-blue-600{{end}}">
                                    <div class="font-medium">Group by Disk</div>
                                    <div class="text-xs text-gray-400">Process one disk at a time</div>
                                </div>
                                <div data-dropdown-option data-value="by_duplicate_probability" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 {{if eq .Config.DuplicateDetection.HashOrder "by_duplicate_probability"}}bg-blue-600{{end}}">
                                    <div class="font-medium">By Duplicate Probability</div>
                                    <div class="text-xs text-gray-400">Group same-size files together</div>
                                </div>
                                <div data-dropdown-option data-value="by_modification_time_newest" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 {{if eq .Config.DuplicateDetection.HashOrder "by_modification_time_newest"}}bg-blue-600{{end}}">
                                    <div class="font-medium">Newest Files First</div>
                                    <div class="text-xs text-gray-400">Process recently modified files first</div>
                                </div>
                                <div data-dropdown-option data-value="by_modification_time_oldest" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 {{if eq .Config.DuplicateDetection.HashOrder "by_modification_time_oldest"}}bg-blue-600{{end}}">
                                    <div class="font-medium">Oldest Files First</div>
                                    <div class="text-xs text-gray-400">Process older files first</div>
                                </div>
                                <div data-dropdown-option data-value="db_order" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 {{if eq .Config.DuplicateDetection.HashOrder "db_order"}}bg-blue-600{{end}}">
                                    <div class="font-medium">Database Order</div>
                                    <div class="text-xs text-gray-400">No specific ordering</div>
                                </div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">
                            Strategy for ordering files during hash calculation. <strong>Smallest first</strong> shows fast progress, <strong>largest first</strong> prioritizes space savings.
                        </p>
                    </div>

                    <div>
                        <label for="hash_workers" class="block text-sm font-medium text-gray-400 mb-2">Hash Workers</label>
                        <input type="number" id="hash_workers" name="hash_workers" min="1" max="32"
                               value="{{.Config.DuplicateDetection.HashWorkers}}"
                               class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">
                            Parallel hash calculation workers (default: 4)
                            {{if .CPUCores}}<br>Your server has {{.CPUCores}} CPU cores. Recommended: {{.RecommendedWorkers}} workers.{{end}}
                        </p>
                    </div>

                    <div>
                        <label for="hash_buffer_size" class="block text-sm font-medium text-gray-400 mb-2">Hash Buffer Size</label>
                        <input type="text" id="hash_buffer_size" name="hash_buffer_size"
                               value="{{.Config.DuplicateDetection.HashBufferSize}}" placeholder="4MB"
                               class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Buffer size for reading files (e.g., "1MB", "4MB", "8MB"). Larger = faster for big files. Default: 4MB</p>
                    </div>

                    <div>
                        <label for="min_file_size" class="block text-sm font-medium text-gray-400 mb-2">Minimum File Size (MB)</label>
                        <input type="number" id="min_file_size" name="min_file_size" min="0" step="1"
                               value="{{div .Config.DuplicateDetection.MinFileSize 1048576}}"
                               class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Only hash files larger than this (0 = all files)</p>
                    </div>

                    <div>
                        <label for="max_hash_rate" class="block text-sm font-medium text-gray-400 mb-2">Max Hash Rate (MB/s)</label>
                        <input type="number" id="max_hash_rate" name="max_hash_rate" min="0" step="10"
                               value="{{.Config.DuplicateDetection.MaxHashRateMB}}"
                               class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Rate limit for hashing (0 = unlimited)</p>
                    </div>

                    <div>
                        <label for="db_cache_size" class="block text-sm font-medium text-gray-400 mb-2">Database Cache Size (KB)</label>
                        <input type="number" id="db_cache_size" name="db_cache_size" min="0" step="100000"
                               value="{{.Config.DBCacheSize}}" placeholder="1000000"
                               class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">SQLite cache size in KB (1000000 ≈ 1GB). Larger = faster queries. Default: 1000000</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Duplicate Consolidation Settings -->
        <div class="bg-gray-800 rounded-lg p-6 border border-purple-500 border-opacity-20">
            <h3 class="text-xl font-semibold mb-4">Duplicate Consolidation Settings</h3>
            <div class="space-y-4">
                <div class="flex items-center gap-2 mb-4">
                    <input type="checkbox" id="consolidation_enabled" name="consolidation_enabled"
                           {{if .Config.DuplicateConsolidation.Enabled}}checked{{end}}
                           class="w-5 h-5 bg-gray-700 border-gray-600 rounded">
                    <label for="consolidation_enabled" class="text-sm font-medium">Enable Consolidation Features</label>
                </div>

                <div class="space-y-3 bg-gray-700 p-4 rounded">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="dry_run" name="dry_run"
                               {{if .Config.DuplicateConsolidation.DryRun}}checked{{end}}
                               class="w-5 h-5 bg-gray-600 border-gray-500 rounded">
                        <label for="dry_run" class="text-sm">
                            <span class="font-medium">Dry-Run Mode</span>
                            <span class="text-gray-400"> - Preview changes without deleting files (recommended)</span>
                        </label>
                    </div>

                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="require_manual_approval" name="require_manual_approval"
                               {{if .Config.DuplicateConsolidation.RequireManualApproval}}checked{{end}}
                               class="w-5 h-5 bg-gray-600 border-gray-500 rounded">
                        <label for="require_manual_approval" class="text-sm">
                            <span class="font-medium">Require Manual Approval</span>
                            <span class="text-gray-400"> - Confirm each duplicate group before consolidation</span>
                        </label>
                    </div>

                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="verify_before_delete" name="verify_before_delete"
                               {{if .Config.DuplicateConsolidation.VerifyBeforeDelete}}checked{{end}}
                               class="w-5 h-5 bg-gray-600 border-gray-500 rounded">
                        <label for="verify_before_delete" class="text-sm">
                            <span class="font-medium">Verify Before Delete</span>
                            <span class="text-gray-400"> - Re-hash files to ensure integrity before deletion</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">Consolidation Strategy</label>
                    <div class="relative" data-custom-dropdown>
                        <input type="hidden" name="consolidation_strategy" value="{{.Config.DuplicateConsolidation.Strategy}}" data-dropdown-input>
                        <button
                            type="button"
                            data-dropdown-button
                            aria-expanded="false"
                            class="w-full pl-4 pr-10 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 text-gray-100 text-left cursor-pointer">
                            <span data-dropdown-text>
                                {{if eq .Config.DuplicateConsolidation.Strategy "preferred_disk"}}Preferred Disk - Keep file based on predefined disk priority order{{else}}Least Full Disk - Keep file on disk with lowest usage percentage{{end}}
                            </span>
                            <svg class="w-4 h-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div data-dropdown-menu class="hidden absolute z-10 w-full mt-1 bg-gray-700 border border-gray-600 rounded shadow-lg">
                            <div data-dropdown-option data-value="least_full_disk" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 {{if eq .Config.DuplicateConsolidation.Strategy "least_full_disk"}}bg-blue-600{{end}}">
                                Least Full Disk - Keep file on disk with lowest usage percentage
                            </div>
                            <div data-dropdown-option data-value="preferred_disk" class="px-4 py-2 text-sm hover:bg-gray-600 cursor-pointer text-gray-100 {{if eq .Config.DuplicateConsolidation.Strategy "preferred_disk"}}bg-blue-600{{end}}">
                                Preferred Disk - Keep file based on predefined disk priority order
                            </div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">
                        Strategy for choosing which copy to keep when duplicates span multiple disks
                    </p>
                </div>
            </div>
        </div>

        <!-- Save Button -->
        <div class="flex justify-end space-x-4">
            <button
                type="submit"
                hx-target="#validation-errors"
                hx-swap="innerHTML"
                class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded transition cursor-pointer">
                Save Configuration
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ===========================
    // Disk Configuration
    // ===========================
    const addDiskBtn = document.getElementById('add-disk-btn');
    const disksContainer = document.getElementById('disks-container');
    const testDiskDetectionBtn = document.getElementById('test-disk-detection-btn');
    const diskDetectionSpinner = document.getElementById('disk-detection-spinner');
    const diskDetectionText = document.getElementById('test-disk-detection-text');

    // Initialize disk counter from template
    let diskCounter = parseInt('{{len .Config.Disks}}', 10);

    // Add new disk row
    addDiskBtn.addEventListener('click', function() {
        const diskRow = document.createElement('div');
        diskRow.className = 'disk-row flex gap-2 items-center bg-gray-700 p-3 rounded';
        diskRow.innerHTML = `
            <input type="text" name="disk_name_${diskCounter}"
                   value="Disk ${diskCounter + 1}"
                   placeholder="Disk Name"
                   class="flex-1 px-3 py-2 bg-gray-600 border border-gray-500 rounded focus:outline-none focus:border-blue-500">
            <input type="text" name="disk_mount_${diskCounter}"
                   value="/disk${diskCounter + 1}"
                   placeholder="/disk${diskCounter + 1}"
                   class="flex-1 px-3 py-2 bg-gray-600 border border-gray-500 rounded focus:outline-none focus:border-blue-500 font-mono text-sm">
            <button type="button" onclick="this.parentElement.remove()"
                    class="px-3 py-2 bg-red-600 hover:bg-red-700 rounded text-sm transition">Remove</button>
        `;
        disksContainer.appendChild(diskRow);
        diskCounter++;
    });

    // Test disk detection
    testDiskDetectionBtn.addEventListener('click', async function() {
        // Show loading state
        diskDetectionSpinner.classList.remove('hidden');
        diskDetectionText.textContent = 'Testing...';
        testDiskDetectionBtn.disabled = true;

        try {
            // Gather disk configurations from form
            const formData = new FormData();
            document.querySelectorAll('.disk-row').forEach((row, index) => {
                const nameInput = row.querySelector(`input[name^="disk_name_"]`);
                const mountInput = row.querySelector(`input[name^="disk_mount_"]`);
                if (nameInput && mountInput && nameInput.value && mountInput.value) {
                    formData.append(`disk_name_${index}`, nameInput.value);
                    formData.append(`disk_mount_${index}`, mountInput.value);
                }
            });

            const response = await fetch('/api/disks/detect', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to detect disks');
            }

            const result = await response.json();

            // Show success toast
            const diskList = result.disks.map(d =>
                `${d.name}: ${d.mount_path} (${d.used_percent.toFixed(1)}% full)`
            ).join('<br>');

            showToast(
                `Successfully detected ${result.count} disk(s):<br>${diskList}`,
                'success'
            );
        } catch (error) {
            // Show error toast
            showToast('Disk detection failed: ' + error.message, 'error');
        } finally {
            // Hide loading state
            diskDetectionSpinner.classList.add('hidden');
            diskDetectionText.textContent = 'Test Disk Detection';
            testDiskDetectionBtn.disabled = false;
        }
    });

    // ===========================
    // Plex Library Configuration
    // ===========================
    const fetchBtn = document.getElementById('fetch-plex-libraries-btn');
    const spinner = document.getElementById('plex-libraries-spinner');
    const fetchText = document.getElementById('fetch-libraries-text');
    const container = document.getElementById('plex-libraries-container');
    const librariesList = document.getElementById('plex-libraries-list');
    const selectAllCheckbox = document.getElementById('plex-select-all');
    const plexURLInput = document.getElementById('plex_url');
    const plexTokenInput = document.getElementById('plex_token');
    const testConnectionBtn = container.closest('.bg-gray-800').querySelector('button[hx-post]');

    // Get currently selected libraries from config (Go template evaluated once)
    const savedLibrariesJSON = '{{range $i, $lib := .Config.Services.Plex.Libraries}}{{if $i}},{{end}}"{{$lib}}"{{end}}';
    const savedLibraries = savedLibrariesJSON ? JSON.parse('[' + savedLibrariesJSON + ']') : [];
    console.log('Saved libraries from config:', savedLibraries);

    // Store fetched libraries
    let currentLibraries = [];

    // Fetch libraries function
    async function fetchLibraries() {
        const url = plexURLInput.value.trim();
        const token = plexTokenInput.value.trim();

        if (!url) {
            showToast('Please enter a Plex URL first', 'warning');
            return;
        }

        if (!token) {
            showToast('Please enter a Plex token first', 'warning');
            return;
        }

        // Show loading state
        spinner.classList.remove('hidden');
        fetchText.textContent = 'Loading...';
        fetchBtn.disabled = true;

        try {
            const response = await fetch(`/api/plex/libraries?url=${encodeURIComponent(url)}&token=${encodeURIComponent(token)}`);

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Failed to fetch libraries');
            }

            const libraries = await response.json();
            currentLibraries = libraries;
            renderLibraries(libraries);
            container.classList.remove('hidden');
        } catch (error) {
            showToast('Failed to fetch libraries: ' + error.message, 'error');
            container.classList.add('hidden');
        } finally {
            // Hide loading state
            spinner.classList.add('hidden');
            fetchText.textContent = 'Fetch Libraries';
            fetchBtn.disabled = false;
        }
    }

    // Render libraries as checkboxes
    function renderLibraries(libraries) {
        if (!libraries || libraries.length === 0) {
            librariesList.innerHTML = '<p class="text-sm text-gray-400 p-2">No libraries found</p>';
            return;
        }

        console.log('Rendering', libraries.length, 'libraries. Saved selections:', savedLibraries);

        librariesList.innerHTML = libraries.map(lib => {
            const isChecked = savedLibraries.includes(lib.key);
            console.log(`Library ${lib.title} (${lib.key}): ${isChecked ? 'CHECKED' : 'unchecked'}`);
            return `
                <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-700 px-2 py-1 rounded">
                    <input type="checkbox"
                           name="plex_libraries"
                           value="${lib.key}"
                           class="plex-library-checkbox w-4 h-4 bg-gray-700 border-gray-600 rounded"
                           ${isChecked ? 'checked' : ''}>
                    <span class="text-sm">${lib.title}</span>
                </label>
            `;
        }).join('');

        updateSelectAllState();
    }

    // Update "Select All" checkbox state
    function updateSelectAllState() {
        const checkboxes = document.querySelectorAll('.plex-library-checkbox');
        const checkedCount = document.querySelectorAll('.plex-library-checkbox:checked').length;

        if (checkedCount === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedCount === checkboxes.length) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        }
    }

    // Handle "Select All" checkbox click
    selectAllCheckbox.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.plex-library-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = this.checked;
        });
    });

    // Handle individual checkbox changes
    librariesList.addEventListener('change', function(e) {
        if (e.target.classList.contains('plex-library-checkbox')) {
            updateSelectAllState();
        }
    });

    // Fetch libraries on button click
    fetchBtn.addEventListener('click', fetchLibraries);

    // Auto-fetch libraries when test connection succeeds
    if (testConnectionBtn) {
        testConnectionBtn.addEventListener('htmx:afterRequest', function(event) {
            if (event.detail.successful) {
                // Test was successful, auto-fetch libraries
                setTimeout(fetchLibraries, 100);
            }
        });
    }

    // Load libraries on page load if URL and token are already set
    if (plexURLInput.value.trim() && plexTokenInput.value.trim()) {
        fetchLibraries();
    }

    // ===========================
    // Custom Dropdown Handlers
    // ===========================
    // Initialize all custom dropdowns on the page
    document.querySelectorAll('[data-custom-dropdown]').forEach(dropdown => {
        const button = dropdown.querySelector('[data-dropdown-button]');
        const menu = dropdown.querySelector('[data-dropdown-menu]');
        const input = dropdown.querySelector('[data-dropdown-input]');
        const textSpan = dropdown.querySelector('[data-dropdown-text]');
        const options = dropdown.querySelectorAll('[data-dropdown-option]');

        if (!button || !menu || !input || !textSpan) return;

        // Toggle dropdown
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const isOpen = menu.classList.contains('hidden');

            // Close all other dropdowns first
            document.querySelectorAll('[data-dropdown-menu]').forEach(m => {
                if (m !== menu) {
                    m.classList.add('hidden');
                    const btn = m.parentElement.querySelector('[data-dropdown-button]');
                    if (btn) btn.setAttribute('aria-expanded', 'false');
                }
            });

            menu.classList.toggle('hidden');
            button.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        });

        // Handle option selection
        options.forEach(option => {
            option.addEventListener('click', function() {
                const value = this.getAttribute('data-value');
                const text = this.textContent.trim();

                // Update hidden input
                input.value = value;

                // Update button text
                textSpan.textContent = text;

                // Update active state on options
                options.forEach(opt => opt.classList.remove('bg-blue-600'));
                this.classList.add('bg-blue-600');

                // Close dropdown
                menu.classList.add('hidden');
                button.setAttribute('aria-expanded', 'false');
            });
        });

        // Close on click outside
        document.addEventListener('click', function(e) {
            if (!dropdown.contains(e.target)) {
                menu.classList.add('hidden');
                button.setAttribute('aria-expanded', 'false');
            }
        });
    });
});
</script>

{{end}}

