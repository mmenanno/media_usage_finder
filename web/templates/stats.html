{{template "layout.html" .}}

{{define "content"}}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<div class="space-y-8">
    <h2 class="text-3xl font-bold">Statistics</h2>

    <!-- Overview Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-gray-800 rounded-lg p-6">
            <div class="text-gray-400 text-sm font-medium">Total Files</div>
            <div class="text-3xl font-bold mt-2">{{.Stats.TotalFiles}}</div>
            <div class="text-gray-500 text-sm mt-1">{{formatSize .Stats.TotalSize}}</div>
        </div>

        <div class="bg-gray-800 rounded-lg p-6">
            <div class="text-gray-400 text-sm font-medium">Orphaned Files</div>
            <div class="text-3xl font-bold mt-2 text-yellow-400">{{.Stats.OrphanedFiles}}</div>
            <div class="text-gray-500 text-sm mt-1">{{formatSize .Stats.OrphanedSize}}</div>
            <div class="mt-2 text-xs text-gray-500">
                {{if gt .Stats.TotalFiles 0}}
                    {{printf "%.1f%%" (div (mul .Stats.OrphanedFiles 100.0) .Stats.TotalFiles)}} of total
                {{end}}
            </div>
        </div>

        <div class="bg-gray-800 rounded-lg p-6">
            <div class="text-gray-400 text-sm font-medium">Hardlink Groups</div>
            <div class="text-3xl font-bold mt-2 text-blue-400">{{.Stats.HardlinkGroups}}</div>
            <div class="text-gray-500 text-sm mt-1">Saving {{formatSize .Stats.HardlinkSavings}}</div>
        </div>

        <div class="bg-gray-800 rounded-lg p-6">
            <div class="text-gray-400 text-sm font-medium">Space Efficiency</div>
            <div class="text-3xl font-bold mt-2 text-green-400">
                {{if gt .Stats.TotalSize 0}}
                    {{printf "%.1f%%" (div (mul .Stats.HardlinkSavings 100.0) .Stats.TotalSize)}}
                {{else}}
                    0%
                {{end}}
            </div>
            <div class="text-gray-500 text-sm mt-1">Via hardlinks</div>
        </div>
    </div>

    <!-- Service Usage -->
    <div class="bg-gray-800 rounded-lg p-6">
        <h3 class="text-xl font-semibold mb-6">Service Usage</h3>

        <!-- Charts -->
        {{if gt .Stats.ActiveServiceCount 0}}
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-gray-700 rounded-lg p-4">
                <h4 class="text-sm font-medium text-gray-400 mb-4 text-center">Files by Service</h4>
                <canvas id="filesChart" class="max-h-64"></canvas>
            </div>
            <div class="bg-gray-700 rounded-lg p-4">
                <h4 class="text-sm font-medium text-gray-400 mb-4 text-center">Storage by Service</h4>
                <canvas id="storageChart" class="max-h-64"></canvas>
            </div>
        </div>
        {{else}}
        <div class="bg-gray-700 rounded-lg p-8 text-center text-gray-500 mb-6">
            <svg class="w-12 h-12 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            <p>No service data available. Run a scan to populate statistics.</p>
        </div>
        {{end}}

        <!-- Detailed Breakdown -->
        <div class="space-y-4">
            {{range $service, $stats := .Stats.ServiceBreakdown}}
            {{if gt $stats.FileCount 0}}
            <div class="bg-gray-700 {{serviceClass $service "bg-gradient"}} rounded-lg p-4 border-l-4 {{serviceClass $service "border"}}">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-lg font-medium text-white">{{formatServiceName $service}}</span>
                    <span class="text-gray-200">{{$stats.FileCount}} files</span>
                </div>
                <div class="w-full bg-gray-600 rounded-full h-2 mb-2">
                    <div class="{{serviceClass $service "bg"}} h-2 rounded-full" data-width="{{if gt $.Stats.TotalFiles 0}}{{div (mul $stats.FileCount 100.0) $.Stats.TotalFiles}}{{else}}0{{end}}"></div>
                </div>
                <div class="flex justify-between text-sm text-gray-300">
                    <span>{{formatSize $stats.TotalSize}}</span>
                    <span>{{if gt $.Stats.TotalFiles 0}}{{printf "%.1f%%" (div (mul $stats.FileCount 100.0) $.Stats.TotalFiles)}}{{else}}0%{{end}} of total files</span>
                </div>
                <div class="mt-2 text-xs text-gray-400">
                    Average: {{formatSize (toInt64 $stats.AverageSize)}} per file
                </div>
            </div>
            {{end}}
            {{end}}
        </div>
    </div>

    <!-- Disk Distribution (if disks configured) -->
    {{if .Disks}}
    <div class="bg-gray-800 rounded-lg p-6">
        <h3 class="text-xl font-semibold mb-6">Disk Distribution</h3>

        <!-- Disk Status Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
            {{range .Disks}}
            <div class="bg-gray-700 rounded-lg p-4 border-l-4 {{if ge .UsedPercent 90.0}}border-red-500{{else if ge .UsedPercent 80.0}}border-yellow-500{{else}}border-green-500{{end}}">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-lg font-medium">{{.Name}}</span>
                    <span class="text-sm {{if ge .UsedPercent 90.0}}text-red-400{{else if ge .UsedPercent 80.0}}text-yellow-400{{else}}text-green-400{{end}} font-semibold">
                        {{printf "%.1f%%" .UsedPercent}}
                    </span>
                </div>
                <div class="text-sm text-gray-400 mb-2">
                    {{formatBytes .UsedBytes}} / {{formatBytes .TotalBytes}}
                </div>
                <!-- Usage bar -->
                <div class="w-full bg-gray-600 rounded-full h-2">
                    <div class="{{if ge .UsedPercent 90.0}}bg-red-500{{else if ge .UsedPercent 80.0}}bg-yellow-500{{else}}bg-green-500{{end}} h-2 rounded-full transition-all duration-300"
                         data-width="{{.UsedPercent}}"></div>
                </div>
                <div class="text-xs text-gray-500 mt-1">{{formatBytes .FreeBytes}} free</div>
            </div>
            {{end}}
        </div>

        <!-- Disk Usage Chart -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-gray-700 rounded-lg p-4">
                <h4 class="text-sm font-medium text-gray-400 mb-4 text-center">Storage by Disk</h4>
                <canvas id="diskStorageChart" class="max-h-64"></canvas>
            </div>

            <div class="bg-gray-700 rounded-lg p-4">
                <h4 class="text-sm font-medium text-gray-400 mb-4 text-center">Disk Usage Comparison</h4>
                <canvas id="diskUsageChart" class="max-h-64"></canvas>
            </div>
        </div>

        <!-- Detailed Disk Table -->
        <div class="mt-6 overflow-x-auto">
            <h4 class="text-sm font-medium text-gray-400 mb-4">Detailed Disk Information</h4>
            <table class="w-full text-sm">
                <thead class="bg-gray-900 text-gray-400 uppercase text-xs">
                    <tr>
                        <th class="px-4 py-3 text-left">Disk</th>
                        <th class="px-4 py-3 text-right">Total</th>
                        <th class="px-4 py-3 text-right">Used</th>
                        <th class="px-4 py-3 text-right">Free</th>
                        <th class="px-4 py-3 text-right">Usage %</th>
                        <th class="px-4 py-3 text-left">Status</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-700">
                    {{range .Disks}}
                    <tr class="hover:bg-gray-750">
                        <td class="px-4 py-3 font-medium">
                            {{.Name}}
                            <div class="text-xs text-gray-500 font-mono">{{.MountPath}}</div>
                        </td>
                        <td class="px-4 py-3 text-right">{{formatBytes .TotalBytes}}</td>
                        <td class="px-4 py-3 text-right">{{formatBytes .UsedBytes}}</td>
                        <td class="px-4 py-3 text-right">{{formatBytes .FreeBytes}}</td>
                        <td class="px-4 py-3 text-right {{if ge .UsedPercent 90.0}}text-red-400{{else if ge .UsedPercent 80.0}}text-yellow-400{{else}}text-green-400{{end}} font-semibold">
                            {{printf "%.1f%%" .UsedPercent}}
                        </td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 text-xs rounded {{if ge .UsedPercent 90.0}}bg-red-900 text-red-300{{else if ge .UsedPercent 80.0}}bg-yellow-900 text-yellow-300{{else}}bg-green-900 text-green-300{{end}}">
                                {{if ge .UsedPercent 90.0}}Critical{{else if ge .UsedPercent 80.0}}Warning{{else}}Healthy{{end}}
                            </span>
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>

        <p class="text-xs text-gray-500 mt-4 italic">
            Note: Disk statistics are updated when the server starts or when configuration is refreshed.
        </p>
    </div>
    {{else}}
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <h3 class="text-xl font-semibold mb-2">Disk Distribution</h3>
        <p class="text-gray-400 text-sm mb-2">No disks configured for cross-disk duplicate detection.</p>
        <p class="text-gray-500 text-xs">
            To enable disk tracking, configure 'disks' in config.yaml and mount individual disks in docker-compose.yml
        </p>
        <a href="/config" class="inline-block mt-2 text-sm text-blue-400 hover:text-blue-300">
            Configure disks →
        </a>
    </div>
    {{end}}

    <!-- Orphaned File Analysis -->
    {{if gt .Stats.OrphanedFiles 0}}
    <div class="bg-gray-800 rounded-lg p-6">
        <h3 class="text-xl font-semibold mb-6">Orphaned File Analysis</h3>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Orphaned Files by Extension -->
            {{if .Stats.OrphanedExtensions}}
            <div class="bg-gray-700 rounded-lg p-4">
                <h4 class="text-sm font-medium text-gray-400 mb-4 text-center">Top 5 Extensions (Orphaned)</h4>
                <div style="height: 280px;">
                    <canvas id="extensionsChart"></canvas>
                </div>
                {{if gt .Stats.OrphanedExtensionsTotal 5}}
                <div class="mt-3 text-center text-xs text-gray-500">
                    + {{sub .Stats.OrphanedExtensionsTotal 5}} more extension{{if gt (sub .Stats.OrphanedExtensionsTotal 5) 1}}s{{end}}
                </div>
                {{end}}
            </div>
            {{end}}

            <!-- Orphaned Files by Age -->
            {{if gt (len .Stats.OrphanedByAge) 0}}
            <div class="bg-gray-700 rounded-lg p-4">
                <h4 class="text-sm font-medium text-gray-400 mb-4 text-center">Orphaned Files by Age</h4>
                <canvas id="ageChart" class="max-h-64"></canvas>
            </div>
            {{end}}
        </div>

        <!-- Detailed Extension Breakdown -->
        {{if gt (len .Stats.OrphanedExtensions) 0}}
        <div class="mt-6">
            <h4 class="text-sm font-medium text-gray-400 mb-4">Top 5 Extension Details</h4>
            <div class="space-y-2">
                {{range $index, $ext := .Stats.OrphanedExtensions}}
                <div class="flex justify-between items-center p-3 bg-gray-700 rounded text-sm">
                    <div class="flex items-center space-x-3">
                        <span class="text-xs text-gray-500 font-bold w-4">#{{add $index 1}}</span>
                        <span class="font-mono text-yellow-400 font-semibold">{{$ext.Extension}}</span>
                    </div>
                    <div class="flex items-center space-x-4 text-gray-400">
                        <span>{{formatNumber $ext.FileCount}} files</span>
                        <span class="font-medium text-white">{{formatSize $ext.TotalSize}}</span>
                    </div>
                </div>
                {{end}}
            </div>
            {{if gt .Stats.OrphanedExtensionsTotal 5}}
            <div class="mt-3 text-center text-xs text-gray-500 italic">
                Plus {{sub .Stats.OrphanedExtensionsTotal 5}} more extension types not shown
            </div>
            {{end}}
        </div>
        {{end}}

        <!-- Largest Orphaned File -->
        {{if ne .Stats.LargestOrphanedPath ""}}
        <div class="mt-6">
            <h4 class="text-sm font-medium text-gray-400 mb-4">Largest Orphaned File</h4>
            <div class="bg-gray-700 rounded-lg p-4">
                <div class="flex justify-between items-start">
                    <div class="flex-1 min-w-0 mr-4">
                        <div class="text-sm text-gray-400 mb-1">Path</div>
                        <div class="font-mono text-xs text-white truncate">{{.Stats.LargestOrphanedPath}}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-400 mb-1">Size</div>
                        <div class="font-semibold text-yellow-400">{{formatSize .Stats.LargestOrphanedSize}}</div>
                    </div>
                </div>
            </div>
        </div>
        {{end}}
    </div>
    {{end}}

    <!-- Multi-Service Usage -->
    {{if gt (len .Stats.MultiServiceUsage) 0}}
    <div class="bg-gray-800 rounded-lg p-6">
        <h3 class="text-xl font-semibold mb-4">Cross-Seeding Efficiency</h3>
        <p class="text-sm text-gray-400 mb-4">Files tracked by multiple services (shows cross-seeding strategy effectiveness)</p>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {{range .Stats.MultiServiceUsage}}
            <div class="bg-gray-700 rounded-lg p-4">
                <div class="text-3xl font-bold text-blue-400 mb-1">{{.ServiceCount}}</div>
                <div class="text-sm text-gray-400 mb-2">
                    {{if eq .ServiceCount 1}}service{{else}}services{{end}}
                </div>
                <div class="text-lg font-medium">{{.FileCount}} files</div>
                <div class="text-sm text-gray-500">{{formatSize .TotalSize}}</div>
            </div>
            {{end}}
        </div>
    </div>
    {{end}}

    <!-- Space Distribution -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Files by Status -->
        <div class="bg-gray-800 rounded-lg p-6">
            <h3 class="text-xl font-semibold mb-4">Files by Status</h3>
            <div class="space-y-3">
                <div class="flex justify-between items-center p-3 bg-gray-700 rounded">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                        <span>In Use</span>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold">{{sub .Stats.TotalFiles .Stats.OrphanedFiles}}</div>
                        <div class="text-sm text-gray-400">{{formatSize (sub .Stats.TotalSize .Stats.OrphanedSize)}}</div>
                    </div>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-700 rounded">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                        <span>Orphaned</span>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold">{{.Stats.OrphanedFiles}}</div>
                        <div class="text-sm text-gray-400">{{formatSize .Stats.OrphanedSize}}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Storage Efficiency -->
        <div class="bg-gray-800 rounded-lg p-6">
            <h3 class="text-xl font-semibold mb-4">Storage Efficiency</h3>
            <div class="space-y-3">
                <div class="flex justify-between items-center p-3 bg-gray-700 rounded">
                    <div>
                        <div class="font-medium">Actual Storage</div>
                        <div class="text-sm text-gray-400">Physical disk usage</div>
                    </div>
                    <div class="text-right font-semibold">
                        {{formatSize (sub .Stats.TotalSize .Stats.HardlinkSavings)}}
                    </div>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-700 rounded">
                    <div>
                        <div class="font-medium">Apparent Size</div>
                        <div class="text-sm text-gray-400">If all files were unique</div>
                    </div>
                    <div class="text-right font-semibold">
                        {{formatSize .Stats.TotalSize}}
                    </div>
                </div>
                <div class="flex justify-between items-center p-3 bg-green-700 rounded">
                    <div>
                        <div class="font-medium">Space Saved</div>
                        <div class="text-sm text-gray-300">Via hardlinks</div>
                    </div>
                    <div class="text-right font-semibold">
                        {{formatSize .Stats.HardlinkSavings}}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recommendations -->
    <div class="bg-gray-800 rounded-lg p-6">
        <h3 class="text-xl font-semibold mb-4">Recommendations</h3>
        <div class="space-y-3">
            {{if gt .Stats.OrphanedFiles 0}}
            <div class="p-4 bg-yellow-900/30 border border-yellow-700 rounded">
                <div class="flex items-start space-x-3">
                    <svg class="w-6 h-6 text-yellow-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <div class="flex-1">
                        <div class="font-medium text-yellow-400">Orphaned Files Detected</div>
                        <div class="text-sm text-gray-300 mt-1">
                            You have {{.Stats.OrphanedFiles}} orphaned files taking up {{formatSize .Stats.OrphanedSize}}.
                            Consider reviewing and removing these files to free up space.
                        </div>
                        <a href="/files?orphaned=true" class="inline-block mt-2 text-sm text-yellow-400 hover:text-yellow-300">
                            View orphaned files →
                        </a>
                    </div>
                </div>
            </div>
            {{end}}

            {{if gt .Stats.HardlinkGroups 0}}
            <div class="p-4 bg-blue-900/30 border border-blue-700 rounded">
                <div class="flex items-start space-x-3">
                    <svg class="w-6 h-6 text-blue-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    <div class="flex-1">
                        <div class="font-medium text-blue-400">Efficient Storage Usage</div>
                        <div class="text-sm text-gray-300 mt-1">
                            Great! You're saving {{formatSize .Stats.HardlinkSavings}} through {{.Stats.HardlinkGroups}} hardlink groups.
                            Continue using hardlinks for cross-seeding to maximize efficiency.
                        </div>
                    </div>
                </div>
            </div>
            {{end}}

            {{if eq .Stats.TotalFiles 0}}
            <div class="p-4 bg-gray-700 border border-gray-600 rounded">
                <div class="flex items-start space-x-3">
                    <svg class="w-6 h-6 text-gray-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div class="flex-1">
                        <div class="font-medium text-gray-400">No Data Available</div>
                        <div class="text-sm text-gray-400 mt-1">
                            Run a scan to start tracking your media files.
                        </div>
                        <a href="/" class="inline-block mt-2 text-sm text-blue-400 hover:text-blue-300">
                            Go to dashboard →
                        </a>
                    </div>
                </div>
            </div>
            {{end}}
        </div>
    </div>
</div>

<!-- Stats data for charts (JSON) -->
<script type="application/json" id="stats-data">
{
    "serviceBreakdown": [
        {{range $service, $stats := .Stats.ServiceBreakdown}}
        {{if gt $stats.FileCount 0}}
        {
            "service": "{{$service}}",
            "fileCount": {{$stats.FileCount}},
            "totalSize": {{$stats.TotalSize}}
        },
        {{end}}
        {{end}}
        null
    ],
    "orphanedExtensions": [
        {{range .Stats.OrphanedExtensions}}
        {
            "extension": "{{.Extension}}",
            "fileCount": {{.FileCount}},
            "totalSize": {{.TotalSize}}
        },
        {{end}}
        null
    ],
    "orphanedByAge": [
        {{range .Stats.OrphanedByAge}}
        {
            "ageGroup": "{{.AgeGroup}}",
            "fileCount": {{.FileCount}},
            "totalSize": {{.TotalSize}}
        },
        {{end}}
        null
    ],
    "disks": [
        {{range .Disks}}
        {
            "name": "{{.Name}}",
            "totalBytes": {{.TotalBytes}},
            "usedBytes": {{.UsedBytes}},
            "freeBytes": {{.FreeBytes}},
            "usedPercent": {{.UsedPercent}}
        },
        {{end}}
        null
    ]
}
</script>

<script>
// Chart.js configuration
Chart.defaults.color = '#9CA3AF';
Chart.defaults.borderColor = '#374151';

// Note: formatServiceName and getServiceColor are defined globally in layout.html

// Helper function to format numbers with thousand separators
function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// Helper function to format bytes with smart units
function formatBytes(bytes) {
    if (bytes === 0) return '0 B';

    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    const value = bytes / Math.pow(k, i);

    // Format with appropriate precision
    let formatted;
    if (value >= 100) {
        formatted = Math.round(value); // No decimals for large numbers
    } else if (value >= 10) {
        formatted = value.toFixed(1); // 1 decimal for medium numbers
    } else {
        formatted = value.toFixed(2); // 2 decimals for small numbers
    }

    return formatNumber(formatted) + ' ' + sizes[i];
}

// Helper function to format GB values with smart units
function formatGBValue(gbValue) {
    if (gbValue === 0) return '0 GB';

    const bytes = gbValue * 1073741824; // Convert GB to bytes
    return formatBytes(bytes);
}

// Parse stats data from JSON script tag
const statsDataElement = document.getElementById('stats-data');
const statsData = JSON.parse(statsDataElement.textContent);
const serviceBreakdown = statsData.serviceBreakdown.filter(function(item) { return item !== null; });
const hasServiceData = serviceBreakdown.length > 0;

// Files by Service Chart
const filesCtx = document.getElementById('filesChart');
if (filesCtx && hasServiceData) {
    const serviceData = serviceBreakdown;

    new Chart(filesCtx, {
        type: 'doughnut',
        data: {
            labels: serviceData.map(s => formatServiceName(s.service)),
            datasets: [{
                data: serviceData.map(s => s.fileCount),
                backgroundColor: serviceData.map(s => getServiceColor(s.service)),
                borderWidth: 2,
                borderColor: '#1F2937'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return label + ': ' + formatNumber(value) + ' files (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
}

// Storage by Service Chart
const storageCtx = document.getElementById('storageChart');
if (storageCtx && hasServiceData) {
    const storageData = serviceBreakdown.map(function(s) {
        return { service: s.service, size: s.totalSize / 1073741824.0 };
    });

    new Chart(storageCtx, {
        type: 'bar',
        data: {
            labels: storageData.map(s => formatServiceName(s.service)),
            datasets: [{
                label: 'Storage (GB)',
                data: storageData.map(s => s.size),
                backgroundColor: storageData.map(s => getServiceColor(s.service)),
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: '#374151'
                    },
                    ticks: {
                        callback: function(value) {
                            return formatGBValue(value);
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return formatGBValue(context.parsed.y);
                        }
                    }
                }
            }
        }
    });
}

// Orphaned Extensions Chart
const extensionsCtx = document.getElementById('extensionsChart');
if (extensionsCtx) {
    const orphanedExts = statsData.orphanedExtensions.filter(function(item) { return item !== null; });
    const extensionData = orphanedExts.map(function(e) {
        return { ext: e.extension, count: e.fileCount, size: e.totalSize / 1073741824.0 };
    });

    // Distinct, high-contrast color palette for easy differentiation
    const extensionColors = [
        '#F59E0B', // amber/orange - largest
        '#10B981', // emerald green
        '#3B82F6', // bright blue
        '#A855F7', // purple
        '#EC4899', // pink - smallest
    ];

    // Calculate max value for better scaling
    const maxSize = Math.max(...extensionData.map(e => e.size));

    new Chart(extensionsCtx, {
        type: 'bar',
        data: {
            labels: extensionData.map(e => e.ext),
            datasets: [{
                label: 'Storage',
                data: extensionData.map(e => e.size),
                backgroundColor: extensionColors.slice(0, extensionData.length),
                borderWidth: 0,
                barThickness: 40, // Thicker bars
                borderRadius: 6,
                // Add subtle shadow effect
                borderSkipped: false
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    left: 10,
                    right: 100, // Space for end labels
                    top: 15,
                    bottom: 15
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    max: maxSize * 1.15, // Add 15% padding for labels
                    grid: {
                        display: false, // Clean look without grid
                        drawBorder: false
                    },
                    ticks: {
                        display: false // Hide x-axis ticks for cleaner look
                    }
                },
                y: {
                    grid: {
                        display: false,
                        drawBorder: false
                    },
                    ticks: {
                        padding: 12,
                        font: {
                            size: 15,
                            weight: '600',
                            family: 'ui-monospace, monospace'
                        },
                        color: '#F9FAFB'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: true,
                    backgroundColor: '#1F2937',
                    titleColor: '#F9FAFB',
                    bodyColor: '#D1D5DB',
                    borderColor: '#4B5563',
                    borderWidth: 1,
                    padding: 14,
                    displayColors: false,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    },
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                        label: function(context) {
                            const idx = context.dataIndex;
                            const data = extensionData[idx];
                            return [
                                'Size: ' + formatGBValue(data.size),
                                'Files: ' + formatNumber(data.count)
                            ];
                        }
                    }
                }
            }
        },
        plugins: [{
            id: 'customLabels',
            afterDatasetsDraw: function(chart) {
                const ctx = chart.ctx;
                const chartArea = chart.chartArea;

                chart.data.datasets.forEach((dataset, i) => {
                    const meta = chart.getDatasetMeta(i);
                    meta.data.forEach((bar, index) => {
                        const data = extensionData[index];
                        const sizeLabel = formatGBValue(data.size);
                        const fileLabel = formatNumber(data.count) + ' files';

                        // Calculate position - inside bar if too long, outside if space available
                        const barWidth = bar.width;
                        const labelX = bar.x + barWidth + 8;

                        // Ensure we're within chart area
                        const effectiveX = Math.min(labelX, chartArea.right - 5);
                        const y = bar.y;

                        // Draw size label (bold, white)
                        ctx.save();
                        ctx.fillStyle = '#FFFFFF';
                        ctx.font = 'bold 13px system-ui, -apple-system, sans-serif';
                        ctx.textAlign = 'left';
                        ctx.textBaseline = 'middle';

                        // Add shadow for better readability
                        ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                        ctx.shadowBlur = 4;
                        ctx.shadowOffsetX = 1;
                        ctx.shadowOffsetY = 1;

                        ctx.fillText(sizeLabel, effectiveX, y - 7);
                        ctx.restore();

                        // Draw file count (smaller, lighter gray)
                        ctx.save();
                        ctx.fillStyle = '#D1D5DB';
                        ctx.font = '500 11px system-ui, -apple-system, sans-serif';
                        ctx.textAlign = 'left';
                        ctx.textBaseline = 'middle';

                        ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                        ctx.shadowBlur = 3;
                        ctx.shadowOffsetX = 1;
                        ctx.shadowOffsetY = 1;

                        ctx.fillText(fileLabel, effectiveX, y + 7);
                        ctx.restore();
                    });
                });
            }
        }]
    });
}

// Orphaned Files by Age Chart
const ageCtx = document.getElementById('ageChart');
if (ageCtx) {
    const orphanedByAge = statsData.orphanedByAge.filter(function(item) { return item !== null; });
    const ageData = orphanedByAge.map(function(a) {
        return { age: a.ageGroup, count: a.fileCount, size: a.totalSize / 1073741824.0 };
    });

    // Use different colors for different age groups
    const ageColors = {
        'Last 30 days': '#EF4444',      // red (recent - might be processing)
        '30-90 days ago': '#F59E0B',    // amber
        '90 days - 1 year ago': '#10B981', // green (older - safer to delete)
        'Over 1 year ago': '#3B82F6'    // blue (very old - safe to delete)
    };

    new Chart(ageCtx, {
        type: 'doughnut',
        data: {
            labels: ageData.map(a => a.age),
            datasets: [{
                data: ageData.map(a => a.size),
                backgroundColor: ageData.map(a => ageColors[a.age] || '#6B7280'),
                borderWidth: 2,
                borderColor: '#1F2937'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const idx = context.dataIndex;
                            const data = ageData[idx];
                            const total = ageData.reduce((sum, item) => sum + item.size, 0);
                            const percentage = ((data.size / total) * 100).toFixed(1);
                            return [
                                data.age + ':',
                                formatGBValue(data.size) + ' (' + percentage + '%)',
                                formatNumber(data.count) + ' files'
                            ];
                        }
                    }
                }
            }
        }
    });
}

// Disk Storage Chart
const diskStorageCtx = document.getElementById('diskStorageChart');
const disksData = statsData.disks.filter(function(item) { return item !== null; });
if (diskStorageCtx && disksData.length > 0) {
    const diskData = disksData.map(function(d) {
        return {
            name: d.name,
            total: d.totalBytes / 1073741824.0,
            used: d.usedBytes / 1073741824.0,
            free: d.freeBytes / 1073741824.0,
            percent: d.usedPercent
        };
    });

    // Use distinct colors for each disk
    const diskColors = [
        '#3B82F6',  // blue
        '#10B981',  // green
        '#F59E0B',  // amber
        '#EC4899',  // pink
        '#8B5CF6',  // purple
        '#14B8A6',  // teal
        '#F97316',  // orange
        '#06B6D4',  // cyan
    ];

    new Chart(diskStorageCtx, {
        type: 'doughnut',
        data: {
            labels: diskData.map(d => d.name),
            datasets: [{
                data: diskData.map(d => d.used),
                backgroundColor: diskColors.slice(0, diskData.length),
                borderWidth: 2,
                borderColor: '#1F2937'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const idx = context.dataIndex;
                            const data = diskData[idx];
                            const total = diskData.reduce((sum, d) => sum + d.used, 0);
                            const percentage = ((data.used / total) * 100).toFixed(1);
                            return [
                                data.name + ':',
                                'Used: ' + formatGBValue(data.used),
                                'Total: ' + formatGBValue(data.total),
                                percentage + '% of all disks'
                            ];
                        }
                    }
                }
            }
        }
    });
}

// Disk Usage Comparison Chart
const diskUsageCtx = document.getElementById('diskUsageChart');
if (diskUsageCtx && disksData.length > 0) {
    const diskData = disksData.map(function(d) {
        return {
            name: d.name,
            total: d.totalBytes / 1073741824.0,
            used: d.usedBytes / 1073741824.0,
            free: d.freeBytes / 1073741824.0,
            percent: d.usedPercent
        };
    });

    // Color bars based on usage percentage
    const diskBarColors = diskData.map(d => {
        if (d.percent >= 90) return '#EF4444'; // red
        if (d.percent >= 80) return '#F59E0B'; // amber
        return '#10B981'; // green
    });

    new Chart(diskUsageCtx, {
        type: 'bar',
        data: {
            labels: diskData.map(d => d.name),
            datasets: [
                {
                    label: 'Used',
                    data: diskData.map(d => d.used),
                    backgroundColor: diskBarColors,
                    borderWidth: 0
                },
                {
                    label: 'Free',
                    data: diskData.map(d => d.free),
                    backgroundColor: '#4B5563',
                    borderWidth: 0
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                x: {
                    stacked: true,
                    grid: {
                        display: false
                    }
                },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    grid: {
                        color: '#374151'
                    },
                    ticks: {
                        callback: function(value) {
                            return formatGBValue(value);
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 10,
                        font: {
                            size: 11
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const idx = context.dataIndex;
                            const data = diskData[idx];
                            if (context.datasetIndex === 0) {
                                return 'Used: ' + formatGBValue(data.used) + ' (' + data.percent.toFixed(1) + '%)';
                            } else {
                                return 'Free: ' + formatGBValue(data.free);
                            }
                        },
                        afterLabel: function(context) {
                            if (context.datasetIndex === 0) {
                                const idx = context.dataIndex;
                                const data = diskData[idx];
                                return 'Total: ' + formatGBValue(data.total);
                            }
                        }
                    }
                }
            }
        }
    });
}

// Set widths for progress bars from data attributes
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[data-width]').forEach(function(el) {
        el.style.width = el.getAttribute('data-width') + '%';
    });
});
{{end}}
</script>
{{end}}

