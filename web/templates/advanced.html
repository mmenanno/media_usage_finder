{{template "layout.html" .}}

{{define "content"}}
<div class="space-y-8">
    <div class="flex justify-between items-center">
        <h2 class="text-3xl font-bold">Advanced Settings</h2>
    </div>

    <!-- Warning Banner -->
    <div class="bg-yellow-900/30 border-2 border-yellow-600 rounded-lg p-4 backdrop-blur-sm">
        <div class="flex items-start space-x-3">
            <svg class="w-6 h-6 text-yellow-400 shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
            <div>
                <h3 class="text-yellow-300 font-semibold">Caution: Advanced Operations</h3>
                <p class="text-yellow-200 text-sm mt-1">These functions perform powerful operations on your database. Use with caution. Destructive operations cannot be undone.</p>
            </div>
        </div>
    </div>

    <!-- Database Statistics -->
    <div class="bg-gray-800 rounded-lg p-6">
        <h3 class="text-xl font-semibold mb-6">Database Statistics</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-gray-700 rounded-lg p-4">
                <div class="text-gray-400 text-sm">Total Files</div>
                <div class="text-2xl font-bold mt-1">{{.Stats.FileCount}}</div>
            </div>
            <div class="bg-gray-700 rounded-lg p-4">
                <div class="text-gray-400 text-sm">Orphaned Files</div>
                <div class="text-2xl font-bold mt-1 text-yellow-400">{{.Stats.OrphanedCount}}</div>
            </div>
            <div class="bg-gray-700 rounded-lg p-4">
                <div class="text-gray-400 text-sm">Usage Records</div>
                <div class="text-2xl font-bold mt-1">{{.Stats.UsageCount}}</div>
            </div>
            <div class="bg-gray-700 rounded-lg p-4">
                <div class="text-gray-400 text-sm">Scan History</div>
                <div class="text-2xl font-bold mt-1">{{.Stats.ScanCount}}</div>
            </div>
            <div class="bg-gray-700 rounded-lg p-4">
                <div class="text-gray-400 text-sm">Hardlink Groups</div>
                <div class="text-2xl font-bold mt-1 text-blue-400">{{.Stats.HardlinkGroups}}</div>
            </div>
            <div class="bg-gray-700 rounded-lg p-4">
                <div class="text-gray-400 text-sm">Audit Log Entries</div>
                <div class="text-2xl font-bold mt-1">{{.Stats.AuditLogCount}}</div>
            </div>
            <div class="bg-gray-700 rounded-lg p-4">
                <div class="text-gray-400 text-sm">Database Size</div>
                <div class="text-2xl font-bold mt-1">{{formatSize (mulInt .Stats.DatabaseSizeKB 1024)}}</div>
            </div>
            <div class="bg-gray-700 rounded-lg p-4">
                <div class="text-gray-400 text-sm">Space Saved</div>
                <div class="text-2xl font-bold mt-1 text-green-400">{{formatSize .Stats.HardlinkSavings}}</div>
            </div>
        </div>
    </div>

    <!-- Data Management (Destructive) -->
    <div class="bg-gray-800 rounded-lg p-6">
        <h3 class="text-xl font-semibold mb-6 text-red-400">Data Management (Destructive)</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Clear Orphaned Files -->
            <div class="bg-gray-700 rounded-lg p-4">
                <h4 class="font-medium mb-2">Clear Orphaned Files</h4>
                <p class="text-sm text-gray-400 mb-4">Remove all files marked as orphaned ({{.Stats.OrphanedCount}} files)</p>
                <button
                    hx-post="/api/admin/clear-files?orphaned=true"
                    hx-confirm="Clear {{.Stats.OrphanedCount}} orphaned files? This cannot be undone."
                    hx-swap="none"
                    class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg font-medium transition-colors w-full flex items-center justify-center gap-2">
                    <span class="clear-orphaned-icon"></span>
                    <span>Clear Orphaned Files</span>
                </button>
            </div>

            <!-- Clear All Files -->
            <div class="bg-gray-700 rounded-lg p-4">
                <h4 class="font-medium mb-2 text-red-400">Clear All Files</h4>
                <p class="text-sm text-gray-400 mb-4">Remove ALL file records from database ({{.Stats.FileCount}} files)</p>
                <button
                    hx-post="/api/admin/clear-files"
                    hx-confirm="Clear ALL {{.Stats.FileCount}} files? This will delete all file and usage data. This cannot be undone!"
                    hx-swap="none"
                    class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors w-full flex items-center justify-center gap-2">
                    <span class="clear-all-files-icon"></span>
                    <span>Clear All Files</span>
                </button>
            </div>

            <!-- Clear Scan History -->
            <div class="bg-gray-700 rounded-lg p-4">
                <h4 class="font-medium mb-2">Clear Scan History</h4>
                <p class="text-sm text-gray-400 mb-4">Remove completed scan records ({{.Stats.ScanCount}} scans)</p>
                <button
                    hx-post="/api/admin/clear-scans"
                    hx-confirm="Clear scan history? This will delete {{.Stats.ScanCount}} scan records."
                    hx-swap="none"
                    class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg font-medium transition-colors w-full flex items-center justify-center gap-2">
                    <span class="clear-scans-icon"></span>
                    <span>Clear Scan History</span>
                </button>
            </div>

            <!-- Clear All Usage -->
            <div class="bg-gray-700 rounded-lg p-4">
                <h4 class="font-medium mb-2">Clear Service Usage</h4>
                <p class="text-sm text-gray-400 mb-4">Remove all usage tracking data ({{.Stats.UsageCount}} records)</p>
                <button
                    hx-post="/api/admin/clear-usage"
                    hx-confirm="Clear all usage records? Files will be marked orphaned until next scan."
                    hx-swap="none"
                    class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg font-medium transition-colors w-full flex items-center justify-center gap-2">
                    <span class="clear-usage-icon"></span>
                    <span>Clear All Usage</span>
                </button>
            </div>

            <!-- Clear Configuration -->
            <div class="bg-gray-700 rounded-lg p-4">
                <h4 class="font-medium mb-2 text-red-400">Reset Configuration</h4>
                <p class="text-sm text-gray-400 mb-4">Remove all configuration settings</p>
                <button
                    hx-post="/api/admin/clear-config"
                    hx-confirm="Reset ALL configuration? You will need to reconfigure all services."
                    hx-swap="none"
                    class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors w-full flex items-center justify-center gap-2">
                    <span class="reset-config-icon"></span>
                    <span>Reset Configuration</span>
                </button>
            </div>

            <!-- Clear Old Audit Logs -->
            <div class="bg-gray-700 rounded-lg p-4">
                <h4 class="font-medium mb-2">Clear Old Audit Logs</h4>
                <p class="text-sm text-gray-400 mb-4">Remove audit entries older than 90 days</p>
                <button
                    hx-post="/api/admin/clear-audit-log?days=90"
                    hx-confirm="Clear audit log entries older than 90 days?"
                    hx-swap="none"
                    class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg font-medium transition-colors w-full flex items-center justify-center gap-2">
                    <span class="clear-logs-icon"></span>
                    <span>Clear Old Logs</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Database Maintenance (Safe) -->
    <div class="bg-gray-800 rounded-lg p-6">
        <h3 class="text-xl font-semibold mb-6 text-blue-400">Database Maintenance</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Optimize Database -->
            <div class="bg-gray-700 rounded-lg p-4">
                <h4 class="font-medium mb-2">Optimize Database</h4>
                <p class="text-sm text-gray-400 mb-4">Run VACUUM and ANALYZE to reclaim space and update statistics</p>
                <button
                    hx-post="/api/admin/vacuum"
                    hx-swap="none"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors w-full flex items-center justify-center gap-2">
                    <span class="optimize-db-icon"></span>
                    <span>Optimize Database</span>
                </button>
            </div>

            <!-- Rebuild Search Index -->
            <div class="bg-gray-700 rounded-lg p-4">
                <h4 class="font-medium mb-2">Rebuild Search Index</h4>
                <p class="text-sm text-gray-400 mb-4">Recreate the full-text search index for file paths</p>
                <button
                    hx-post="/api/admin/rebuild-fts"
                    hx-swap="none"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors w-full flex items-center justify-center gap-2">
                    <span class="rebuild-index-icon"></span>
                    <span>Rebuild Search Index</span>
                </button>
            </div>

            <!-- Recalculate Orphaned Status -->
            <div class="bg-gray-700 rounded-lg p-4">
                <h4 class="font-medium mb-2">Recalculate Orphaned Status</h4>
                <p class="text-sm text-gray-400 mb-4">Update orphaned flags for all files based on current usage</p>
                <button
                    hx-post="/api/admin/recalculate-orphaned"
                    hx-swap="none"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors w-full flex items-center justify-center gap-2">
                    <span class="recalculate-icon"></span>
                    <span>Recalculate Orphaned</span>
                </button>
            </div>

            <!-- Clean Stale Scans -->
            <div class="bg-gray-700 rounded-lg p-4">
                <h4 class="font-medium mb-2">Clean Stale Scans</h4>
                <p class="text-sm text-gray-400 mb-4">Mark old running scans as interrupted (>1 hour old)</p>
                <button
                    hx-post="/api/admin/clean-stale-scans"
                    hx-swap="none"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors w-full flex items-center justify-center gap-2">
                    <span class="clean-scans-icon"></span>
                    <span>Clean Stale Scans</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Export/Backup -->
    <div class="bg-gray-800 rounded-lg p-6">
        <h3 class="text-xl font-semibold mb-6 text-green-400">Export & Backup</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-gray-700 rounded-lg p-4">
                <h4 class="font-medium mb-2">Export All Data</h4>
                <p class="text-sm text-gray-400 mb-4">Download complete database as JSON</p>
                <a href="/api/export?format=json" download="media-usage-finder-export.json"
                   class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors w-full text-center no-underline hover:no-underline flex items-center justify-center gap-2">
                    <span class="export-json-icon"></span>
                    <span>Export to JSON</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Service Missing Files -->
    <div class="bg-gray-800 rounded-lg p-6">
        <h3 class="text-xl font-semibold mb-6 text-purple-400">Service Missing Files</h3>
        <p class="text-sm text-gray-400 mb-4">Files that services report but don't exist in the scanned filesystem. These may be due to path mapping issues, files deleted from disk, or files not in scan paths.</p>

        <div id="missing-files-container" hx-get="/api/missing-files" hx-trigger="load" hx-swap="innerHTML">
            <div class="flex items-center justify-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500"></div>
            </div>
        </div>
    </div>
</div>

<script>
// Inject icons into buttons on page load
document.addEventListener('DOMContentLoaded', function() {
    // Destructive operation icons (trash)
    const clearOrphanedIcon = document.querySelector('.clear-orphaned-icon');
    const clearAllFilesIcon = document.querySelector('.clear-all-files-icon');
    const clearScansIcon = document.querySelector('.clear-scans-icon');
    const clearUsageIcon = document.querySelector('.clear-usage-icon');
    const clearLogsIcon = document.querySelector('.clear-logs-icon');

    if (clearOrphanedIcon) clearOrphanedIcon.innerHTML = Icons.get('trash', 5);
    if (clearAllFilesIcon) clearAllFilesIcon.innerHTML = Icons.get('trash', 5);
    if (clearScansIcon) clearScansIcon.innerHTML = Icons.get('trash', 5);
    if (clearUsageIcon) clearUsageIcon.innerHTML = Icons.get('trash', 5);
    if (clearLogsIcon) clearLogsIcon.innerHTML = Icons.get('trash', 5);

    // Reset configuration icon (ban)
    const resetConfigIcon = document.querySelector('.reset-config-icon');
    if (resetConfigIcon) resetConfigIcon.innerHTML = Icons.get('ban', 5);

    // Maintenance icons (cog/refresh)
    const optimizeDbIcon = document.querySelector('.optimize-db-icon');
    const rebuildIndexIcon = document.querySelector('.rebuild-index-icon');
    const recalculateIcon = document.querySelector('.recalculate-icon');
    const cleanScansIcon = document.querySelector('.clean-scans-icon');

    if (optimizeDbIcon) optimizeDbIcon.innerHTML = Icons.get('cog', 5);
    if (rebuildIndexIcon) rebuildIndexIcon.innerHTML = Icons.get('refresh', 5);
    if (recalculateIcon) recalculateIcon.innerHTML = Icons.get('refresh', 5);
    if (cleanScansIcon) cleanScansIcon.innerHTML = Icons.get('refresh', 5);

    // Export icon (download)
    const exportJsonIcon = document.querySelector('.export-json-icon');
    if (exportJsonIcon) exportJsonIcon.innerHTML = Icons.get('download', 5);
});

// Handle missing files data
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.id === 'missing-files-container') {
        const data = JSON.parse(evt.detail.xhr.responseText);

        if (data.total === 0) {
            evt.detail.target.innerHTML = `
                <div class="bg-gray-700 rounded-lg p-6 text-center">
                    <svg class="w-12 h-12 text-green-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p class="text-gray-300 font-medium">No missing files found</p>
                    <p class="text-gray-400 text-sm mt-1">All files reported by services exist in the filesystem</p>
                </div>
            `;
            return;
        }

        let html = `
            <div class="mb-4 flex justify-between items-center bg-gray-700 rounded-lg p-4">
                <div>
                    <p class="text-2xl font-bold text-purple-400">${data.total}</p>
                    <p class="text-sm text-gray-400">Total missing files from latest scan</p>
                </div>
                <a href="/api/missing-files/export" download="missing_files.csv"
                   class="inline-block px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition-colors no-underline hover:no-underline flex items-center gap-2">
                    <span class="export-csv-icon"></span>
                    <span>Export to CSV</span>
                </a>
            </div>
            <div class="space-y-4">
        `;

        data.services.forEach(service => {
            const serviceColors = {
                'plex': 'blue',
                'sonarr': 'green',
                'radarr': 'amber',
                'qbittorrent': 'red',
                'stash': 'purple'
            };
            const color = serviceColors[service.service] || 'gray';

            html += `
                <div class="bg-gray-700 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-3 cursor-pointer" onclick="this.parentElement.querySelector('.missing-files-list').classList.toggle('hidden')">
                        <div class="flex items-center gap-3">
                            <span class="px-3 py-1 bg-${color}-600 rounded-lg text-sm font-medium capitalize">${service.service}</span>
                            <span class="text-xl font-bold">${service.count} files</span>
                        </div>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                    <div class="missing-files-list hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="border-b border-gray-600">
                                    <tr class="text-left text-gray-400">
                                        <th class="pb-2">Service Path</th>
                                        <th class="pb-2">Translated Path</th>
                                        <th class="pb-2">Size</th>
                                        <th class="pb-2">Group</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-600">
            `;

            service.files.forEach(file => {
                const sizeFormatted = formatBytes(file.size);
                const groupText = file.service_group || '-';

                html += `
                    <tr class="text-gray-300">
                        <td class="py-2 pr-4 text-xs font-mono truncate max-w-xs" title="${file.service_path}">${file.service_path}</td>
                        <td class="py-2 pr-4 text-xs font-mono truncate max-w-xs" title="${file.translated_path}">${file.translated_path}</td>
                        <td class="py-2 pr-4">${sizeFormatted}</td>
                        <td class="py-2 truncate max-w-xs" title="${groupText}">${groupText}</td>
                    </tr>
                `;
            });

            html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        evt.detail.target.innerHTML = html;

        // Inject download icon into dynamically generated CSV export button
        const exportCsvIcon = document.querySelector('.export-csv-icon');
        if (exportCsvIcon) {
            exportCsvIcon.innerHTML = Icons.get('download', 5);
        }
    }
});

// Helper function to format bytes
function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
</script>

<style>
    /* Loading state for buttons */
    button[hx-post].htmx-request {
        opacity: 0.6;
        cursor: wait !important;
        pointer-events: none;
    }
</style>
{{end}}
